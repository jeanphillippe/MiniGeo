<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Isla Historias/Story Island-MiniGEO</title><script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script><script srwc="./debug.js"></script><script src="./camera.js"></script><script src="./terrain.js"></script><script src="./player.js"></script><script src="./npcs.js"></script><script src="./minigames.js"></script><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#2c3e50;overflow:hidden}#gameCanvas{display:block;width:100vw;height:100vh;touch-action:none;cursor:grab}#gameCanvas:active{cursor:grabbing}.ui-container{position:absolute;top:10px;left:10px;z-index:100}.toggle-btn{background:rgb(0 0 0/.8);color:#fff;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;font-size:9px;margin-bottom:5px}.toggle-btn:hover{background:rgb(0 0 0/.9)}.toggle-btn.active{background:#4CAF50}.panel{color:#fff;background:rgb(0 0 0/.8);padding:12px;border-radius:6px;font-size:12px;margin-bottom:5px;min-width:200px;max-width:310px;display:none}.panel.visible{display:block}.panel button{background:#4CAF50;color:#fff;border:none;padding:6px 12px;border-radius:3px;cursor:pointer;font-size:11px;margin:2px}.panel button:hover{background:#45a049}.panel button:disabled{background:#666;cursor:not-allowed}.edit-indicator{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#ff6b6b;font-size:16px;font-weight:700;text-shadow:2px 2px 4px rgb(0 0 0/.8);z-index:99;pointer-events:none;display:none}.edit-indicator.visible{display:block}.controls-text{font-size:10px;color:#ccc;margin-top:8px;line-height:1.3}.tooltip-container{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:auto;z-index:150}.tooltip{background:rgb(0 0 0/.9);color:#fff;padding:8px 12px;border-radius:6px;font-size:14px;font-family:-apple-system,BlinkMacSystemFont,sans-serif;white-space:nowrap;box-shadow:0 2px 8px rgb(0 0 0/.4);border:1px solid rgb(255 255 255/.2);opacity:0;transform:translateY(10px);transition:all 0.3s ease;cursor:pointer}.tooltip:hover{background:rgb(76 175 80/.3);border-color:#4CAF50;transform:translateY(-2px);box-shadow:0 4px 12px rgb(0 0 0/.6)}.tooltip.visible{opacity:1;transform:translateY(0)}.tooltip.interact{border-color:#4CAF50;background:rgb(76 175 80/.2);backdrop-filter:blur(4px)}.interact-prompt{color:#fff;font-weight:700;font-size:12px;margin-top:4px}.sprite-debug-panel{position:relative!important;top:120px;right:20px;background:rgb(0 0 0/.8);color:#fff;padding:10px;border-radius:5px;display:none;min-width:250px}.pip-reference{position:relative;bottom:0;left:0;width:64px;height:64px;border:2px solid #4CAF50;border-radius:5px;background:rgb(0 0 0/.8);z-index:200}.pip-reference.visible{display:block}.pip-reference img{width:100%;height:100%;object-fit:cover;border-radius:3px}.pip-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background-image:linear-gradient(to right,rgb(255 255 255/.3)0,transparent 1px),linear-gradient(to bottom,rgb(255 255 255/.3)0,transparent 1px);background-size:15px 15px;pointer-events:none}.pip-label{position:absolute;bottom:-20px;left:0;right:0;text-align:center;font-size:10px;color:#ccc;font-weight:700}#spriteDebugPanel input[type="number"]{background:rgb(255 255 255/.1);border:1px solid rgb(255 255 255/.3);color:#fff;padding:2px 4px;border-radius:2px;margin:0 5px}#spriteDebugPanel input[type="range"]{width:100px;margin:0 5px}#spriteDebugPanel label{display:inline-block;width:60px;font-size:11px}.sprite-debug-panel.visible{display:block}.isla-button{font-family:monospace;font-size:1.2em;font-weight:bold;color:#181818;background:linear-gradient(to bottom,#ffe76b 0%,#ffc933 40%,#e68a00 100%);border:none;border-radius:12px;padding:20px 40px;box-shadow:inset 0 1px 0 rgba(255,255,255,.8),0 3px 0 #c56a00,0 5px 8px rgba(0,0,0,.25);cursor:pointer;text-transform:uppercase;transition:all.15s ease-in-out}.isla-button:hover{filter:brightness(1.15)}.isla-button:active{transform:translateY(3px);box-shadow:inset 0 1px 0 rgba(255,255,255,.8),0 2px 0 #c56a00,0 3px 6px rgba(0,0,0,.25)}.intro-overlay{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(1,255,255,0.45);backdrop-filter:blur(3px);display:flex;align-items:flex-start;justify-content:center;z-index:1000;opacity:1;transition:opacity 0.5s ease}.intro-overlay.hidden{opacity:0;pointer-events:none}.intro-content{text-align:center;color:white;max-width:500px;padding:40px}.intro-title{font-size:3.5rem;font-weight:bold;margin-bottom:24px;text-shadow:2px 2px 8px rgba(0,0,0,0.8);letter-spacing:2px}.intro-description{font-size:1.1rem;line-height:1.6;text-shadow:1px 2px 2px rgba(0,0,0,0.55),-1px 1px 10px rgba(0,0,0,0.85);margin-bottom:32px;opacity:0.9}.start-button{background:#43aa8b;color:white;border:none;padding:16px 32px;border-radius:8px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(67,170,139,0.3)}.start-button:hover{background:#4fc3f7;transform:translateY(-2px);box-shadow:0 6px 16px rgba(79,195,247,0.4)}

/* Chat Integration Styles */
.chat-container{position:fixed;bottom:0;right:10px;width:320px;height:280px;background:#fff;border:1px solid #e1e5e9;border-radius:8px 8px 0 0;box-shadow:0 -4px 12px rgba(0,0,0,0.15);z-index:200;transform:translateY(100%);transition:transform 0.3s ease;display:none}.chat-container.visible{display:block}.chat-container.active{transform:translateY(0)}.chat-minimized{height:40px!important}.chat-minimized .chat-body,.chat-minimized .chat-input{display:none}.chat-header{height:32px;background:#f8f9fa;border-bottom:1px solid #e1e5e9;display:flex;align-items:center;justify-content:space-between;padding:0 10px;cursor:pointer;border-radius:8px 8px 0 0}.chat-title{font-weight:600;color:#1a1a1a;font-size:12px;flex:1}.chat-status{width:8px;height:8px;border-radius:50%;background:#10b981;margin-right:8px}.chat-status.offline{background:#ef4444}.chat-status.connecting{background:#f59e0b}.chat-controls{display:flex;gap:4px}.chat-btn{background:none;border:none;color:#6b7280;cursor:pointer;padding:4px;border-radius:3px;font-size:11px}.chat-btn:hover{background:#f3f4f6}.chat-body{flex:1;overflow-y:auto;padding:8px;font-size:11px}.chat-msg{margin-bottom:8px;padding:6px 8px;background:#f8f9fa;border-radius:6px;border-left:2px solid #e5e7eb}.chat-msg.own{background:#eff6ff;border-left-color:#3b82f6;margin-left:20px}.chat-msg.admin{border-left-color:#8b5cf6}.chat-msg.mod{border-left-color:#f59e0b}.chat-msg-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}.chat-user{font-weight:500;color:#374151;font-size:10px}.chat-time{font-size:9px;color:#9ca3af}.chat-text{color:#1f2937;line-height:1.3;word-wrap:break-word}.chat-input{padding:8px;border-top:1px solid #e1e5e9;display:flex;gap:6px}.chat-input-field{flex:1;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:11px;resize:none;min-height:28px}.chat-input-field:focus{outline:none;border-color:#3b82f6}.chat-send{background:#3b82f6;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:10px}.chat-send:hover:not(:disabled){background:#2563eb}.chat-send:disabled{background:#9ca3af;cursor:not-allowed}.chat-empty{text-align:center;color:#9ca3af;padding:20px;font-size:11px}.chat-toggle{position:fixed;bottom:10px;right:10px;background:#3b82f6;color:#fff;border:none;padding:10px 15px;border-radius:20px;cursor:pointer;font-size:12px;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.2);z-index:201;display:none}.chat-toggle:hover{background:#2563eb}

/* Chat Modals */
.chat-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1500}.chat-modal.show{display:flex}.chat-modal-content{background:#fff;border-radius:8px;padding:16px;max-width:300px;width:90%;max-height:70vh;overflow-y:auto}.chat-modal h3{margin-bottom:12px;color:#1f2937;font-size:14px}.chat-form-group{margin-bottom:12px}.chat-label{display:block;margin-bottom:4px;font-size:11px;color:#374151;font-weight:500}.chat-input{width:100%;padding:6px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:11px}.chat-input:focus{outline:none;border-color:#3b82f6}.chat-modal-btn{padding:6px 12px;border:none;border-radius:4px;cursor:pointer;font-size:11px;margin-right:6px}.chat-modal-btn.primary{background:#3b82f6;color:#fff}.chat-modal-btn.primary:hover{background:#2563eb}.chat-notification{position:fixed;top:10px;right:10px;padding:8px 12px;border-radius:6px;color:#fff;font-size:11px;z-index:2000;max-width:200px}.chat-notification.success{background:#10b981}.chat-notification.error{background:#ef4444}.chat-notification.warning{background:#f59e0b}

@media (max-width: 768px) {
    .chat-container {
        right: 5px;
        width: calc(100vw - 10px);
        max-width: 320px;
    }
}
</style></head><body><div id="introOverlay" class="intro-overlay"><div class="intro-content"><h1 class="intro-title"><img src="https://i.imgur.com/rWDfHo1.png" style="max-width: 100%;" alt=""></h1><p class="intro-description">Bienvenido a una isla que crece contigo.Cada vez que vives una historia,ayudas a alguien o aprendes algo nuevo,tu isla se transforma.Cada experiencia deja su huella.</p><br><button id="startButton" class="isla-button">Iniciar Aventura</button></div></div><canvas id="gameCanvas"></canvas>

<!-- Game UI -->
<div class="ui-container"><button id="debugToggle" style="display: none;" class="toggle-btn">DBG</button><button id="editToggle" style="display: none;" class="toggle-btn">Edit Mode</button><button id="spriteDebugToggle" style="display: none;" class="toggle-btn">Sprite Debug</button><div id="debugPanel" class="panel"><div><strong>Debug Info</strong></div><div>FPS:<span id="fps">60</span></div><div>Camera:<span id="cameraPos">0,0,0</span></div><div>Zoom:<span id="zoomLevel">1.0</span></div><div style="margin: 8px 0; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 8px;"><div><strong>Terrain Seed</strong></div><div style="font-family: monospace; font-size: 10px; word-break: break-all; margin: 4px 0;"><span id="currentSeed">Loading...</span></div><div><button id="exportBtn" style="font-size: 10px; padding: 4px 8px; margin: 2px;">Export</button><button id="importBtn" style="font-size: 10px; padding: 4px 8px; margin: 2px;">Import</button></div></div><div class="light-control"><label>Light X</label><input id="lx" type="range" min="-100" max="100" step="0.5" value="50"><label>Light Y</label><input id="ly" type="range" min="-100" max="100" step="0.5" value="50"><label>Light Z</label><input id="lz" type="range" min="-100" max="100" step="0.5" value="25"><label>Color</label><input id="lcolor" type="color" value="#fff6e0"><label for="lightSlider">Light Power</label><input id="lightSlider" type="range" min="0" max="2" step="0.01" value="0.95"/></div><div class="controls-text"><div><strong>Desktop:</strong>WASD/Arrows=Move|Wheel=Zoom|Drag=Pan</div><div><strong>Mobile:</strong>Drag=Pan|Pinch=Zoom|Tap=Select</div></div></div><div id="spriteDebugPanel" class="panel sprite-debug-panel"><div><strong>Sprite Debug</strong></div><div><button id="terrainSpriteToggle">Terrain:Sprites</button></div><div style="margin: 8px 0;"><label>U Offset:</label><input type="number" id="uOffsetInput" step="0.01" value="0" style="width: 60px;"><input type="range" id="uOffset" min="-2" max="2" step="0.01" value="0"></div><div style="margin: 8px 0;"><label>V Offset:</label><input type="number" id="vOffsetInput" step="0.01" value="0" style="width: 60px;"><input type="range" id="vOffset" min="-2" max="2" step="0.01" value="0"></div><div style="margin: 8px 0;"><label>U Scale:</label><input type="number" id="uScaleInput" step="0.1" value="1" style="width: 60px;"><input type="range" id="uScale" min="0.1" max="5" step="0.01" value="1"></div><div style="margin: 8px 0;"><label>V Scale:</label><input type="number" id="vScaleInput" step="0.1" value="1" style="width: 60px;"><input type="range" id="vScale" min="0.1" max="5" step="0.01" value="1"></div><div style="margin: 8px 0;"><button id="resetTextureBtn" style="background: #f44336;">Reset Texture</button></div><div id="pipReference" class="pip-reference"><img id="pipImage" src="https://i.imgur.com/C4l87Xp.png" alt="Texture Reference"><div class="pip-overlay"></div><div class="pip-label">Texture Atlas</div></div></div><div id="editPanel" class="panel"><div><strong>Tile Editor</strong></div><div style="margin: 8px 0;">Selected:<span id="selectedTile">None</span>|Height:<span id="selectedHeight">-</span></div><div><button id="raiseBtn" disabled>Raise(+)</button><button id="lowerBtn" disabled>Lower(-)</button><button id="clearBtn">Clear</button></div><div class="controls-text">Click tiles to select|Shift+Click=Lower|Ctrl+Click=Reset</div></div></div><div id="editIndicator" class="edit-indicator">EDIT MODE ACTIVE</div><div id="tooltipContainer" class="tooltip-container"></div>

<!-- Chat Toggle Button -->
<button id="chatToggle" class="chat-toggle">💬 Chat</button>

<!-- Chat Container -->
<div id="chatContainer" class="chat-container"><div class="chat-header" onclick="toggleChatMinimize()"><div class="chat-status" id="chatStatus"></div><div class="chat-title" id="chatRoomName">MiniGeo Chat</div><div class="chat-controls"><button class="chat-btn" onclick="showChatSettings()">⚙</button><button class="chat-btn" onclick="toggleChatMinimize()">−</button><button class="chat-btn" onclick="closeChat()">×</button></div></div><div class="chat-body" id="chatMessages"><div class="chat-empty">Conectando...</div></div><div class="chat-input"><textarea class="chat-input-field" id="chatInput" placeholder="Escribe un mensaje..." maxlength="1000" disabled></textarea><button class="chat-send" id="chatSendBtn" onclick="sendChatMessage()" disabled>📤</button></div></div>

<!-- Chat Modals -->
<div class="chat-modal" id="chatSettingsModal"><div class="chat-modal-content"><h3>⚙ Configuración</h3><div class="chat-form-group"><label class="chat-label">Nombre</label><input type="text" class="chat-input" id="chatUserName" placeholder="Tu nombre" maxlength="50"></div><div class="chat-form-group"><label class="chat-label">Sala</label><select class="chat-input" id="chatRoomSelect"><option value="">Seleccionar sala...</option></select></div><button class="chat-modal-btn primary" onclick="updateChatUser()">Actualizar</button><button class="chat-modal-btn" onclick="closeChatModal('chatSettingsModal')">Cerrar</button></div></div>

<script src="./game.js"></script>
<script>
// Chat Integration JavaScript
const CHAT_API = 'https://chat.minigeo.org';

const adjectives = ['Genial','Increible','Fantastico','Brillante','Magnifico','Excelente','Asombroso','Estupendo','Maravilloso','Espectacular','Fabuloso','Sensacional','Extraordinario','Fenomenal','Impresionante','Sorprendente','Radiante','Vibrante','Dinamico','Energico','Creativo','Innovador','Inspirador','Optimista','Positivo','Alegre','Divertido','Encantador','Carismatico','Inteligente'];

let chatUser = {
    id: generateChatId(),
    name: generateRandomChatName(),
    isMod: false,
    isAdmin: false,
    token: ''
};

let currentRoom = null;
let chatRooms = [];
let chatMessages = [];
let chatPoll = null;
let lastMessage = null;
let chatConnected = false;
let chatRetry = 0;
let pendingMessages = new Map();
let chatMinimized = false;

const MAX_RETRY = 5;
const POLL_INTERVAL = 3000;
const RETRY_DELAY = 5000;

function generateRandomChatName() {
    const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
    const num = String(Math.floor(Math.random() * 90) + 10);
    return `${adj}${num}`;
}

function generateChatId() {
    const t = Date.now().toString(36);
    const r = Math.random().toString(36).substr(2, 9);
    return `user_${t}_${r}`.substr(0, 24);
}

function generateTempChatId() {
    return `temp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
}

// Initialize chat system
function initializeChat() {
    loadChatUser();
    setupChatEvents();
    
    // Show chat toggle button
    document.getElementById('chatToggle').style.display = 'block';
    
    // Auto-initialize chat
    setTimeout(async () => {
        try {
            await loadChatRooms();
            await testChatConnection();
            if (chatRooms.length > 0) {
                await autoJoinMainRoom();
                startChatPoll();
                updateChatStatus('online');
                chatRetry = 0;
            }
        } catch (e) {
            console.error('Chat initialization failed:', e);
            updateChatStatus('offline');
        }
    }, 1000);
}

function setupChatEvents() {
    const input = document.getElementById('chatInput');
    if (input) {
        input.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        });
    }
    
    document.getElementById('chatUserName').value = chatUser.name || '';
}

function loadChatUser() {
    const stored = localStorage.getItem('minigeoUser');
    if (stored) {
        try {
            const parsed = JSON.parse(stored);
            chatUser = { ...chatUser, ...parsed };
            if (!chatUser.name) chatUser.name = generateRandomChatName();
        } catch (e) {
            localStorage.removeItem('minigeoUser');
            chatUser.name = generateRandomChatName();
        }
    } else {
        chatUser.name = generateRandomChatName();
    }
}

function saveChatUser() {
    localStorage.setItem('minigeoUser', JSON.stringify(chatUser));
}

async function testChatConnection() {
    try {
        const r = await fetchChatAPI(`${CHAT_API}/api/health`, {}, 5000);
        if (r.ok) {
            chatConnected = true;
            return true;
        }
    } catch (e) {
        console.error('Chat connection test failed:', e);
    }
    chatConnected = false;
    return false;
}

async function fetchChatAPI(url, options = {}, timeout = 10000) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeout);
    
    try {
        const headers = options.headers || {};
        if (chatUser.token) headers.Authorization = `Bearer ${chatUser.token}`;
        
        const response = await fetch(url, {
            ...options,
            headers,
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        return response;
    } catch (e) {
        clearTimeout(timeoutId);
        throw e;
    }
}

async function loadChatRooms() {
    try {
        const r = await fetchChatAPI(`${CHAT_API}/api/rooms`);
        const data = await r.json();
        if (r.ok) {
            chatRooms = data.rooms || [];
        }
    } catch (e) {
        console.error('Failed to load chat rooms:', e);
    }
}

async function autoJoinMainRoom() {
    try {
        await joinChatRoom('mainroom');
    } catch (e) {
        console.error('Failed to join main room:', e);
    }
}

async function joinChatRoom(roomName) {
    if (currentRoom === roomName) return;
    
    try {
        if (currentRoom) await leaveChatRoom(currentRoom);
        
        const r = await fetchChatAPI(`${CHAT_API}/api/join-room`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: chatUser.id,
                roomName: roomName,
                userName: chatUser.name
            })
        });
        
        const data = await r.json();
        if (r.ok) {
            currentRoom = roomName;
            const room = chatRooms.find(r => r.name === roomName);
            document.getElementById('chatRoomName').textContent = room?.displayName || roomName;
            document.getElementById('chatInput').disabled = false;
            document.getElementById('chatSendBtn').disabled = false;
            clearChatMessages();
            await loadChatMessages();
        }
    } catch (e) {
        console.error('Failed to join room:', e);
    }
}

async function leaveChatRoom(roomName) {
    try {
        await fetchChatAPI(`${CHAT_API}/api/leave-room`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: chatUser.id,
                roomName: roomName
            })
        });
    } catch (e) {
        console.error('Failed to leave room:', e);
    }
}

async function loadChatMessages() {
    if (!currentRoom || !chatConnected) return;
    
    try {
        let url = `${CHAT_API}/api/messages?room=${currentRoom}&limit=20&userId=${chatUser.id}`;
        if (lastMessage) url += `&since=${lastMessage}`;
        
        const r = await fetchChatAPI(url, {}, 5000);
        const data = await r.json();
        
        if (r.ok && data.messages) {
            if (data.messages.length > 0) {
                addChatMessages(data.messages);
                lastMessage = data.messages[data.messages.length - 1].timestamp;
            }
            if (!chatConnected) {
                chatConnected = true;
                updateChatStatus('online');
                chatRetry = 0;
            }
        }
    } catch (e) {
        console.error('Failed to load messages:', e);
        if (chatConnected) {
            chatConnected = false;
            updateChatStatus('offline');
        }
    }
}

function addChatMessages(newMessages) {
    newMessages.forEach(msg => {
        const existingIndex = chatMessages.findIndex(m => m.id === msg.id);
        if (existingIndex !== -1) {
            chatMessages[existingIndex] = msg;
        } else {
            chatMessages.push(msg);
        }
    });
    
    if (chatMessages.length > 50) {
        chatMessages = chatMessages.slice(-50);
    }
    
    renderChatMessages();
    scrollChatToBottom();
}

function clearChatMessages() {
    chatMessages = [];
    lastMessage = null;
    pendingMessages.clear();
    renderChatMessages();
}

function renderChatMessages() {
    const container = document.getElementById('chatMessages');
    if (!chatMessages.length) {
        if (currentRoom) {
            container.innerHTML = '<div class="chat-empty">Cargando mensajes...</div>';
        } else {
            container.innerHTML = '<div class="chat-empty">Únete a una sala para chatear</div>';
        }
        return;
    }
    
    container.innerHTML = '';
    chatMessages.forEach(msg => {
        const div = document.createElement('div');
        let classes = `chat-msg ${msg.userId === chatUser.id ? 'own' : ''}`;
        if (msg.isAdmin) classes += ' admin';
        else if (msg.isMod) classes += ' mod';
        
        div.className = classes;
        
        const time = new Date(msg.timestamp).toLocaleTimeString([], {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        div.innerHTML = `
            <div class="chat-msg-header">
                <span class="chat-user">${escapeHtml(msg.userName || 'Usuario')}</span>
                <span class="chat-time">${time}</span>
            </div>
            <div class="chat-text">${escapeHtml(msg.message || '')}</div>
        `;
        
        container.appendChild(div);
    });
}

async function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (!message || !currentRoom || !chatUser.name) return;
    
    if (message.length > 1000) {
        showChatNotification('Mensaje muy largo', 'error');
        return;
    }
    
    const btn = document.getElementById('chatSendBtn');
    btn.disabled = true;
    
    const tempId = generateTempChatId();
    const tempMessage = {
        id: tempId,
        tempId,
        message: message,
        userId: chatUser.id,
        userName: chatUser.name,
        timestamp: new Date().toISOString(),
        pending: true,
        isAdmin: chatUser.isAdmin,
        isMod: chatUser.isMod
    };
    
    chatMessages.push(tempMessage);
    pendingMessages.set(tempId, tempMessage);
    input.value = '';
    renderChatMessages();
    scrollChatToBottom();
    
    try {
        const r = await fetchChatAPI(`${CHAT_API}/api/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                roomName: currentRoom,
                userId: chatUser.id,
                userName: chatUser.name,
                message: message
            })
        });
        
        if (r.ok) {
            const data = await r.json();
            if (data.message) {
                const msgIndex = chatMessages.findIndex(m => m.tempId === tempId);
                if (msgIndex !== -1) {
                    pendingMessages.delete(tempId);
                    chatMessages[msgIndex] = { ...data.message, tempId: undefined, pending: false };
                    renderChatMessages();
                }
            }
        }
    } catch (e) {
        console.error('Failed to send message:', e);
        showChatNotification('Error al enviar mensaje', 'error');
    } finally {
        btn.disabled = false;
    }
}

function startChatPoll() {
    if (chatPoll) clearInterval(chatPoll);
    chatPoll = setInterval(loadChatMessages, POLL_INTERVAL);
}

function updateChatStatus(status) {
    const statusEl = document.getElementById('chatStatus');
    statusEl.className = `chat-status ${status}`;
    chatConnected = status === 'online';
}

function scrollChatToBottom() {
    const container = document.getElementById('chatMessages');
    container.scrollTop = container.scrollHeight;
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showChatNotification(message, type = 'success') {
    document.querySelectorAll('.chat-notification').forEach(el => el.remove());
    
    const notification = document.createElement('div');
    notification.className = `chat-notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => notification.remove(), 3000);
}

// Chat UI Controls
function toggleChat() {
    const container = document.getElementById('chatContainer');
    const toggle = document.getElementById('chatToggle');
    
    if (container.classList.contains('visible')) {
        container.classList.remove('active');
        setTimeout(() => {
            container.classList.remove('visible');
            toggle.style.display = 'block';
        }, 300);
    } else {
        container.classList.add('visible');
        toggle.style.display = 'none';
        setTimeout(() => {
            container.classList.add('active');
            scrollChatToBottom();
        }, 10);
    }
}

function closeChat() {
    const container = document.getElementById('chatContainer');
    const toggle = document.getElementById('chatToggle');
    
    container.classList.remove('active');
    setTimeout(() => {
        container.classList.remove('visible');
        toggle.style.display = 'block';
    }, 300);
}

function toggleChatMinimize() {
    const container = document.getElementById('chatContainer');
    chatMinimized = !chatMinimized;
    
    if (chatMinimized) {
        container.classList.add('chat-minimized');
    } else {
        container.classList.remove('chat-minimized');
        scrollChatToBottom();
    }
}

function showChatSettings() {
    const modal = document.getElementById('chatSettingsModal');
    const select = document.getElementById('chatRoomSelect');
    
    select.innerHTML = '<option value="">Seleccionar sala...</option>';
    chatRooms.forEach(room => {
        const option = document.createElement('option');
        option.value = room.name;
        option.textContent = room.displayName || room.name;
        if (room.name === currentRoom) option.selected = true;
        select.appendChild(option);
    });
    
    select.onchange = () => {
        if (select.value) joinChatRoom(select.value);
    };
    
    modal.classList.add('show');
}

async function updateChatUser() {
    const name = document.getElementById('chatUserName').value.trim();
    if (!name) {
        showChatNotification('Ingresa un nombre', 'error');
        return;
    }
    
    try {
        const r = await fetchChatAPI(`${CHAT_API}/api/users`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: chatUser.id,
                name: name
            })
        });
        
        const data = await r.json();
        if (r.ok) {
            chatUser.name = name;
            saveChatUser();
            showChatNotification('Nombre actualizado', 'success');
            closeChatModal('chatSettingsModal');
        }
    } catch (e) {
        console.error('Failed to update user:', e);
        showChatNotification('Error al actualizar', 'error');
    }
}

function closeChatModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
}

// Event Listeners
document.getElementById('chatToggle').addEventListener('click', toggleChat);

// Modify the original game initialization to include chat
const originalStartButton = document.getElementById('startButton');
originalStartButton.addEventListener('click', function() {
    // Original game start logic
    const cameraSystem = window.game ? window.game.cameraSystem : null;
    if (cameraSystem) {
        cameraSystem.setCameraPreset('default', true);
    }
    
    const introOverlay = document.getElementById('introOverlay');
    introOverlay.classList.add('hidden');
    setTimeout(() => {
        introOverlay.style.display = 'none';
    }, 500);
    
    // Initialize chat after game starts
    setTimeout(() => {
        initializeChat();
    }, 1500);
});

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (chatPoll) clearInterval(chatPoll);
    if (currentRoom) {
        navigator.sendBeacon(`${CHAT_API}/api/leave-room`, JSON.stringify({
            userId: chatUser.id,
            roomName: currentRoom
        }));
    }
});
</script></body></html>