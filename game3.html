<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Isla Historias/Story Island-MiniGEO</title><script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#2c3e50;overflow:hidden}#gameCanvas{display:block;width:100vw;height:60vh;touch-action:none;cursor:grab}#gameCanvas:active{cursor:grabbing}#gameContainer{position:relative;height:60vh;width:100vw}.game-ui{position:absolute;top:10px;left:10px;z-index:100}.toggle-btn{background:rgba(0,0,0,.8);color:#fff;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;font-size:9px;margin-bottom:5px}.toggle-btn:hover{background:rgba(0,0,0,.9)}.toggle-btn.active{background:#4CAF50}.panel{color:#fff;background:rgba(0,0,0,.8);padding:12px;border-radius:6px;font-size:12px;margin-bottom:5px;min-width:200px;max-width:310px;display:none}.panel.visible{display:block}.panel button{background:#4CAF50;color:#fff;border:none;padding:6px 12px;border-radius:3px;cursor:pointer;font-size:11px;margin:2px}.panel button:hover{background:#45a049}.panel button:disabled{background:#666;cursor:not-allowed}.edit-indicator{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#ff6b6b;font-size:16px;font-weight:700;text-shadow:2px 2px 4px rgba(0,0,0,.8);z-index:99;pointer-events:none;display:none}.edit-indicator.visible{display:block}.controls-text{font-size:10px;color:#ccc;margin-top:8px;line-height:1.3}.tooltip-container{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:auto;z-index:150}.tooltip{background:rgba(0,0,0,.9);color:#fff;padding:8px 12px;border-radius:6px;font-size:14px;font-family:-apple-system,BlinkMacSystemFont,sans-serif;white-space:nowrap;box-shadow:0 2px 8px rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.2);opacity:0;transform:translateY(10px);transition:all 0.3s ease;cursor:pointer}.tooltip:hover{background:rgba(76,175,80,.3);border-color:#4CAF50;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.6)}.tooltip.visible{opacity:1;transform:translateY(0)}.tooltip.interact{border-color:#4CAF50;background:rgba(76,175,80,.2);backdrop-filter:blur(4px)}.interact-prompt{color:#fff;font-weight:700;font-size:12px;margin-top:4px}.intro-overlay{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(1,255,255,0.45);backdrop-filter:blur(3px);display:flex;align-items:flex-start;justify-content:center;z-index:1000;opacity:1;transition:opacity 0.5s ease}.intro-overlay.hidden{opacity:0;pointer-events:none}.intro-content{text-align:center;color:white;max-width:500px;padding:40px}.intro-title{font-size:3.5rem;font-weight:bold;margin-bottom:24px;text-shadow:2px 2px 8px rgba(0,0,0,0.8);letter-spacing:2px}.intro-description{font-size:1.1rem;line-height:1.6;text-shadow:1px 2px 2px rgba(0,0,0,0.55),-1px 1px 10px rgba(0,0,0,0.85);margin-bottom:32px;opacity:0.9}.start-button{background:#43aa8b;color:white;border:none;padding:16px 32px;border-radius:8px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(67,170,139,0.3)}.start-button:hover{background:#4fc3f7;transform:translateY(-2px);box-shadow:0 6px 16px rgba(79,195,247,0.4)}#gameInterface{display:none;position:fixed;bottom:0;left:0;right:0;height:40vh;background:#f8f9fa;border-top:3px solid #43aa8b;z-index:100;transition:height 0.3s ease}#gameInterface.minimized{height:80px}#playerSection{height:80px;background:#fff;border-bottom:1px solid #e1e5e9;display:flex;align-items:center;padding:0 16px;justify-content:space-between;flex-shrink:0}#playerInfo{display:flex;align-items:center;gap:12px}#playerAvatar{width:50px;height:50px;border-radius:50%;background:#43aa8b;display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px;font-weight:bold}#playerStatus{display:flex;flex-direction:column}#playerName{font-weight:600;color:#1a1a1a;font-size:16px}#playerStatusText{color:#43aa8b;font-size:14px}#zoomToggle{background:#43aa8b;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:12px;transition:all 0.2s}#zoomToggle:hover{background:#3a9b7a}#chatSection{flex:1;display:flex;flex-direction:column;min-height:0;background:#fff}#chatSection.hidden{display:none}.chat{width:100%;height:100%;background:#fff;display:flex;flex-direction:column}.chat-header{height:40px;background:#f8f9fa;border-bottom:1px solid #e1e5e9;display:flex;align-items:center;justify-content:space-between;padding:0 16px;flex-shrink:0}.room-name{font-weight:500;color:#1a1a1a;font-size:14px;flex:1}.status-indicator{width:8px;height:8px;border-radius:50%;background:#10b981}.status-indicator.offline{background:#ef4444}.status-indicator.connecting{background:#f59e0b}.chat-messages{flex:1;overflow-y:auto;padding:12px;min-height:0;background:#f8f9fa}.message{margin-bottom:8px;padding:8px 12px;background:#fff;border-radius:8px;border-left:3px solid #e5e7eb;max-width:85%}.message.own{background:#eff6ff;border-left-color:#3b82f6;margin-left:auto}.message.admin{border-left-color:#8b5cf6}.message.mod{border-left-color:#f59e0b}.message-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}.username{font-weight:600;color:#374151;font-size:12px}.timestamp{font-size:10px;color:#9ca3af}.message-text{color:#1f2937;line-height:1.4;font-size:13px}.chat-input-area{padding:12px;border-top:1px solid #e1e5e9;flex-shrink:0;display:flex;gap:8px;background:#fff}.chat-input{flex:1;min-height:32px;max-height:80px;padding:8px 12px;border:1px solid #d1d5db;border-radius:6px;resize:none;font-family:inherit;font-size:13px}.chat-input:focus{outline:none;border-color:#3b82f6}.send-button{background:#3b82f6;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:12px;transition:background 0.2s}.send-button:hover:not(:disabled){background:#2563eb}.send-button:disabled{background:#9ca3af;cursor:not-allowed}.empty-chat{text-align:center;color:#9ca3af;padding:40px 20px;font-size:14px}@media(orientation:portrait){#gameCanvas{height:50vh}#gameInterface{height:50vh}#gameInterface.minimized{height:80px}}@media(min-width:768px){#gameCanvas{height:70vh}#gameInterface{height:30vh}}@media(max-width:480px){#playerSection{padding:0 12px}#playerName{font-size:14px}#playerStatusText{font-size:12px}#playerAvatar{width:40px;height:40px;font-size:16px}}</style></head><body><div id="introOverlay" class="intro-overlay"><div class="intro-content"><h1 class="intro-title"><img src="https://i.imgur.com/rWDfHo1.png" style="max-width:100%;" alt=""></h1><p class="intro-description">Bienvenido a una isla que crece contigo. Cada vez que vives una historia, ayudas a alguien o aprendes algo nuevo, tu isla se transforma. Cada experiencia deja su huella.</p><br><button id="startButton" class="start-button">Iniciar Aventura</button></div></div><div id="gameContainer"><canvas id="gameCanvas"></canvas><div class="game-ui"><button id="debugToggle" style="display:none;" class="toggle-btn">DBG</button><button id="editToggle" style="display:none;" class="toggle-btn">Edit</button><div id="debugPanel" class="panel"><div><strong>Debug Info</strong></div><div>FPS:<span id="fps">60</span></div><div>Camera:<span id="cameraPos">0,0,0</span></div></div><div id="editPanel" class="panel"><div><strong>Editor</strong></div><div>Selected:<span id="selectedTile">None</span></div><button id="raiseBtn" disabled>Raise</button><button id="lowerBtn" disabled>Lower</button></div></div><div id="editIndicator" class="edit-indicator">EDIT MODE</div><div id="tooltipContainer" class="tooltip-container"></div></div><div id="gameInterface"><div id="playerSection"><div id="playerInfo"><div id="playerAvatar">P</div><div id="playerStatus"><div id="playerName">PLAYER</div><div id="playerStatusText">OKAY</div></div></div><button id="zoomToggle">üìç Zoom Map</button></div><div id="chatSection"><div class="chat"><div class="chat-header"><div class="room-name">MiniGeo Chat</div><div class="status-indicator" id="chatStatus"></div></div><div class="chat-messages" id="chatMessages"><div class="empty-chat">Conectando al chat...</div></div><div class="chat-input-area"><textarea class="chat-input" id="chatInput" placeholder="Escribe un mensaje..." maxlength="1000" disabled></textarea><button class="send-button" id="sendButton" disabled>Enviar</button></div></div></div></div><script>const USE_SPRITE_PLAYER=!0,USE_SPRITE_TERRAIN=!0;let chatConnected=!1,chatMessages=[],currentRoom='mainroom',chatUser={id:`user_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:`Player${Math.floor(Math.random()*1000)}`};const API='https://chat.minigeo.org';class GameEngine{constructor(){this.lastFrameTime=performance.now(),this.deltaTime=0,this.targetFPS=60,this.frameInterval=1e3/this.targetFPS,this.gridSize=16,this.tileSize=2,this.heightLevels=8,this.editMode=!1,this.selectedTile=null,this.raycaster=new THREE.Raycaster,this.mouse=new THREE.Vector2,this.initialCameraState={position:new THREE.Vector3,target:new THREE.Vector3,zoom:1,preset:"default"},this.input={keys:{},mouse:{x:0,y:0,pressed:!1},touch:{active:!1,pinchDistance:0,moved:!1}},this.cloudSprites=[],this.terrainSystem=new TerrainSystem(this.gridSize,this.tileSize,this.heightLevels,!0),this.interactables=[],this.proximityRadius=2.5,this.activeTooltip=null,this.cameraSystem=new CameraSystem(this),this.init()}init(){this.setupRenderer(),this.cameraSystem.setupCamera(),this.camera=this.cameraSystem.camera,this.setupScene(),this.setupLighting(),this.setupClouds(),this.setupTerrain(),this.setupInput(),this.setupUI(),this.setupInteractables(),this.player=new Player(this),this.setupIntro(),this.start()}setupIntro(){this.cameraSystem.setCameraPreset("overview",!1);const startBtn=document.getElementById("startButton");startBtn.onclick=()=>{this.cameraSystem.setCameraPreset("default",!0,()=>{console.log("Camera transition completed")});const overlay=document.getElementById("introOverlay");overlay.classList.add("hidden");setTimeout(()=>{overlay.style.display="none",this.showGameInterface()},500)}}showGameInterface(){const gameInterface=document.getElementById("gameInterface");gameInterface.style.display="block";const canvas=document.getElementById("gameCanvas");canvas.style.height="60vh";this.handleResize();setTimeout(()=>{this.initChat()},1000)}setupRenderer(){this.canvas=document.getElementById("gameCanvas"),this.renderer=new THREE.WebGLRenderer({canvas:this.canvas,antialias:!0}),this.renderer.setPixelRatio(Math.min(devicePixelRatio,2)),this.renderer.setSize(window.innerWidth,window.innerHeight*.6),this.renderer.setClearColor(5223385),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=THREE.PCFSoftShadowMap}setCameraPreset(e,t=!0,i=null){this.cameraSystem.setCameraPreset(e,t,i)}setupScene(){this.scene=new THREE.Scene,this.scene.fog=new THREE.Fog(5223385,30,100)}setupLighting(){this.scene.add(new THREE.AmbientLight(16777215,.4)),this.directionalLight=new THREE.DirectionalLight(16774880,.95),this.directionalLight.position.set(50,50,25),this.directionalLight.castShadow=!0,this.directionalLight.shadow.mapSize.setScalar(2048),Object.assign(this.directionalLight.shadow.camera,{near:.1,far:200,left:-50,right:50,top:50,bottom:-50}),this.scene.add(this.directionalLight)}setupClouds(){const loader=new THREE.TextureLoader;loader.load("https://i.imgur.com/mYRt74O.png",texture=>{for(let i=0;i<6;i++){const sprite=new THREE.Sprite(new THREE.SpriteMaterial({map:texture,opacity:.7,transparent:!0}));sprite.position.set((Math.random()-.5)*this.gridSize*this.tileSize,8+2*Math.random(),(Math.random()-.5)*this.gridSize*this.tileSize),sprite.scale.set(8+6*Math.random(),4+2*Math.random(),1),sprite.userData.speed=.01*(.5+.2*Math.random()),this.scene.add(sprite),this.cloudSprites.push(sprite)}})}setupTerrain(){this.terrainSystem.generateTerrain(),this.terrainSystem.loadFromSeed("9877766666677789877665555556677877665544445566777665444334445667765443333334456765543322223345566544321111234456654332100123345665433210012334566544321111234456655433222233455676544333333445677665444334445667776655444455667787766555555667789877766666677789"),this.scene.add(this.terrainSystem.terrainGroup),this.terrain=this.terrainSystem}setupInput(){["keydown","keyup"].forEach(e=>window.addEventListener(e,t=>this.input.keys[t.code]="keydown"===e)),["mousedown","mousemove","mouseup"].forEach(e=>this.canvas.addEventListener(e,t=>this.handleMouse(e,t))),this.canvas.addEventListener("wheel",e=>{e.preventDefault(),this.cameraSystem.zoomCamera(e.deltaY>0?.1:-.1)}),["touchstart","touchmove","touchend"].forEach(e=>{const handlerName="handleTouch"+e.slice(5).charAt(0).toUpperCase()+e.slice(6);this.canvas.addEventListener(e,e=>{e.preventDefault(),typeof this[handlerName]==="function"&&this[handlerName](e)})}),window.addEventListener("resize",()=>this.handleResize())}setupUI(){const zoomToggle=document.getElementById("zoomToggle");zoomToggle.onclick=()=>this.toggleZoomMode()}toggleZoomMode(){const gameInterface=document.getElementById("gameInterface"),chatSection=document.getElementById("chatSection");gameInterface.classList.toggle("minimized"),chatSection.classList.toggle("hidden");const canvas=document.getElementById("gameCanvas");canvas.style.height=gameInterface.classList.contains("minimized")?"calc(100vh - 80px)":"60vh",this.handleResize()}handleMouse(e,t){const mouse=this.input.mouse;"mousedown"===e?(mouse.pressed=!0,mouse.x=t.clientX,mouse.y=t.clientY):"mousemove"===e&&mouse.pressed&&!this.editMode?this.cameraSystem.panCamera(t.clientX-mouse.x,t.clientY-mouse.y):"mouseup"===e&&(mouse.pressed=!1),"mouseup"!==e&&(mouse.x=t.clientX,mouse.y=t.clientY)}handleTouchStart(e){const touches=e.touches;1===touches.length?Object.assign(this.input.touch,{active:!0,moved:!1,start:{x:touches[0].clientX,y:touches[0].clientY}}):2===touches.length&&(this.input.touch.pinchDistance=Math.hypot(touches[0].clientX-touches[1].clientX,touches[0].clientY-touches[1].clientY),this.input.touch.moved=!1)}handleTouchMove(e){const touches=e.touches;if(1===touches.length&&this.input.touch.active){const delta={x:(touches[0].clientX-this.input.touch.start.x)/window.innerWidth,y:(touches[0].clientY-this.input.touch.start.y)/window.innerHeight},dist=Math.hypot(delta.x,delta.y);dist>0&&!this.editMode&&(this.input.touch.moved=!0,this.cameraSystem.panCamera(70*delta.x,70*delta.y))}else if(2===touches.length){const currentPinchDistance=Math.hypot(touches[0].clientX-touches[1].clientX,touches[0].clientY-touches[1].clientY);this.cameraSystem.zoomCamera((this.input.touch.pinchDistance-currentPinchDistance)*.01),this.input.touch.pinchDistance=currentPinchDistance,this.input.touch.moved=!0}}handleTouchEnd(e){if(this.input.touch.active&&1===e.changedTouches.length){const touch=e.changedTouches[0],isTap=!this.input.touch.moved;if(!this.editMode&&isTap){const rect=this.canvas.getBoundingClientRect();this.mouse.set((touch.clientX-rect.left)/rect.width*2-1,-((touch.clientY-rect.top)/rect.height)*2+1),this.raycaster.setFromCamera(this.mouse,this.camera);const intersects=this.raycaster.intersectObjects(this.terrainSystem.terrainGroup.children,!0);if(intersects.length){const{x:tileX,z:tileZ}=intersects[0].object.userData;this.player&&this.player.sprite&&this.player.findPath(this.player.pos,{x:tileX,z:tileZ},path=>{this.player.path=path,this.player.progress=0})}}}Object.assign(this.input.touch,{active:!1,start:null,moved:!1})}handleKeyboardInput(){this.cameraSystem.handleKeyboardCameraInput()}handleResize(){this.cameraSystem.handleResize();const canvas=document.getElementById("gameCanvas");if(canvas.style.height.includes("calc")){this.renderer.setSize(window.innerWidth,window.innerHeight-80)}else{this.renderer.setSize(window.innerWidth,window.innerHeight*.6)}this.renderer.setPixelRatio(Math.min(devicePixelRatio,2))}start(){this.animate()}animate(){requestAnimationFrame(()=>this.animate());const currentTime=performance.now();this.deltaTime=Math.min(currentTime-this.lastFrameTime,33.33),this.lastFrameTime=currentTime,this.update(),this.render()}update(){this.handleKeyboardInput(),this.cameraSystem.update(),this.cloudSprites.forEach((sprite,index)=>{index%4===Math.floor(Date.now()/100)%4&&(sprite.position.x+=sprite.userData.speed*(this.deltaTime/16.67),sprite.position.x>this.gridSize*this.tileSize&&(sprite.position.x=-this.gridSize*this.tileSize))}),this.player&&this.player.update()}render(){this.renderer.render(this.scene,this.camera)}setupInteractables(){setTimeout(()=>{this.npcs&&this.npcs.forEach(npc=>{npc.isInteractable&&this.interactables.push({mesh:npc.sprite,x:npc.pos.x,z:npc.pos.z,type:"npc",message:npc.name||"Friendly NPC",interact:"Press E to talk",inRange:!1,npcRef:npc})})},500)}showMessage(message){console.log("Game message:",message)}showConfirmationDialog(data,callback){console.log("Confirmation dialog:",data),callback&&callback(!0)}async initChat(){try{const response=await fetch(`${API}/api/join-room`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:chatUser.id,roomName:currentRoom,userName:chatUser.name})});if(response.ok){chatConnected=!0,this.updateChatStatus('online'),await this.loadChatMessages(),this.startChatPolling(),this.setupChatEvents()}else{throw new Error('Failed to connect')}}catch(error){console.error('Chat connection failed:',error),this.updateChatStatus('offline')}}updateChatStatus(status){const statusEl=document.getElementById('chatStatus');statusEl.className=`status-indicator ${status}`;if(status==='online'){chatConnected=!0}else{chatConnected=!1}}setupChatEvents(){const input=document.getElementById('chatInput'),sendBtn=document.getElementById('sendButton');input.disabled=!1,sendBtn.disabled=!1,input.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault(),this.sendChatMessage()}}),sendBtn.onclick=()=>this.sendChatMessage()}async sendChatMessage(){const input=document.getElementById('chatInput'),message=input.value.trim();if(!message||!chatConnected)return;input.disabled=!0;try{const response=await fetch(`${API}/api/messages`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({roomName:currentRoom,userId:chatUser.id,userName:chatUser.name,message})});if(response.ok){input.value='',await this.loadChatMessages()}else{throw new Error('Failed to send message')}}catch(error){console.error('Failed to send message:',error)}finally{input.disabled=!1}}async loadChatMessages(){if(!chatConnected)return;try{const response=await fetch(`${API}/api/messages?room=${currentRoom}&limit=20&userId=${chatUser.id}`);const data=await response.json();if(response.ok&&data.messages){chatMessages=data.messages,this.renderChatMessages()}else{throw new Error('Failed to load messages')}}catch(error){console.error('Failed to load messages:',error)}}renderChatMessages(){const container=document.getElementById('chatMessages');if(!chatMessages.length){container.innerHTML='<div class="empty-chat">No hay mensajes a√∫n...</div>';return}container.innerHTML='',chatMessages.forEach(msg=>{const div=document.createElement('div');div.className=`message ${msg.userId===chatUser.id?'own':''}`;if(msg.isAdmin)div.className+=' admin';else if(msg.isMod)div.className+=' mod';const time=new Date(msg.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});div.innerHTML=`<div class="message-header"><span class="username">${this.escapeHtml(msg.userName||'Usuario')}</span><span class="timestamp">${time}</span></div><div class="message-text">${this.escapeHtml(msg.message||'')}</div>`;container.appendChild(div)});container.scrollTop=container.scrollHeight}escapeHtml(text){const div=document.createElement('div');div.textContent=text;return div.innerHTML}startChatPolling(){setInterval(()=>{if(chatConnected){this.loadChatMessages()}},3000)}}class TerrainSystem{constructor(gridSize,tileSize,heightLevels,useSprites=!0){this.gridSize=gridSize,this.tileSize=tileSize,this.heightLevels=heightLevels,this.useSprites=useSprites;const minScale=1,maxScale=3.33;this.heightScales=Array.from({length:this.heightLevels},(v,i)=>minScale+i/(this.heightLevels-1)*(maxScale-minScale)),this.terrainGroup=new THREE.Group,this.tiles=[],this.levelColors=[2588065,5227511,4434571,9485933,16369487,16352330,15954476,5731728],this.useSprites&&(this.terrainTexture=new THREE.TextureLoader().load("https://i.imgur.com/qBGomXL.png"),this.terrainTexture.magFilter=THREE.NearestFilter,this.terrainTexture.minFilter=THREE.NearestFilter,this.spriteSize=96,this.layerHeight=96,this.totalLayers=3)}generateTerrain(){for(let x=0;x<this.gridSize;x++){this.tiles[x]=[];for(let z=0;z<this.gridSize;z++){const height=this.generateHeightForPosition(x,z),tileMesh=this.createTile(x,z,height);tileMesh.castShadow=tileMesh.receiveShadow=!0,this.tiles[x][z]={height,mesh:tileMesh},this.terrainGroup.add(tileMesh)}}}generateHeightForPosition(x,z){const centerX=this.gridSize/2,centerZ=this.gridSize/2,distance=Math.sqrt((x-centerX)**2+(z-centerZ)**2),maxDistance=Math.sqrt(centerX**2+centerZ**2);let baseHeight=Math.floor((1-distance/maxDistance)*this.heightLevels);return baseHeight+=Math.floor((Math.random()-.5)*3),Math.max(0,Math.min(this.heightLevels-1,baseHeight))}createTile(x,z,height){return this.create3DTile(x,z,height)}create3DTile(x,z,height){const scale=this.heightScales[height],geometry=new THREE.BoxGeometry(this.tileSize*.9,scale,this.tileSize*.9),material=new THREE.MeshLambertMaterial({color:this.levelColors[height]}),mesh=new THREE.Mesh(geometry,material),worldX=(x-this.gridSize/2)*this.tileSize,worldZ=(z-this.gridSize/2)*this.tileSize;return mesh.position.set(worldX,scale/2+.05,worldZ),mesh.userData={x,z,height},mesh}getTile(x,z){return this.tiles[x]?.[z]}loadFromSeed(seed){if(seed.length!==this.gridSize*this.gridSize)return!1;let index=0;for(let x=0;x<this.gridSize;x++){for(let z=0;z<this.gridSize;z++){const heightChar=parseInt(seed[index],36)||0,height=Math.max(0,Math.min(this.heightLevels-1,heightChar));this.updateTileHeight(x,z,height),index++}}return!0}updateTileHeight(x,z,newHeight){const tile=this.getTile(x,z);if(!tile)return;this.terrainGroup.remove(tile.mesh),tile.mesh.geometry?.dispose(),tile.mesh.material?.dispose();const newMesh=this.createTile(x,z,newHeight);newMesh.castShadow=newMesh.receiveShadow=!0,tile.height=newHeight,tile.mesh=newMesh,this.terrainGroup.add(newMesh)}}class CameraSystem{constructor(game){this.game=game,this.cameraTarget=new THREE.Vector3,this.cameraOffset=new THREE.Vector3(10,10,10),this.zoomLevel=1,this.followTarget=null,this.initialCameraState={position:new THREE.Vector3,target:new THREE.Vector3,zoom:1,preset:"default"},this.cameraPresets={default:{type:"orthographic",offset:new THREE.Vector3(10,10,10),zoom:1,followPlayer:!1,lookAtTarget:!0},followPlayer:{type:"orthographic",offset:new THREE.Vector3(6,9,10),zoom:.9,followPlayer:!0,lookAtTarget:!0},overview:{type:"orthographic",offset:new THREE.Vector3(20,25,20),zoom:2,followPlayer:!1,lookAtTarget:!0,centerTarget:!0}},this.cameraTransition={active:!1,duration:2e3,startTime:0,fromPosition:new THREE.Vector3,toPosition:new THREE.Vector3,fromTarget:new THREE.Vector3,toTarget:new THREE.Vector3,fromZoom:1,toZoom:1,callback:null},this.currentCameraPreset="default"}setupCamera(){const aspect=window.innerWidth/window.innerHeight,frustumSize=20*this.zoomLevel;this.camera=new THREE.OrthographicCamera(-frustumSize*aspect/2,frustumSize*aspect/2,frustumSize/2,-frustumSize/2,-100,1e3),this.updateCameraPosition()}setCameraPreset(preset,smooth=!0,callback=null){const presetData=this.cameraPresets[preset];if(!presetData)return;this.currentCameraPreset=preset,smooth&&this.camera?(this.cameraTransition.active=!0,this.cameraTransition.startTime=Date.now(),this.cameraTransition.callback=callback,this.cameraTransition.fromPosition.copy(this.camera.position),this.cameraTransition.fromTarget.copy(this.cameraTarget),this.cameraTransition.fromZoom=this.zoomLevel,this.calculateCameraTarget(presetData,this.cameraTransition.toTarget),this.cameraTransition.toPosition.copy(this.cameraTransition.toTarget).add(presetData.offset),this.cameraTransition.toZoom=presetData.zoom||1):(this.applyCameraPreset(presetData),callback&&callback())}calculateCameraTarget(preset,target){preset.centerTarget?target.set(0,0,0):target.copy(this.cameraTarget)}applyCameraPreset(preset){this.calculateCameraTarget(preset,this.cameraTarget),this.zoomLevel=preset.zoom||1,this.cameraOffset.copy(preset.offset),this.updateCameraPosition();const aspect=window.innerWidth/window.innerHeight,frustumSize=20*this.zoomLevel;this.camera.left=-frustumSize*aspect/2,this.camera.right=frustumSize*aspect/2,this.camera.top=frustumSize/2,this.camera.bottom=-frustumSize/2,this.camera.updateProjectionMatrix()}panCamera(deltaX,deltaY){const sensitivity=.01*this.zoomLevel,rightDir=new THREE.Vector3(1,0,-1).normalize(),upDir=new THREE.Vector3(1,0,1).normalize();this.cameraTarget.add(rightDir.clone().multiplyScalar(-deltaX*sensitivity)),this.cameraTarget.add(upDir.clone().multiplyScalar(-deltaY*sensitivity));const bounds=this.game.gridSize*this.game.tileSize/2;this.cameraTarget.x=Math.max(-bounds,Math.min(bounds,this.cameraTarget.x)),this.cameraTarget.z=Math.max(-bounds,Math.min(bounds,this.cameraTarget.z))}zoomCamera(delta){this.zoomLevel=Math.max(.3,Math.min(3,this.zoomLevel+delta));const aspect=window.innerWidth/window.innerHeight,frustumSize=20*this.zoomLevel;Object.assign(this.camera,{left:-frustumSize*aspect/2,right:frustumSize*aspect/2,top:frustumSize/2,bottom:-frustumSize/2}),this.camera.updateProjectionMatrix()}updateCameraPosition(){this.camera.position.copy(this.cameraTarget.clone().add(this.cameraOffset)),this.camera.lookAt(this.cameraTarget)}handleKeyboardCameraInput(){const keys=this.game.input.keys,movement=new THREE.Vector3;(keys.KeyW||keys.ArrowUp)&&movement.add(new THREE.Vector3(-1,0,-1)),(keys.KeyS||keys.ArrowDown)&&movement.add(new THREE.Vector3(1,0,1)),(keys.KeyA||keys.ArrowLeft)&&movement.add(new THREE.Vector3(-1,0,1)),(keys.KeyD||keys.ArrowRight)&&movement.add(new THREE.Vector3(1,0,-1)),movement.lengthSq()>0&&(movement.normalize().multiplyScalar(.3),this.cameraTarget.add(movement)),keys.KeyQ&&this.zoomCamera(.02),keys.KeyE&&this.zoomCamera(-.02);const bounds=this.game.gridSize*this.game.tileSize/2;this.cameraTarget.clamp(new THREE.Vector3(-bounds,0,-bounds),new THREE.Vector3(bounds,0,bounds))}updateCameraTransition(){if(this.cameraTransition&&this.cameraTransition.active){const elapsed=Date.now()-this.cameraTransition.startTime,progress=Math.min(elapsed/this.cameraTransition.duration,1),easedProgress=1-Math.pow(1-progress,3);if(this.camera.position.lerpVectors(this.cameraTransition.fromPosition,this.cameraTransition.toPosition,easedProgress),this.cameraTarget.lerpVectors(this.cameraTransition.fromTarget,this.cameraTransition.toTarget,easedProgress),this.camera.isOrthographicCamera){this.zoomLevel=THREE.MathUtils.lerp(this.cameraTransition.fromZoom,this.cameraTransition.toZoom,easedProgress);const aspect=window.innerWidth/window.innerHeight,frustumSize=20*this.zoomLevel;this.camera.left=-frustumSize*aspect/2,this.camera.right=frustumSize*aspect/2,this.camera.top=frustumSize/2,this.camera.bottom=-frustumSize/2,this.camera.updateProjectionMatrix()}progress>=1&&(this.cameraTransition.active=!1,this.cameraTransition.callback&&this.cameraTransition.callback())}}handleResize(){const aspect=window.innerWidth/window.innerHeight,frustumSize=20*this.zoomLevel;Object.assign(this.camera,{left:-frustumSize*aspect/2,right:frustumSize*aspect/2,top:frustumSize/2,bottom:-frustumSize/2}),this.camera.updateProjectionMatrix()}update(){this.updateCameraTransition(),this.updateCameraPosition()}}class Player{constructor(game){this.game=game,this.speed=.03,this.path=[],this.facingLeft=!1,this.progress=0,this._vA=new THREE.Vector3,this._vB=new THREE.Vector3,this.pos={x:10,z:9},this.pathLine=null,this.pathLines=[],this.pathAnimationTime=0,this.animationState="idle",this.animationFrame=0,this.animationTime=0,this.animationSpeed=.15,this.spriteRow=0,this.animations={idle:{frames:[{x:0,y:0}],frameCount:1,loop:!0},walking:{frames:[{x:64,y:0},{x:128,y:0},{x:192,y:0},{x:256,y:0}],frameCount:4,loop:!0}},USE_SPRITE_PLAYER?(new THREE.TextureLoader).load("https://i.imgur.com/4lded4b.png",texture=>{texture.magFilter=texture.minFilter=THREE.NearestFilter,this.sprite=new THREE.Sprite(new THREE.SpriteMaterial({map:texture,transparent:!0})),this.sprite.scale.setScalar(2),this.texW=texture.image.width,this.texH=texture.image.height;const frame=this.animations.idle.frames[0];this.setFrameUV(frame.x,frame.y,64,64,this.texW,this.texH),this.game.scene.add(this.sprite),this.setPosition(this.pos.x,this.pos.z)}):(this.sprite=new THREE.Mesh(new THREE.CylinderGeometry(.3,.3,1,8),new THREE.MeshLambertMaterial({color:16739179})),this.sprite.castShadow=!0,this.game.scene.add(this.sprite),this.setPosition(this.pos.x,this.pos.z)),this.initInput()}setFrameUV(frameX,frameY,frameW,frameH,texW,texH){this.sprite.material.map&&(this.facingLeft?(this.sprite.material.map.offset.set((frameX+frameW)/texW,1-(frameY+frameH)/texH),this.sprite.material.map.repeat.set(-frameW/texW,frameH/texH)):(this.sprite.material.map.offset.set(frameX/texW,1-(frameY+frameH)/texH),this.sprite.material.map.repeat.set(frameW/texW,frameH/texH)))}updateAnimation(){if(!this.sprite||!this.sprite.material.map)return;const animation=this.animations[this.animationState];if(!animation)return;this.animationTime+=.001*this.game.deltaTime,this.animationTime>=this.animationSpeed&&(this.animationTime=0,animation.frameCount>1&&(this.animationFrame++,this.animationFrame>=animation.frameCount&&(this.animationFrame=animation.loop?0:animation.frameCount-1)));const frame=animation.frames[this.animationFrame];this.setFrameUV(frame.x,frame.y,64,64,this.texW,this.texH)}setPosition(x,z){const tile=this.game.terrain.getTile(x,z);if(!tile||!this.sprite)return;const worldY=this.game.terrain.heightScales[tile.height];this.sprite.position.set(tile.mesh.position.x,worldY+1,tile.mesh.position.z),this.pos={x,z}}initInput(){this.game.canvas.addEventListener("click",event=>{const rect=this.game.canvas.getBoundingClientRect();this.game.mouse.set((event.clientX-rect.left)/rect.width*2-1,-((event.clientY-rect.top)/rect.height)*2+1),this.game.raycaster.setFromCamera(this.game.mouse,this.game.camera);const intersects=this.game.raycaster.intersectObjects(this.game.terrain.terrainGroup.children,!0);if(intersects.length){const{x:targetX,z:targetZ}=intersects[0].object.userData;this.findPath(this.pos,{x:targetX,z:targetZ},path=>{this.path=path,this.progress=0})}})}update(){if(!this.path.length||!this.sprite){"idle"!==this.animationState&&(this.animationState="idle",this.animationFrame=0,this.animationTime=0),this.updateAnimation();return}"walking"!==this.animationState&&(this.animationState="walking",this.animationFrame=0,this.animationTime=0);const nextTile=this.path[0],currentTile=this.game.terrain.getTile(this.pos.x,this.pos.z),targetTile=this.game.terrain.getTile(nextTile.x,nextTile.z);if(!targetTile||!currentTile){this.path=[];return}if(0===this.progress){const deltaX=nextTile.x-this.pos.x,deltaZ=nextTile.z-this.pos.z,facing=deltaX-deltaZ;if(0!==facing){const shouldFaceLeft=facing<0;shouldFaceLeft!==this.facingLeft&&(this.facingLeft=shouldFaceLeft,this.sprite.scale.x=Math.abs(this.sprite.scale.x)*(this.facingLeft?-1:1))}const fromPos=currentTile.mesh.position,toPos=targetTile.mesh.position;this._vA.set(fromPos.x,this.game.terrain.heightScales[currentTile.height]+1,fromPos.z),this._vB.set(toPos.x,this.game.terrain.heightScales[targetTile.height]+1,toPos.z)}const moveSpeed=this.speed*(this.game.deltaTime/16.67);this.progress+=moveSpeed,this.progress>=1?(this.setPosition(nextTile.x,nextTile.z),this.path.shift(),this.progress=0):(this.sprite.position.lerpVectors(this._vA,this._vB,this.progress),this.sprite.position.y+=.5*Math.sin(this.progress*Math.PI)),this.updateAnimation()}findPath(start,end,callback){setTimeout(()=>{const walkable=this.game.terrain.tiles.map(row=>row.map(tile=>tile.height<this.game.heightLevels)),openSet=[start],cameFrom={},gScore={[`${start.x},${start.z}`]:0},heuristic=(a,b)=>Math.abs(a.x-b.x)+Math.abs(a.z-b.z);while(openSet.length){openSet.sort((a,b)=>gScore[`${a.x},${a.z}`]+heuristic(a,end)-(gScore[`${b.x},${b.z}`]+heuristic(b,end)));const current=openSet.shift();if(current.x===end.x&&current.z===end.z)break;for(const[dx,dz]of[[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]]){const neighborX=current.x+dx,neighborZ=current.z+dz,neighborKey=`${neighborX},${neighborZ}`;if(!walkable[neighborX]?.[neighborZ])continue;const tentativeGScore=gScore[`${current.x},${current.z}`]+1;if(!(neighborKey in gScore)||tentativeGScore<gScore[neighborKey]){gScore[neighborKey]=tentativeGScore,cameFrom[neighborKey]=current,openSet.push({x:neighborX,z:neighborZ})}}}const path=[],current=end,currentKey=`${current.x},${current.z}`;while(cameFrom[currentKey]){path.unshift(current);const from=cameFrom[currentKey];currentKey=`${from.x},${from.z}`}callback(path)},0)}}window.game=new GameEngine;</script></body></html>