<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Isla Historias/Story Island-MiniGEO</title><script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script><script src="./debug.js"></script><script src="./camera.js"></script><script src="./terrain.js"></script><script src="./player.js"></script><script src="./npcs.js"></script><script src="./minigames.js"></script><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#2c3e50;overflow:hidden;position:relative}#gameCanvas{display:block;width:100vw;height:100vh;touch-action:none;cursor:grab;position:absolute;top:0;left:0;z-index:1}#gameCanvas:active{cursor:grabbing}.ui-container{position:absolute;top:10px;left:10px;z-index:100}.toggle-btn{background:rgba(0,0,0,.8);color:#fff;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;font-size:9px;margin-bottom:5px}.toggle-btn:hover{background:rgba(0,0,0,.9)}.toggle-btn.active{background:#4CAF50}.panel{color:#fff;background:rgba(0,0,0,.8);padding:12px;border-radius:6px;font-size:12px;margin-bottom:5px;min-width:200px;max-width:310px;display:none}.panel.visible{display:block}.panel button{background:#4CAF50;color:#fff;border:none;padding:6px 12px;border-radius:3px;cursor:pointer;font-size:11px;margin:2px}.panel button:hover{background:#45a049}.panel button:disabled{background:#666;cursor:not-allowed}.edit-indicator{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#ff6b6b;font-size:16px;font-weight:700;text-shadow:2px 2px 4px rgba(0,0,0,.8);z-index:99;pointer-events:none;display:none}.edit-indicator.visible{display:block}.controls-text{font-size:10px;color:#ccc;margin-top:8px;line-height:1.3}.tooltip-container{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:auto;z-index:150}.tooltip{background:rgba(0,0,0,.9);color:#fff;padding:8px 12px;border-radius:6px;font-size:14px;font-family:-apple-system,BlinkMacSystemFont,sans-serif;white-space:nowrap;box-shadow:0 2px 8px rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.2);opacity:0;transform:translateY(10px);transition:all 0.3s ease;cursor:pointer}.tooltip:hover{background:rgba(76,175,80,.3);border-color:#4CAF50;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.6)}.tooltip.visible{opacity:1;transform:translateY(0)}.tooltip.interact{border-color:#4CAF50;background:rgba(76,175,80,.2);backdrop-filter:blur(4px)}.interact-prompt{color:#fff;font-weight:700;font-size:12px;margin-top:4px}.sprite-debug-panel{position:relative!important;top:120px;right:20px;background:rgba(0,0,0,.8);color:#fff;padding:10px;border-radius:5px;display:none;min-width:250px}.pip-reference{position:relative;bottom:0;left:0;width:64px;height:64px;border:2px solid #4CAF50;border-radius:5px;background:rgba(0,0,0,.8);z-index:200}.pip-reference.visible{display:block}.pip-reference img{width:100%;height:100%;object-fit:cover;border-radius:3px}.pip-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background-image:linear-gradient(to right,rgba(255,255,255,.3)0,transparent 1px),linear-gradient(to bottom,rgba(255,255,255,.3)0,transparent 1px);background-size:15px 15px;pointer-events:none}.pip-label{position:absolute;bottom:-20px;left:0;right:0;text-align:center;font-size:10px;color:#ccc;font-weight:700}#spriteDebugPanel input[type="number"]{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.3);color:#fff;padding:2px 4px;border-radius:2px;margin:0 5px}#spriteDebugPanel input[type="range"]{width:100px;margin:0 5px}#spriteDebugPanel label{display:inline-block;width:60px;font-size:11px}.sprite-debug-panel.visible{display:block}.isla-button{font-family:monospace;font-size:1.2em;font-weight:bold;color:#181818;background:linear-gradient(to bottom,#ffe76b 0%,#ffc933 40%,#e68a00 100%);border:none;border-radius:12px;padding:20px 40px;box-shadow:inset 0 1px 0 rgba(255,255,255,.8),0 3px 0 #c56a00,0 5px 8px rgba(0,0,0,.25);cursor:pointer;text-transform:uppercase;transition:all.15s ease-in-out}.isla-button:hover{filter:brightness(1.15)}.isla-button:active{transform:translateY(3px);box-shadow:inset 0 1px 0 rgba(255,255,255,.8),0 2px 0 #c56a00,0 3px 6px rgba(0,0,0,.25)}.intro-overlay{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(1,255,255,0.45);backdrop-filter:blur(3px);display:flex;align-items:flex-start;justify-content:center;z-index:1000;opacity:1;transition:opacity 0.5s ease}.intro-overlay.hidden{opacity:0;pointer-events:none}.intro-content{text-align:center;color:white;max-width:500px;padding:40px}.intro-title{font-size:3.5rem;font-weight:bold;margin-bottom:24px;text-shadow:2px 2px 8px rgba(0,0,0,0.8);letter-spacing:2px}.intro-description{font-size:1.1rem;line-height:1.6;text-shadow:1px 2px 2px rgba(0,0,0,0.55),-1px 1px 10px rgba(0,0,0,0.85);margin-bottom:32px;opacity:0.9}.start-button{background:#43aa8b;color:white;border:none;padding:16px 32px;border-radius:8px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(67,170,139,0.3)}.start-button:hover{background:#4fc3f7;transform:translateY(-2px);box-shadow:0 6px 16px rgba(79,195,247,0.4)}.mobile-ui{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(135deg,#4a90e2 0%,#357abd 100%);z-index:1001;display:none;flex-direction:column;transition:all 0.3s ease}.mobile-ui.visible{display:flex}.island-view{height:120px;background:linear-gradient(135deg,#74b9ff 0%,#0984e3 100%);position:relative;overflow:hidden;border-radius:12px 12px 0 0;margin:8px 8px 0 8px;display:flex;align-items:center;justify-content:center}.island-mini{width:80px;height:60px;background:radial-gradient(ellipse at center,#00b894 0%,#00a085 50%,#008f72 100%);border-radius:50%;position:relative;box-shadow:0 4px 8px rgba(0,0,0,0.2)}.island-mini::before{content:'üèùÔ∏è';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:24px}.player-section{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);padding:12px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(255,255,255,0.1)}.player-avatar{width:40px;height:40px;background:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px}.player-info{flex:1}.player-name{color:#fff;font-weight:600;font-size:14px;margin-bottom:2px}.player-status{color:rgba(255,255,255,0.8);font-size:12px}.chat-toggle{background:rgba(255,255,255,0.2);border:none;color:#fff;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:12px}.chat-toggle:hover{background:rgba(255,255,255,0.3)}.chat-section{background:#fff;flex:1;max-height:300px;display:flex;flex-direction:column;transition:all 0.3s ease}.chat-section.minimized{max-height:0;overflow:hidden}.chat-hdr{height:32px;background:#f8f9fa;border-bottom:1px solid #e1e5e9;display:flex;align-items:center;justify-content:space-between;padding:0 12px;flex-shrink:0}.chat-room{font-weight:500;color:#1a1a1a;font-size:12px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.chat-status{width:8px;height:8px;border-radius:50%;background:#10b981;flex-shrink:0}.chat-status.offline{background:#ef4444}.chat-status.connecting{background:#f59e0b}.chat-menu-btn{background:none;border:none;color:#6b7280;cursor:pointer;padding:4px;border-radius:3px;font-size:12px}.chat-menu-btn:hover{background:#f3f4f6}.chat-msgs{flex:1;overflow-y:auto;padding:8px 12px;min-height:0;font-size:12px}.chat-msg{margin-bottom:8px;padding:8px 10px;background:#f8f9fa;border-radius:8px;border-left:3px solid #e5e7eb;position:relative}.chat-msg.own{background:#eff6ff;border-left-color:#3b82f6;margin-left:20px}.chat-msg.admin{border-left-color:#8b5cf6}.chat-msg.mod{border-left-color:#f59e0b}.chat-msg.pending{opacity:0.7;border-left-color:#f59e0b}.chat-msg.error{background:#fee2e2;border-left-color:#ef4444}.chat-mhdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}.chat-user{font-weight:500;color:#374151;font-size:11px;display:flex;align-items:center;gap:4px}.chat-time{font-size:10px;color:#9ca3af}.chat-badge{font-size:9px;background:#6b7280;color:#fff;padding:1px 4px;border-radius:8px}.chat-badge.admin{background:#8b5cf6}.chat-badge.mod{background:#f59e0b}.chat-txt{color:#1f2937;line-height:1.3;word-wrap:break-word;font-size:11px}.chat-inp-area{padding:8px 12px;border-top:1px solid #e1e5e9;flex-shrink:0;display:flex;gap:6px}.chat-inp{flex:1;min-height:28px;max-height:48px;padding:6px 10px;border:1px solid #d1d5db;border-radius:6px;resize:none;font-family:inherit;font-size:12px}.chat-inp:focus{outline:none;border-color:#3b82f6}.chat-send-btn{background:#3b82f6;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:11px;flex-shrink:0}.chat-send-btn:hover:not(:disabled){background:#2563eb}.chat-send-btn:disabled{background:#9ca3af;cursor:not-allowed}.chat-empty{text-align:center;color:#9ca3af;padding:20px 12px;font-size:11px}</style></head><body><div id="introOverlay" class="intro-overlay"><div class="intro-content"><h1 class="intro-title"><img src="https://i.imgur.com/rWDfHo1.png" style="max-width:100%;" alt=""></h1><p class="intro-description">Bienvenido a una isla que crece contigo.Cada vez que vives una historia,ayudas a alguien o aprendes algo nuevo,tu isla se transforma.Cada experiencia deja su huella.</p><br><button id="startButton" class="isla-button">Iniciar Aventura</button></div></div><canvas id="gameCanvas"></canvas><div class="ui-container"><button id="debugToggle" style="display:none;" class="toggle-btn">DBG</button><button id="editToggle" style="display:none;" class="toggle-btn">Edit Mode</button><button id="spriteDebugToggle" style="display:none;" class="toggle-btn">Sprite Debug</button><div id="debugPanel" class="panel"><div><strong>Debug Info</strong></div><div>FPS:<span id="fps">60</span></div><div>Camera:<span id="cameraPos">0,0,0</span></div><div>Zoom:<span id="zoomLevel">1.0</span></div><div style="margin:8px 0;border-top:1px solid rgba(255,255,255,0.2);padding-top:8px;"><div><strong>Terrain Seed</strong></div><div style="font-family:monospace;font-size:10px;word-break:break-all;margin:4px 0;"><span id="currentSeed">Loading...</span></div><div><button id="exportBtn" style="font-size:10px;padding:4px 8px;margin:2px;">Export</button><button id="importBtn" style="font-size:10px;padding:4px 8px;margin:2px;">Import</button></div></div><div class="light-control"><label>Light X</label><input id="lx" type="range" min="-100" max="100" step="0.5" value="50"><label>Light Y</label><input id="ly" type="range" min="-100" max="100" step="0.5" value="50"><label>Light Z</label><input id="lz" type="range" min="-100" max="100" step="0.5" value="25"><label>Color</label><input id="lcolor" type="color" value="#fff6e0"><label for="lightSlider">Light Power</label><input id="lightSlider" type="range" min="0" max="2" step="0.01" value="0.95"/></div><div class="controls-text"><div><strong>Desktop:</strong>WASD/Arrows=Move|Wheel=Zoom|Drag=Pan</div><div><strong>Mobile:</strong>Drag=Pan|Pinch=Zoom|Tap=Select</div></div></div><div id="spriteDebugPanel" class="panel sprite-debug-panel"><div><strong>Sprite Debug</strong></div><div><button id="terrainSpriteToggle">Terrain:Sprites</button></div><div style="margin:8px 0;"><label>U Offset:</label><input type="number" id="uOffsetInput" step="0.01" value="0" style="width:60px;"><input type="range" id="uOffset" min="-2" max="2" step="0.01" value="0"></div><div style="margin:8px 0;"><label>V Offset:</label><input type="number" id="vOffsetInput" step="0.01" value="0" style="width:60px;"><input type="range" id="vOffset" min="-2" max="2" step="0.01" value="0"></div><div style="margin:8px 0;"><label>U Scale:</label><input type="number" id="uScaleInput" step="0.1" value="1" style="width:60px;"><input type="range" id="uScale" min="0.1" max="5" step="0.01" value="1"></div><div style="margin:8px 0;"><label>V Scale:</label><input type="number" id="vScaleInput" step="0.1" value="1" style="width:60px;"><input type="range" id="vScale" min="0.1" max="5" step="0.01" value="1"></div><div style="margin:8px 0;"><button id="resetTextureBtn" style="background:#f44336;">Reset Texture</button></div><div id="pipReference" class="pip-reference"><img id="pipImage" src="https://i.imgur.com/C4l87Xp.png" alt="Texture Reference"><div class="pip-overlay"></div><div class="pip-label">Texture Atlas</div></div></div><div id="editPanel" class="panel"><div><strong>Tile Editor</strong></div><div style="margin:8px 0;">Selected:<span id="selectedTile">None</span>|Height:<span id="selectedHeight">-</span></div><div><button id="raiseBtn" disabled>Raise(+)</button><button id="lowerBtn" disabled>Lower(-)</button><button id="clearBtn">Clear</button></div><div class="controls-text">Click tiles to select|Shift+Click=Lower|Ctrl+Click=Reset</div></div></div><div id="editIndicator" class="edit-indicator">EDIT MODE ACTIVE</div><div id="tooltipContainer" class="tooltip-container"></div><div class="mobile-ui" id="mobileUI"><div class="island-view"><div class="island-mini"></div></div><div class="player-section"><div class="player-avatar">üë§</div><div class="player-info"><div class="player-name" id="playerName">Aventurero</div><div class="player-status">Conectado</div></div><button class="chat-toggle" onclick="toggleChat()">üí¨</button></div><div class="chat-section" id="chatSection"><div class="chat-hdr"><div class="chat-room" id="chatRoom">MiniGeo Chat</div><div class="chat-status" id="chatStatus"></div><button class="chat-menu-btn" onclick="showChatSettings()">‚öô</button></div><div class="chat-msgs" id="chatMsgs"><div class="chat-empty">Conectando...</div></div><div class="chat-inp-area"><textarea class="chat-inp" id="chatInp" placeholder="Escribe un mensaje..." maxlength="1000" disabled></textarea><button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMsg()" disabled>üì§</button></div></div></div><script src="./game.js"></script><script>const API='https://chat.minigeo.org';const adjectives=['Genial','Increible','Fantastico','Brillante','Magnifico','Excelente','Asombroso','Estupendo','Maravilloso','Espectacular'];let chatUser={id:genChatId(),name:generateRandomName(),isMod:!1,isAdmin:!1,token:''};let currentRoom=null,chatRooms=[],chatMsgs=[],chatPoll=null,lastChatMsg=null,chatConnected=!1,chatRetry=0,pendingChatMsgs=new Map();const MAX_CHAT_RETRY=5,CHAT_POLL_INT=3000,CHAT_RETRY_DELAY=5000;function generateRandomName(){const adj=adjectives[Math.floor(Math.random()*adjectives.length)];const num=String(Math.floor(Math.random()*90)+10);return `${adj}${num}`}function genChatId(){const t=Date.now().toString(36),r=Math.random().toString(36).substr(2,9);return `user_${t}_${r}`.substr(0,24)}function genTempChatId(){return `temp_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async function initChat(){try{await loadChatUser();await loadChatRooms();if(chatRooms.length===0){showChatNotif('No hay salas disponibles','warning')}else{await autoJoinMainRoom()}await testChatConn();startChatPoll();updateChatStatus('online');chatRetry=0}catch(e){console.error(e);updateChatStatus('offline');scheduleChatRetry()}}async function loadChatUser(){const s=localStorage.getItem('minigeoUser');if(s){try{const p=JSON.parse(s);chatUser={...chatUser,...p};if(!chatUser.name)chatUser.name=generateRandomName()}catch(e){localStorage.removeItem('minigeoUser');chatUser.name=generateRandomName()}}else{chatUser.name=generateRandomName()}document.getElementById('playerName').textContent=chatUser.name||'Aventurero'}function saveChatUser(){localStorage.setItem('minigeoUser',JSON.stringify(chatUser))}async function autoJoinMainRoom(){try{await joinChatRoom('mainroom')}catch(e){console.error('No se pudo unir a main:',e)}}async function testChatConn(){try{const r=await fetchChatTo(`${API}/api/health`,{},5000);if(r.ok){chatConnected=!0;return!0}}catch(e){console.error(e)}chatConnected=!1;return!1}function scheduleChatRetry(){if(chatRetry<MAX_CHAT_RETRY){chatRetry++;setTimeout(async()=>{updateChatStatus('connecting');if(await testChatConn()){updateChatStatus('online');chatRetry=0;if(!chatPoll)startChatPoll()}else{updateChatStatus('offline');scheduleChatRetry()}},CHAT_RETRY_DELAY*chatRetry)}else{updateChatStatus('offline');showChatNotif('Sin conexi√≥n','error')}}async function fetchChatTo(url,opt={},timeout=10000){const ctrl=new AbortController();const id=setTimeout(()=>ctrl.abort(),timeout);try{const headers=opt.headers||{};if(chatUser.token)headers.Authorization=`Bearer ${chatUser.token}`;const r=await fetch(url,{...opt,headers,signal:ctrl.signal});clearTimeout(id);return r}catch(e){clearTimeout(id);throw e}}async function loadChatRooms(){try{const r=await fetchChatTo(`${API}/api/rooms`);const d=await r.json();if(r.ok){chatRooms=d.rooms||[]}else throw new Error(d.error||'Error cargando salas')}catch(e){console.error(e)}}async function joinChatRoom(name){if(currentRoom===name)return;if(!chatUser.name){showChatNotif('Configurando usuario...','error');return}try{if(currentRoom)await leaveChatRoom(currentRoom);const r=await fetchChatTo(`${API}/api/join-room`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:chatUser.id,roomName:name,userName:chatUser.name})});const d=await r.json();if(r.ok){currentRoom=name;const room=chatRooms.find(r=>r.name===name);document.getElementById('chatRoom').textContent=room?.displayName||name;document.getElementById('chatInp').disabled=!1;document.getElementById('chatSendBtn').disabled=!1;clearChatMsgs();await loadChatMsgs()}else throw new Error(d.error||'Error al unirse')}catch(e){console.error(e);showChatNotif('Error al conectar','error')}}async function leaveChatRoom(name){try{await fetchChatTo(`${API}/api/leave-room`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:chatUser.id,roomName:name})})}catch(e){console.error(e)}}async function loadChatMsgs(){if(!currentRoom||!chatConnected)return;try{let url=`${API}/api/messages?room=${currentRoom}&limit=30&userId=${chatUser.id}`;if(lastChatMsg)url+=`&since=${lastChatMsg}`;const r=await fetchChatTo(url,{},5000);const d=await r.json();if(r.ok&&d.messages){if(d.messages.length>0){addChatMsgs(d.messages);lastChatMsg=d.messages[d.messages.length-1].timestamp}if(!chatConnected){chatConnected=!0;updateChatStatus('online');chatRetry=0}}else throw new Error(d.error||'Error cargando mensajes')}catch(e){console.error(e);if(chatConnected){chatConnected=!1;updateChatStatus('offline');scheduleChatRetry()}}}function addChatMsgs(newMsgs){newMsgs.forEach(m=>{const existingIndex=chatMsgs.findIndex(x=>x.id===m.id);if(existingIndex!==-1){chatMsgs[existingIndex]=m}else{const pendingIndex=chatMsgs.findIndex(x=>x.tempId&&pendingChatMsgs.has(x.tempId));if(pendingIndex!==-1&&chatMsgs[pendingIndex].message===m.message&&chatMsgs[pendingIndex].userId===m.userId){pendingChatMsgs.delete(chatMsgs[pendingIndex].tempId);chatMsgs[pendingIndex]=m}else{chatMsgs.push(m)}}});if(chatMsgs.length>100)chatMsgs=chatMsgs.slice(-100);renderChatMsgs();scrollChatBottom()}function clearChatMsgs(){chatMsgs=[];lastChatMsg=null;pendingChatMsgs.clear();renderChatMsgs()}function renderChatMsgs(){const cont=document.getElementById('chatMsgs');if(!chatMsgs.length){if(currentRoom){cont.innerHTML='<div class="chat-empty">Cargando mensajes...</div>'}else{cont.innerHTML='<div class="chat-empty">Conectando al chat...</div>'}return}cont.innerHTML='';chatMsgs.forEach(m=>{const div=document.createElement('div');let classes=`chat-msg ${m.userId===chatUser.id?'own':''}`;if(m.isAdmin)classes+=' admin';else if(m.isMod)classes+=' mod';if(m.pending)classes+=' pending';if(m.error)classes+=' error';div.className=classes;const time=new Date(m.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});let badges='';if(m.isAdmin)badges='<span class="chat-badge admin">A</span>';else if(m.isMod)badges='<span class="chat-badge mod">M</span>';let statusIcon='';if(m.pending)statusIcon='<span style="color:#f59e0b;font-size:8px"> ‚è≥</span>';if(m.error)statusIcon='<span style="color:#ef4444;font-size:8px"> ‚ùå</span>';div.innerHTML=`<div class="chat-mhdr"><span class="chat-user">${escapeHtml(m.userName||'Usuario')}${badges}${statusIcon}</span><span class="chat-time">${time}</span></div><div class="chat-txt">${escapeHtml(m.message||'')}</div>`;cont.appendChild(div)})}async function sendChatMsg(){const inp=document.getElementById('chatInp');const msg=inp.value.trim();if(!msg||!currentRoom||!chatUser.name)return;if(msg.length>1000){showChatNotif('Mensaje muy largo','error');return}const btn=document.getElementById('chatSendBtn');btn.disabled=!0;const tempId=genTempChatId();const tempMsg={id:tempId,tempId,message:msg,userId:chatUser.id,userName:chatUser.name,timestamp:new Date().toISOString(),pending:!0,isAdmin:chatUser.isAdmin,isMod:chatUser.isMod};chatMsgs.push(tempMsg);pendingChatMsgs.set(tempId,tempMsg);inp.value='';inp.style.height='auto';renderChatMsgs();scrollChatBottom();try{const r=await fetchChatTo(`${API}/api/messages`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({roomName:currentRoom,userId:chatUser.id,userName:chatUser.name,message:msg})});if(r.ok){const d=await r.json();if(d.message){const msgIndex=chatMsgs.findIndex(m=>m.tempId===tempId);if(msgIndex!==-1){pendingChatMsgs.delete(tempId);chatMsgs[msgIndex]={...d.message,tempId:undefined,pending:false};renderChatMsgs()}}}else{const d=await r.json();throw new Error(d.error||'Error al enviar')}}catch(e){console.error(e);const msgIndex=chatMsgs.findIndex(m=>m.tempId===tempId);if(msgIndex!==-1){chatMsgs[msgIndex].error=!0;chatMsgs[msgIndex].pending=!1;renderChatMsgs()}showChatNotif('Error al enviar','error')}finally{btn.disabled=!1}}function startChatPoll(){if(chatPoll)clearInterval(chatPoll);chatPoll=setInterval(pollChatMsgs,CHAT_POLL_INT)}async function pollChatMsgs(){if(currentRoom)await loadChatMsgs()}function updateChatStatus(stat){const el=document.getElementById('chatStatus');el.className=`chat-status ${stat}`;chatConnected=stat==='online'}function escapeHtml(txt){if(!txt)return '';const div=document.createElement('div');div.textContent=txt;return div.innerHTML}function showChatNotif(msg,type='success'){console.log(`Chat: ${msg}`)}function scrollChatBottom(){const cont=document.getElementById('chatMsgs');cont.scrollTop=cont.scrollHeight}function toggleChat(){const chatSection=document.getElementById('chatSection');chatSection.classList.toggle('minimized')}function showChatSettings(){}document.addEventListener('DOMContentLoaded',()=>{const startBtn=document.getElementById('startButton');const origClick=startBtn.onclick;startBtn.onclick=()=>{if(origClick)origClick();document.getElementById('mobileUI').classList.add('visible');initChat()};const chatInp=document.getElementById('chatInp');chatInp.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendChatMsg()}});chatInp.addEventListener('input',e=>{e.target.style.height='auto';e.target.style.height=Math.min(e.target.scrollHeight,48)+'px'});window.addEventListener('beforeunload',()=>{if(chatPoll)clearInterval(chatPoll);if(currentRoom)navigator.sendBeacon(`${API}/api/leave-room`,JSON.stringify({userId:chatUser.id,roomName:currentRoom}))})});</script></body></html>