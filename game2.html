<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Isla Historias/Story Island-MiniGEO</title><script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script><script srwc="./debug.js"></script><script src="./camera.js"></script><script src="./terrain.js"></script><script src="./player.js"></script><script src="./npcs.js"></script><script src="./minigames.js"></script><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#2c3e50;overflow:hidden}#gameCanvas{display:block;width:100vw;height:100vh;touch-action:none;cursor:grab}#gameCanvas:active{cursor:grabbing}.ui-container{position:absolute;top:10px;left:10px;z-index:100}.toggle-btn{background:rgb(0 0 0/.8);color:#fff;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;font-size:9px;margin-bottom:5px}.toggle-btn:hover{background:rgb(0 0 0/.9)}.toggle-btn.active{background:#4CAF50}.panel{color:#fff;background:rgb(0 0 0/.8);padding:12px;border-radius:6px;font-size:12px;margin-bottom:5px;min-width:200px;max-width:310px;display:none}.panel.visible{display:block}.panel button{background:#4CAF50;color:#fff;border:none;padding:6px 12px;border-radius:3px;cursor:pointer;font-size:11px;margin:2px}.panel button:hover{background:#45a049}.panel button:disabled{background:#666;cursor:not-allowed}.edit-indicator{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#ff6b6b;font-size:16px;font-weight:700;text-shadow:2px 2px 4px rgb(0 0 0/.8);z-index:99;pointer-events:none;display:none}.edit-indicator.visible{display:block}.controls-text{font-size:10px;color:#ccc;margin-top:8px;line-height:1.3}.tooltip-container{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:auto;z-index:150}.tooltip{background:rgb(0 0 0/.9);color:#fff;padding:8px 12px;border-radius:6px;font-size:14px;font-family:-apple-system,BlinkMacSystemFont,sans-serif;white-space:nowrap;box-shadow:0 2px 8px rgb(0 0 0/.4);border:1px solid rgb(255 255 255/.2);opacity:0;transform:translateY(10px);transition:all 0.3s ease;cursor:pointer}.tooltip:hover{background:rgb(76 175 80/.3);border-color:#4CAF50;transform:translateY(-2px);box-shadow:0 4px 12px rgb(0 0 0/.6)}.tooltip.visible{opacity:1;transform:translateY(0)}.tooltip.interact{border-color:#4CAF50;background:rgb(76 175 80/.2);backdrop-filter:blur(4px)}.interact-prompt{color:#fff;font-weight:700;font-size:12px;margin-top:4px}.sprite-debug-panel{position:relative!important;top:120px;right:20px;background:rgb(0 0 0/.8);color:#fff;padding:10px;border-radius:5px;display:none;min-width:250px}.pip-reference{position:relative;bottom:0;left:0;width:64px;height:64px;border:2px solid #4CAF50;border-radius:5px;background:rgb(0 0 0/.8);z-index:200}.pip-reference.visible{display:block}.pip-reference img{width:100%;height:100%;object-fit:cover;border-radius:3px}.pip-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background-image:linear-gradient(to right,rgb(255 255 255/.3)0,transparent 1px),linear-gradient(to bottom,rgb(255 255 255/.3)0,transparent 1px);background-size:15px 15px;pointer-events:none}.pip-label{position:absolute;bottom:-20px;left:0;right:0;text-align:center;font-size:10px;color:#ccc;font-weight:700}#spriteDebugPanel input[type="number"]{background:rgb(255 255 255/.1);border:1px solid rgb(255 255 255/.3);color:#fff;padding:2px 4px;border-radius:2px;margin:0 5px}#spriteDebugPanel input[type="range"]{width:100px;margin:0 5px}#spriteDebugPanel label{display:inline-block;width:60px;font-size:11px}.sprite-debug-panel.visible{display:block}.isla-button{font-family:monospace;font-size:1.2em;font-weight:bold;color:#181818;background:linear-gradient(to bottom,#ffe76b 0%,#ffc933 40%,#e68a00 100%);border:none;border-radius:12px;padding:20px 40px;box-shadow:inset 0 1px 0 rgba(255,255,255,.8),0 3px 0 #c56a00,0 5px 8px rgba(0,0,0,.25);cursor:pointer;text-transform:uppercase;transition:all.15s ease-in-out}.isla-button:hover{filter:brightness(1.15)}.isla-button:active{transform:translateY(3px);box-shadow:inset 0 1px 0 rgba(255,255,255,.8),0 2px 0 #c56a00,0 3px 6px rgba(0,0,0,.25)}.intro-overlay{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(1,255,255,0.45);backdrop-filter:blur(3px);display:flex;align-items:flex-start;justify-content:center;z-index:1000;opacity:1;transition:opacity 0.5s ease}.intro-overlay.hidden{opacity:0;pointer-events:none}.intro-content{text-align:center;color:white;max-width:500px;padding:40px}.intro-title{font-size:3.5rem;font-weight:bold;margin-bottom:24px;text-shadow:2px 2px 8px rgba(0,0,0,0.8);letter-spacing:2px}.intro-description{font-size:1.1rem;line-height:1.6;text-shadow:1px 2px 2px rgba(0,0,0,0.55),-1px 1px 10px rgba(0,0,0,0.85);margin-bottom:32px;opacity:0.9}.start-button{background:#43aa8b;color:white;border:none;padding:16px 32px;border-radius:8px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(67,170,139,0.3)}.start-button:hover{background:#4fc3f7;transform:translateY(-2px);box-shadow:0 6px 16px rgba(79,195,247,0.4)}

/* Chat Integration Styles */
.chat-container{position:fixed;bottom:20px;right:20px;z-index:500;display:none}.chat-container.visible{display:block}.chat{width:320px;height:280px;background:#fff;border:1px solid #e1e5e9;border-radius:8px;display:flex;flex-direction:column;position:relative;box-shadow:0 4px 12px rgba(0,0,0,0.15)}.hdr{height:32px;background:#fff;border-bottom:1px solid #e1e5e9;display:flex;align-items:center;justify-content:space-between;padding:0 10px;flex-shrink:0}.room{font-weight:500;color:#1a1a1a;font-size:12px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.status{width:8px;height:8px;border-radius:50%;background:#10b981;flex-shrink:0}.status.offline{background:#ef4444}.status.connecting{background:#f59e0b}.menu-btn{background:none;border:none;color:#6b7280;cursor:pointer;padding:4px;border-radius:3px;font-size:11px}.menu-btn:hover{background:#f3f4f6}.msgs{flex:1;overflow-y:auto;padding:8px;min-height:0}.msg{width: 90%;margin-bottom:8px;padding:8px 10px;background:#f8f9fa;border-radius:8px;border-left:3px solid #e5e7eb;position:relative}.msg.own{background:#eff6ff;border-left-color:#3b82f6;margin-left:20px}.msg.admin{border-left-color:#8b5cf6}.msg.mod{border-left-color:#f59e0b}.msg.pending{opacity:0.7;border-left-color:#f59e0b}.msg.error{background:#fee2e2;border-left-color:#ef4444}.mhdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}.user{font-weight:500;color:#374151;font-size:11px;display:flex;align-items:center;gap:4px}.time{font-size:10px;color:#9ca3af}.badge{font-size:9px;background:#6b7280;color:#fff;padding:2px 5px;border-radius:10px}.badge.admin{background:#8b5cf6}.badge.mod{background:#f59e0b}.txt{color:#1f2937;line-height:1.3;word-wrap:break-word;font-size:12px;margin-bottom:5px}.karma{font-size:10px;color:#6b7280;margin-left:4px}.karma.pos{color:#10b981}.karma.neg{color:#ef4444}.vote-btns{display:flex;gap:3px;align-items:center}.vote-btn{background:none;border:1px solid #d1d5db;border-radius:4px;width:18px;height:16px;cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center;color:#6b7280}.vote-btn:hover{background:#f3f4f6}.vote-btn.active{background:#3b82f6;color:#fff;border-color:#3b82f6}.vote-btn.up.active{background:#10b981;border-color:#10b981}.vote-btn.down.active{background:#ef4444;border-color:#ef4444}.vote-score{font-size:9px;color:#6b7280;margin:0 4px;min-width:14px;text-align:center}.empty{text-align:center;color:#9ca3af;padding:24px 14px;font-size:12px}.inp-area{padding:8px;border-top:1px solid #e1e5e9;flex-shrink:0;display:flex;gap:5px}.inp{flex:1;min-height:28px;max-height:56px;padding:6px 10px;border:1px solid #d1d5db;border-radius:6px;resize:none;font-family:inherit;font-size:12px}.inp:focus{outline:none;border-color:#3b82f6}.send-btn{background:#3b82f6;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:11px;flex-shrink:0}.send-btn:hover:not(:disabled){background:#2563eb}.send-btn:disabled{background:#9ca3af;cursor:not-allowed}.mod-btns{position:absolute;top:3px;right:6px;display:none;gap:2px}.msg:hover .mod-btns{display:flex}.mod-btn{background:#ef4444;color:#fff;border:none;width:14px;height:14px;border-radius:3px;cursor:pointer;font-size:9px;display:flex;align-items:center;justify-content:center}.mod-btn.mute{background:#f59e0b}.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:2000}.modal.show{display:flex}.modal-content{background:#fff;border-radius:10px;padding:20px;max-width:380px;width:90%;max-height:80vh;overflow-y:auto}.modal h3{margin-bottom:15px;color:#1f2937;font-size:16px}.form-group{margin-bottom:15px}.label{display:block;margin-bottom:5px;font-size:12px;color:#374151;font-weight:500}.input{width:100%;padding:8px 10px;border:1px solid #d1d5db;border-radius:6px;font-size:12px}.input:focus{outline:none;border-color:#3b82f6}.btn{padding:8px 15px;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:500;margin-right:8px;margin-bottom:8px}.btn.primary{background:#3b82f6;color:#fff}.btn.primary:hover{background:#2563eb}.btn.success{background:#10b981;color:#fff}.btn.success:hover{background:#059669}.btn.danger{background:#ef4444;color:#fff}.btn.danger:hover{background:#dc2626}.btn.warning{background:#f59e0b;color:#fff}.btn.warning:hover{background:#d97706}.btn:disabled{opacity:.5;cursor:not-allowed}.archive-list{max-height:220px;overflow-y:auto}.archive-item{padding:10px;margin:5px 0;background:#f8f9fa;border-radius:6px;cursor:pointer;border-left:4px solid #3b82f6}.archive-item:hover{background:#f3f4f6}.notif{position:fixed;top:10px;right:10px;padding:10px 15px;border-radius:8px;color:#fff;font-size:12px;z-index:3000;max-width:220px}.notif.success{background:#10b981}.notif.error{background:#ef4444}.notif.warning{background:#f59e0b}.load{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.9);display:none;align-items:center;justify-content:center;font-size:12px;color:#6b7280}.load.show{display:flex}.mod-list{max-height:140px;overflow-y:auto;background:#f8f9fa;border-radius:6px;padding:10px;margin:10px 0}.mod-item{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid #e5e7eb}.mod-item:last-child{border-bottom:none}
</style></head><body><div id="introOverlay" class="intro-overlay"><div class="intro-content"><h1 class="intro-title"><img src="https://i.imgur.com/rWDfHo1.png" style="    max-width: 100%;" alt=""></h1><p class="intro-description">Bienvenido a una isla que crece contigo.Cada vez que vives una historia,ayudas a alguien o aprendes algo nuevo,tu isla se transforma.Cada experiencia deja su huella.</p><br><button id="startButton" class="isla-button">Iniciar Aventura</button></div></div><canvas id="gameCanvas"></canvas><div class="ui-container"><button id="debugToggle" style="display: none;" class="toggle-btn">DBG</button><button id="editToggle" style="display: none;" class="toggle-btn">Edit Mode</button><button id="spriteDebugToggle" style="display: none;" class="toggle-btn">Sprite Debug</button><div id="debugPanel" class="panel"><div><strong>Debug Info</strong></div><div>FPS:<span id="fps">60</span></div><div>Camera:<span id="cameraPos">0,0,0</span></div><div>Zoom:<span id="zoomLevel">1.0</span></div><div style="margin: 8px 0; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 8px;"><div><strong>Terrain Seed</strong></div><div style="font-family: monospace; font-size: 10px; word-break: break-all; margin: 4px 0;"><span id="currentSeed">Loading...</span></div><div><button id="exportBtn" style="font-size: 10px; padding: 4px 8px; margin: 2px;">Export</button><button id="importBtn" style="font-size: 10px; padding: 4px 8px; margin: 2px;">Import</button></div></div><div class="light-control"><label>Light X</label><input id="lx" type="range" min="-100" max="100" step="0.5" value="50"><label>Light Y</label><input id="ly" type="range" min="-100" max="100" step="0.5" value="50"><label>Light Z</label><input id="lz" type="range" min="-100" max="100" step="0.5" value="25"><label>Color</label><input id="lcolor" type="color" value="#fff6e0"><label for="lightSlider">Light Power</label><input id="lightSlider" type="range" min="0" max="2" step="0.01" value="0.95"/></div><div class="controls-text"><div><strong>Desktop:</strong>WASD/Arrows=Move|Wheel=Zoom|Drag=Pan</div><div><strong>Mobile:</strong>Drag=Pan|Pinch=Zoom|Tap=Select</div></div></div><div id="spriteDebugPanel" class="panel sprite-debug-panel"><div><strong>Sprite Debug</strong></div><div><button id="terrainSpriteToggle">Terrain:Sprites</button></div><div style="margin: 8px 0;"><label>U Offset:</label><input type="number" id="uOffsetInput" step="0.01" value="0" style="width: 60px;"><input type="range" id="uOffset" min="-2" max="2" step="0.01" value="0"></div><div style="margin: 8px 0;"><label>V Offset:</label><input type="number" id="vOffsetInput" step="0.01" value="0" style="width: 60px;"><input type="range" id="vOffset" min="-2" max="2" step="0.01" value="0"></div><div style="margin: 8px 0;"><label>U Scale:</label><input type="number" id="uScaleInput" step="0.1" value="1" style="width: 60px;"><input type="range" id="uScale" min="0.1" max="5" step="0.01" value="1"></div><div style="margin: 8px 0;"><label>V Scale:</label><input type="number" id="vScaleInput" step="0.1" value="1" style="width: 60px;"><input type="range" id="vScale" min="0.1" max="5" step="0.01" value="1"></div><div style="margin: 8px 0;"><button id="resetTextureBtn" style="background: #f44336;">Reset Texture</button></div><!-- Add this PIP reference image container --><div id="pipReference" class="pip-reference"><img id="pipImage" src="https://i.imgur.com/C4l87Xp.png" alt="Texture Reference"><div class="pip-overlay"></div><div class="pip-label">Texture Atlas</div></div></div><div id="editPanel" class="panel"><div><strong>Tile Editor</strong></div><div style="margin: 8px 0;">Selected:<span id="selectedTile">None</span>|Height:<span id="selectedHeight">-</span></div><div><button id="raiseBtn" disabled>Raise(+)</button><button id="lowerBtn" disabled>Lower(-)</button><button id="clearBtn">Clear</button></div><div class="controls-text">Click tiles to select|Shift+Click=Lower|Ctrl+Click=Reset</div></div></div><div id="editIndicator" class="edit-indicator">EDIT MODE ACTIVE</div><div id="tooltipContainer" class="tooltip-container"></div>

<!-- Chat Integration -->
<div class="chat-container" id="chatContainer">
<div class="chat">
<div class="hdr">
<div class="room" id="room-name">MiniGeo Chat</div>
<div class="status" id="status"></div>
<button class="menu-btn" onclick="showSettings()">⚙</button>
</div>
<div class="msgs" id="msgs">
<div class="empty">Conectando...</div>
</div>
<div class="inp-area">
<textarea class="inp" id="inp" placeholder="Escribe un mensaje..." maxlength="1000" disabled></textarea>
<button class="send-btn" id="send-btn" onclick="sendMsg()" disabled>📤</button>
</div>
<div class="load" id="load">Cargando...</div>
</div>
</div>

<!-- Chat Modals -->
<div class="modal" id="settingsModal">
<div class="modal-content">
<h3>⚙ Configuración</h3>
<div class="form-group">
<label class="label">Nombre</label>
<input type="text" class="input" id="userName" placeholder="Tu nombre" maxlength="50">
</div>
<div class="form-group">
<label class="label">Sala</label>
<select class="input" id="roomSelect">
<option value="">Seleccionar sala...</option>
</select>
</div>
<button class="btn primary" onclick="updateUser()">Actualizar</button>
<button class="btn warning" onclick="showAdminLogin()" id="adminLoginBtn">🔒 Admin</button>
<div id="adminPanel" style="display:none">
<hr style="margin:12px 0;border:none;border-top:1px solid #e5e7eb">
<h4 style="margin-bottom:8px;color:#374151">Administración</h4>
<div class="form-group">
<label class="label">Usuario a silenciar</label>
<input type="text" class="input" id="muteUser" placeholder="ID del usuario">
</div>
<div class="form-group">
<label class="label">Duración (min)</label>
<input type="number" class="input" id="muteTime" value="10">
</div>
<button class="btn warning" onclick="muteUser()">Silenciar</button>
<div class="form-group">
<label class="label">Promover a moderador</label>
<input type="text" class="input" id="promoteUser" placeholder="ID del usuario">
</div>
<button class="btn primary" onclick="promoteUser()">Promover</button>
<div class="form-group">
<label class="label">Degradar moderador</label>
<input type="text" class="input" id="demoteUser" placeholder="ID del usuario">
</div>
<button class="btn danger" onclick="demoteUser()">Degradar</button>
<button class="btn primary" onclick="showModerators()">👥 Ver Moderadores</button>
<div id="modList" class="mod-list" style="display:none"></div>
<hr style="margin:12px 0;border:none;border-top:1px solid #e5e7eb">        
<button class="btn success" onclick="showCreateRoom()">Nueva Sala</button>
<button class="btn warning" onclick="showArchives()">📂 Archivos</button>
<hr style="margin:12px 0;border:none;border-top:1px solid #e5e7eb">
<div class="form-group">
<label class="label">Sala a eliminar</label>
<input type="text" class="input" id="delRoom" placeholder="Nombre de la sala">
</div>
<button class="btn danger" onclick="delRoom()">Eliminar Sala</button>
<button class="btn warning" onclick="cleanupAllRooms()">🧹 Limpiar Todo</button>
</div>
<button class="btn" onclick="closeModal('settingsModal')">Cerrar</button>
</div>
</div>

<div class="modal" id="createRoomModal">
<div class="modal-content">
<h3>Nueva Sala</h3>
<div class="form-group">
<label class="label">Nombre de la sala</label>
<input type="text" class="input" id="newRoomName" placeholder="Nombre" maxlength="30">
</div>
<button class="btn success" onclick="createRoom()">Crear</button>
<button class="btn" onclick="closeModal('createRoomModal')">Cancelar</button>
</div>
</div>

<div class="modal" id="archiveModal">
<div class="modal-content">
<h3>📂 Archivos</h3>
<div class="form-group">
<label class="label">Seleccionar sala</label>
<select class="input" id="archiveRoomSelect">
<option value="">Seleccionar sala...</option>
</select>
</div>
<div id="archiveList" class="archive-list"></div>
<button class="btn" onclick="closeModal('archiveModal')">Cerrar</button>
</div>
</div>

<div class="modal" id="archiveViewModal">
<div class="modal-content">
<h3 id="archiveTitle">Archivo</h3>
<div id="archiveMessages" style="max-height:250px;overflow-y:auto;padding:8px;background:#f8f9fa;border-radius:4px;font-size:10px"></div>
<button class="btn" onclick="closeModal('archiveViewModal')">Cerrar</button>
</div>
</div>

<div class="modal" id="adminLoginModal">
<div class="modal-content">
<h3>🔒 Acceso Admin</h3>
<div class="form-group">
<label class="label">Contraseña</label>
<input type="password" class="input" id="adminPass" placeholder="Contraseña de admin">
</div>
<button class="btn primary" onclick="adminLogin()">Entrar</button>
<button class="btn" onclick="closeModal('adminLoginModal')">Cancelar</button>
</div>
</div>

<script src="./game.js"></script>

<script>
// Chat Integration JavaScript
const API = 'https://chat.minigeo.org';
const adjectives = ['Genial','Increible','Fantastico','Brillante','Magnifico','Excelente','Asombroso','Estupendo','Maravilloso','Espectacular','Fabuloso','Sensacional','Extraordinario','Fenomenal','Impresionante','Sorprendente','Radiante','Vibrante','Dinamico','Energico','Creativo','Innovador','Inspirador','Optimista','Positivo','Alegre','Divertido','Encantador','Carismatico','Inteligente'];

let u = {id: genId(), name: generateRandomName(), isMod: false, isAdmin: false, token: ''};
let cr = null, rooms = [], msgs = [], poll = null, lastMsg = null, conn = false, retry = 0, pendingMsgs = new Map();
const MAX_RETRY = 5, POLL_INT = 3000, RETRY_DELAY = 5000;

// Initialize chat when game starts
function initializeChat() {
    showLoad(true);
    loadUser().then(() => {
        setupChatEvents();
        return loadRooms();
    }).then(() => {
        if (rooms.length === 0) {
            showNotif('No hay salas disponibles. Contacta al administrador.', 'warning');
        } else {
            return autoJoinMain();
        }
        return testConn();
    }).then(() => {
        startPoll();
        updateStat('online');
        retry = 0;
        document.getElementById('chatContainer').classList.add('visible');
    }).catch(e => {
        console.error(e);
        updateStat('offline');
        scheduleRetry();
    }).finally(() => {
        showLoad(false);
    });
}

function generateRandomName() {
    const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
    const num = String(Math.floor(Math.random() * 90) + 10);
    return `${adj}${num}`;
}

function genId() {
    const t = Date.now().toString(36), r = Math.random().toString(36).substr(2, 9);
    return `user_${t}_${r}`.substr(0, 24);
}

function genTempId() {
    return `temp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
}

async function loadUser() {
    const s = localStorage.getItem('minigeoUser');
    if (s) {
        try {
            const p = JSON.parse(s);
            u = {...u, ...p};
            if (!u.name) u.name = generateRandomName();
        } catch (e) {
            localStorage.removeItem('minigeoUser');
            u.name = generateRandomName();
        }
    } else {
        u.name = generateRandomName();
    }
    document.getElementById('userName').value = u.name || '';
    updateUIFromUser();
}

function saveUser() {
    localStorage.setItem('minigeoUser', JSON.stringify(u));
}

async function tryJoinMain() {
    try {
        const mainRoom = rooms.find(room => room.name === 'mainroom');
        if (mainRoom) {
            await joinRoom('mainroom');
        } else {
            console.log('Sala main no encontrada');
            document.getElementById('msgs').innerHTML = '<div class="empty">Selecciona una sala en ⚙ para comenzar</div>';
        }
    } catch (e) {
        console.error('No se pudo unir a main:', e);
        document.getElementById('msgs').innerHTML = '<div class="empty">Selecciona una sala en ⚙ para comenzar</div>';
    }
}

function updateUIFromUser() {
    if (u.isMod || u.isAdmin) {
        document.getElementById('adminPanel').style.display = 'block';
        document.getElementById('adminLoginBtn').style.display = 'none';
    }
}

async function autoJoinMain() {
    try {
        await joinRoom('mainroom');
    } catch (e) {
        console.error('No se pudo unir a main:', e);
    }
}

function setupChatEvents() {
    const inp = document.getElementById('inp');
    inp.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMsg();
        }
    });
    
    inp.addEventListener('input', e => {
        e.target.style.height = 'auto';
        e.target.style.height = Math.min(e.target.scrollHeight, 48) + 'px';
    });
    
    document.getElementById('newRoomName').addEventListener('keypress', e => {
        if (e.key === 'Enter') {
            e.preventDefault();
            createRoom();
        }
    });
    
    document.getElementById('adminPass').addEventListener('keypress', e => {
        if (e.key === 'Enter') {
            e.preventDefault();
            adminLogin();
        }
    });
}

async function testConn() {
    try {
        const r = await fetchTo(`${API}/api/health`, {}, 5000);
        if (r.ok) {
            conn = true;
            return true;
        }
    } catch (e) {
        console.error(e);
    }
    conn = false;
    return false;
}

function scheduleRetry() {
    if (retry < MAX_RETRY) {
        retry++;
        setTimeout(async () => {
            updateStat('connecting');
            if (await testConn()) {
                updateStat('online');
                retry = 0;
                if (!poll) startPoll();
            } else {
                updateStat('offline');
                scheduleRetry();
            }
        }, RETRY_DELAY * retry);
    } else {
        updateStat('offline');
        showNotif('Sin conexión', 'error');
    }
}

async function fetchTo(url, opt = {}, timeout = 10000) {
    const ctrl = new AbortController();
    const id = setTimeout(() => ctrl.abort(), timeout);
    try {
        const headers = opt.headers || {};
        if (u.token) headers.Authorization = `Bearer ${u.token}`;
        const r = await fetch(url, {...opt, headers, signal: ctrl.signal});
        clearTimeout(id);
        return r;
    } catch (e) {
        clearTimeout(id);
        throw e;
    }
}

function showAdminLogin() {
    document.getElementById('adminLoginModal').classList.add('show');
}

async function showSettings() {
    if (rooms.length === 0) await loadRooms();
    const modal = document.getElementById('settingsModal');
    const select = document.getElementById('roomSelect');
    select.innerHTML = '<option value="">Seleccionar sala...</option>';
    rooms.forEach(room => {
        const option = document.createElement('option');
        option.value = room.name;
        option.textContent = room.displayName || room.name;
        if (room.name === cr) option.selected = true;
        select.appendChild(option);
    });
    select.onchange = () => {
        if (select.value) joinRoom(select.value);
    };
    modal.classList.add('show');
}

function showCreateRoom() {
    closeModal('settingsModal');
    document.getElementById('createRoomModal').classList.add('show');
}

async function updateUser() {
    const name = document.getElementById('userName').value.trim();
    if (!name) {
        showNotif('Ingresa un nombre', 'error');
        return;
    }
    if (name.length < 2) {
        showNotif('Nombre muy corto', 'error');
        return;
    }
    try {
        const r = await fetchTo(`${API}/api/users`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({userId: u.id, name})
        });
        const d = await r.json();
        if (r.ok) {
            u.name = name;
            if (d.user && d.user.isMod !== undefined) u.isMod = d.user.isMod;
            if (d.user && d.user.isAdmin !== undefined) u.isAdmin = d.user.isAdmin;
            saveUser();
            updateUIFromUser();
            showNotif('Actualizado', 'success');
        } else throw new Error(d.error || 'Error al actualizar');
    } catch (e) {
        console.error(e);
        showNotif('Error al actualizar', 'error');
    }
}

async function adminLogin() {
    const pass = document.getElementById('adminPass').value;
    if (!pass) return;
    try {
        const r = await fetchTo(`${API}/api/admin-login`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({password: pass})
        });
        const d = await r.json();
        if (r.ok) {
            u.isAdmin = true;
            u.isMod = true;
            u.token = d.token;
            saveUser();
            updateUIFromUser();
            closeModal('adminLoginModal');
            showNotif('Acceso admin concedido', 'success');
        } else {
            throw new Error(d.error || 'Contraseña incorrecta');
        }
    } catch (e) {
        console.error(e);
        showNotif('Contraseña incorrecta', 'error');
    }
}

async function loadRooms() {
    try {
        const r = await fetchTo(`${API}/api/rooms`);
        const d = await r.json();
        if (r.ok) {
            rooms = d.rooms || [];
        } else throw new Error(d.error || 'Error cargando salas');
    } catch (e) {
        console.error(e);
    }
}

async function createRoom() {
    const name = document.getElementById('newRoomName').value.trim();
    if (!name || name.length < 2) {
        showNotif('Nombre inválido', 'error');
        return;
    }
    try {
        const r = await fetchTo(`${API}/api/rooms`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({roomName: name, createdBy: u.name || 'Anónimo'})
        });
        const d = await r.json();
        if (r.ok) {
            document.getElementById('newRoomName').value = '';
            closeModal('createRoomModal');
            await loadRooms();
            await joinRoom(d.roomName || name);
            showNotif('Sala creada', 'success');
        } else throw new Error(d.error || 'Error creando sala');
    } catch (e) {
        console.error(e);
        showNotif('Error al crear', 'error');
    }
}

async function joinRoom(name) {
    if (cr === name) return;
    if (!u.name) {
        showNotif('Configura tu nombre primero', 'error');
        return;
    }
    showLoad(true);
    try {
        if (cr) await leaveRoom(cr);
        const r = await fetchTo(`${API}/api/join-room`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({userId: u.id, roomName: name, userName: u.name})
        });
        const d = await r.json();
        if (r.ok) {
            cr = name;
            const room = rooms.find(r => r.name === name);
            document.getElementById('room-name').textContent = room?.displayName || name;
            document.getElementById('inp').disabled = false;
            document.getElementById('send-btn').disabled = false;
            clearMsgs();
            await loadMsgs();
            showNotif(`Unido a ${room?.displayName || name}`, 'success');
        } else throw new Error(d.error || 'Error al unirse');
    } catch (e) {
        console.error(e);
        showNotif('Error al unirse', 'error');
    } finally {
        showLoad(false);
    }
}

async function leaveRoom(name) {
    try {
        await fetchTo(`${API}/api/leave-room`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({userId: u.id, roomName: name})
        });
    } catch (e) {
        console.error(e);
    }
}

async function loadMsgs() {
    if (!cr || !conn) return;
    try {
        let url = `${API}/api/messages?room=${cr}&limit=30&userId=${u.id}`;
        if (lastMsg) url += `&since=${lastMsg}`;
        const r = await fetchTo(url, {}, 5000);
        const d = await r.json();
        if (r.ok && d.messages) {
            if (d.messages.length > 0) {
                addMsgs(d.messages);
                lastMsg = d.messages[d.messages.length - 1].timestamp;
            }
            if (!conn) {
                conn = true;
                updateStat('online');
                retry = 0;
            }
        } else throw new Error(d.error || 'Error cargando mensajes');
    } catch (e) {
        console.error(e);
        if (conn) {
            conn = false;
            updateStat('offline');
            scheduleRetry();
        }
    }
}

function addMsgs(newMsgs) {
    const had = msgs.length > 0;
    newMsgs.forEach(m => {
        const existingIndex = msgs.findIndex(x => x.id === m.id);
        if (existingIndex !== -1) {
            msgs[existingIndex] = m;
        } else {
            const pendingIndex = msgs.findIndex(x => x.tempId && pendingMsgs.has(x.tempId));
            if (pendingIndex !== -1 && msgs[pendingIndex].message === m.message && msgs[pendingIndex].userId === m.userId) {
                pendingMsgs.delete(msgs[pendingIndex].tempId);
                msgs[pendingIndex] = m;
            } else {
                msgs.push(m);
            }
        }
    });
    if (msgs.length > 100) msgs = msgs.slice(-100);
    renderMsgs();
    const cont = document.getElementById('msgs');
    if (!had || (cont.scrollTop + cont.clientHeight >= cont.scrollHeight - 50)) scrollBot();
}

function clearMsgs() {
    msgs = [];
    lastMsg = null;
    pendingMsgs.clear();
    renderMsgs();
}

function renderMsgs() {
    const cont = document.getElementById('msgs');
    if (!msgs.length) {
        if (cr) {
            cont.innerHTML = '<div class="empty">Cargando mensajes...</div>';
        } else {
            cont.innerHTML = '<div class="empty">Selecciona una sala en ⚙ para comenzar</div>';
        }
        return;
    }
    cont.innerHTML = '';
    msgs.forEach(m => {
        const div = document.createElement('div');
        let classes = `msg ${m.userId === u.id ? 'own' : ''}`;
        if (m.isAdmin) classes += ' admin';
        else if (m.isMod) classes += ' mod';
        if (m.pending) classes += ' pending';
        if (m.error) classes += ' error';
        div.className = classes;
        
        const time = new Date(m.timestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
        let badges = '';
        if (m.isAdmin) badges = '<span class="badge admin">A</span>';
        else if (m.isMod) badges = '<span class="badge mod">M</span>';
        
        let modBtns = '';
        if (m.userId !== u.id && (u.isMod || u.isAdmin) && !m.pending) {
            modBtns = `<div class="mod-btns"><button class="mod-btn mute" onclick="quickMute('${m.userId}')">M</button><button class="mod-btn" onclick="kickUser('${m.userId}')">K</button></div>`;
        }
        
        let voteBtns = '';
        if (!m.pending) {
            const score = (m.karma?.up || 0) - (m.karma?.down || 0);
            const isOwn = m.userId === u.id;
            if (isOwn) {
                voteBtns = `<div class="vote-btns"><span class="vote-score">${score > 0 ? '+' : ''}${score}</span></div>`;
            } else {
                const upClass = m.userVote === 'up' ? 'active' : '';
                const downClass = m.userVote === 'down' ? 'active' : '';
                voteBtns = `<div class="vote-btns"><button class="vote-btn up ${upClass}" onclick="vote('${m.id}','up')">👍</button><span class="vote-score">${score > 0 ? '+' : ''}${score}</span><button class="vote-btn down ${downClass}" onclick="vote('${m.id}','down')">👎</button></div>`;
            }
        }
        
        let statusIcon = '';
        if (m.pending) statusIcon = '<span style="color:#f59e0b;font-size:8px"> ⏳</span>';
        if (m.error) statusIcon = '<span style="color:#ef4444;font-size:8px"> ❌</span>';
        
        div.innerHTML = `<div class="mhdr"><span class="user">${esc(m.userName || 'Usuario')}${badges}${statusIcon}${voteBtns}</span><span class="time">${time}</span></div><div class="txt">${esc(m.message || '')}</div>${modBtns}`;
        cont.appendChild(div);
    });
}

async function vote(messageId, voteType) {
    if (!cr || !u.id) return;
    const msg = msgs.find(m => m.id === messageId);
    if (!msg || msg.pending || msg.userId === u.id) return;
    
    const prevVote = msg.userVote;
    const newVote = prevVote === voteType ? null : voteType;
    
    const originalKarma = {...msg.karma};
    const originalUserVote = msg.userVote;
    
    msg.karma = msg.karma || {up: 0, down: 0};
    if (prevVote === 'up') msg.karma.up = Math.max(0, (msg.karma.up || 0) - 1);
    if (prevVote === 'down') msg.karma.down = Math.max(0, (msg.karma.down || 0) - 1);
    if (newVote === 'up') msg.karma.up = (msg.karma.up || 0) + 1;
    if (newVote === 'down') msg.karma.down = (msg.karma.down || 0) + 1;
    msg.userVote = newVote;
    
    renderMsgs();
    
    try {
        const r = await fetchTo(`${API}/api/vote`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({messageId, roomName: cr, vote: newVote, userId: u.id})
        });
        const d = await r.json();
        if (r.ok) {
            const msgIndex = msgs.findIndex(m => m.id === messageId);
            if (msgIndex !== -1) {
                msgs[msgIndex].karma = d.karma || {};
                msgs[msgIndex].userVote = d.userVote;
                renderMsgs();
            }
        } else {
            throw new Error(d.error || 'Error al votar');
        }
    } catch (e) {
        console.error(e);
        const msgIndex = msgs.findIndex(m => m.id === messageId);
        if (msgIndex !== -1) {
            msgs[msgIndex].karma = originalKarma;
            msgs[msgIndex].userVote = originalUserVote;
            renderMsgs();
        }
        showNotif('Error al votar', 'error');
    }
}

async function sendMsg() {
    const inp = document.getElementById('inp');
    const msg = inp.value.trim();
    if (!msg || !cr || !u.name) return;
    if (msg.length > 1000) {
        showNotif('Mensaje muy largo', 'error');
        return;
    }
    
    const btn = document.getElementById('send-btn');
    btn.disabled = true;
    
    const tempId = genTempId();
    const tempMsg = {
        id: tempId,
        tempId,
        message: msg,
        userId: u.id,
        userName: u.name,
        timestamp: new Date().toISOString(),
        pending: true,
        isAdmin: u.isAdmin,
        isMod: u.isMod,
        karma: {up: 0, down: 0}
    };
    
    msgs.push(tempMsg);
    pendingMsgs.set(tempId, tempMsg);
    inp.value = '';
    inp.style.height = 'auto';
    renderMsgs();
    scrollBot();
    
    try {
        const r = await fetchTo(`${API}/api/messages`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({roomName: cr, userId: u.id, userName: u.name, message: msg})
        });
        
        if (r.ok) {
            const d = await r.json();
            if (d.message) {
                const msgIndex = msgs.findIndex(m => m.tempId === tempId);
                if (msgIndex !== -1) {
                    pendingMsgs.delete(tempId);
                    msgs[msgIndex] = {...d.message, tempId: undefined, pending: false};
                    renderMsgs();
                }
            }
        } else {
            const d = await r.json();
            throw new Error(d.error || 'Error al enviar');
        }
    } catch (e) {
        console.error(e);
        const msgIndex = msgs.findIndex(m => m.tempId === tempId);
        if (msgIndex !== -1) {
            msgs[msgIndex].error = true;
            msgs[msgIndex].pending = false;
            renderMsgs();
        }
        showNotif('Error al enviar', 'error');
    } finally {
        btn.disabled = false;
    }
}

async function muteUser() {
    const userId = document.getElementById('muteUser').value.trim();
    const time = parseInt(document.getElementById('muteTime').value);
    if (!userId || !time) {
        showNotif('Completa todos los campos', 'error');
        return;
    }
    try {
        const r = await fetchTo(`${API}/api/moderate`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({action: 'mute', userId, duration: time, moderatorId: u.id})
        });
        const d = await r.json();
        if (r.ok) {
            showNotif('Usuario silenciado', 'success');
            document.getElementById('muteUser').value = '';
        } else {
            throw new Error(d.error || 'Error al silenciar');
        }
    } catch (e) {
        console.error(e);
        showNotif('Error al silenciar', 'error');
    }
}

async function promoteUser() {
    const userId = document.getElementById('promoteUser').value.trim();
    if (!userId) {
        showNotif('Ingresa ID de usuario', 'error');
        return;
    }
    try {
        const r = await fetchTo(`${API}/api/promote-user`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({userId, adminId: u.id})
        });
        const d = await r.json();
        if (r.ok) {
            showNotif('Usuario promovido', 'success');
            document.getElementById('promoteUser').value = '';
        } else {
            throw new Error(d.error || 'Error al promover');
        }
    } catch (e) {
        console.error(e);
        showNotif('Error al promover', 'error');
    }
}

async function demoteUser() {
    const userId = document.getElementById('demoteUser').value.trim();
    if (!userId) {
        showNotif('Ingresa ID de usuario', 'error');
        return;
    }
    try {
        const r = await fetchTo(`${API}/api/demote-user`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({userId, adminId: u.id})
        });
        const d = await r.json();
        if (r.ok) {
            showNotif('Usuario degradado', 'success');
            document.getElementById('demoteUser').value = '';
        } else {
            throw new Error(d.error || 'Error al degradar');
        }
    } catch (e) {
        console.error(e);
        showNotif('Error al degradar', 'error');
    }
}

async function showModerators() {
    const modList = document.getElementById('modList');
    try {
        const r = await fetchTo(`${API}/api/moderators`);
        const d = await r.json();
        if (r.ok) {
            modList.innerHTML = '';
            if (d.moderators && d.moderators.length > 0) {
                d.moderators.forEach(modId => {
                    const div = document.createElement('div');
                    div.className = 'mod-item';
                    div.innerHTML = `<span>${modId}</span><button class="btn danger" style="padding:2px 6px;font-size:10px" onclick="demoteUserDirect('${modId}')">X</button>`;
                    modList.appendChild(div);
                });
            } else {
                modList.innerHTML = '<div style="text-align:center;color:#666;padding:8px">No hay moderadores</div>';
            }
            modList.style.display = 'block';
        } else {
            throw new Error(d.error || 'Error al cargar');
        }
    } catch (e) {
        console.error(e);
        showNotif('Error al cargar moderadores', 'error');
    }
}

async function demoteUserDirect(userId) {
    if (!confirm(`¿Degradar a ${userId}?`)) return;
    try {
        const r = await fetchTo(`${API}/api/demote-user`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({userId, adminId: u.id})
        });
        const d = await r.json();
        if (r.ok) {
            showNotif('Usuario degradado', 'success');
            showModerators();
        } else {
            throw new Error(d.error || 'Error al degradar');
        }
    } catch (e) {
        console.error(e);
        showNotif('Error al degradar', 'error');
    }
}

async function delRoom() {
    const name = document.getElementById('delRoom').value.trim();
    if (!name) {
        showNotif('Ingresa nombre de sala', 'error');
        return;
    }
    if (!confirm(`¿Eliminar sala "${name}"?`)) return;
    try {
        const r = await fetchTo(`${API}/api/rooms/${encodeURIComponent(name)}`, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({moderatorId: u.id})
        });
        const d = await r.json();
        if (r.ok) {
            showNotif('Sala eliminada', 'success');
            document.getElementById('delRoom').value = '';
            await loadRooms();
            if (cr === name) {
                cr = null;
                document.getElementById('room-name').textContent = 'MiniGeo Chat';
                document.getElementById('inp').disabled = true;
                document.getElementById('send-btn').disabled = true;
                clearMsgs();
            }
        } else {
            throw new Error(d.error || 'Error al eliminar');
        }
    } catch (e) {
        console.error(e);
        showNotif('Error al eliminar', 'error');
    }
}

async function cleanupAllRooms() {
    if (!confirm('¿Archivar todos los mensajes y limpiar salas?')) return;
    if (!u.isAdmin || !u.adminKey) {
        showNotif('Solo administradores pueden realizar esta acción', 'error');
        return;
    }
    try {
        const r = await fetchTo(`${API}/api/cleanup`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({adminKey: u.adminKey})
        });
        const d = await r.json();
        if (r.ok) {
            showNotif('Limpieza completada', 'success');
            clearMsgs();
            await loadMsgs();
        } else {
            throw new Error(d.error || 'Error en limpieza');
        }
    } catch (e) {
        console.error(e);
        showNotif('Error en limpieza', 'error');
    }
}

async function quickMute(userId) {
    if (!confirm('¿Silenciar usuario por 10 min?')) return;
    try {
        const r = await fetchTo(`${API}/api/moderate`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({action: 'mute', userId, duration: 10, moderatorId: u.id})
        });
        const d = await r.json();
        if (r.ok) showNotif('Usuario silenciado', 'success');
        else showNotif(d.error || 'Error al silenciar', 'error');
    } catch (e) {
        console.error(e);
        showNotif('Error', 'error');
    }
}

async function kickUser(userId) {
    if (!confirm('¿Expulsar usuario de la sala?')) return;
    try {
        const r = await fetchTo(`${API}/api/moderate`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({action: 'kick', userId, roomName: cr, moderatorId: u.id})
        });
        const d = await r.json();
        if (r.ok) showNotif('Usuario expulsado', 'success');
        else showNotif(d.error || 'Error al expulsar', 'error');
    } catch (e) {
        console.error(e);
        showNotif('Error', 'error');
    }
}

async function showArchives() {
    if (rooms.length === 0) await loadRooms();
    const modal = document.getElementById('archiveModal');
    const select = document.getElementById('archiveRoomSelect');
    select.innerHTML = '<option value="">Seleccionar sala...</option>';
    rooms.forEach(room => {
        const option = document.createElement('option');
        option.value = room.name;
        option.textContent = room.displayName || room.name;
        select.appendChild(option);
    });
    select.onchange = async () => {
        if (select.value) await loadArchiveList(select.value);
    };
    modal.classList.add('show');
}

async function loadArchiveList(roomName) {
    const container = document.getElementById('archiveList');
    container.innerHTML = '<div style="text-align:center;padding:16px;color:#666">Cargando...</div>';
    try {
        const r = await fetchTo(`${API}/api/archive?room=${encodeURIComponent(roomName)}`);
        const d = await r.json();
        if (r.ok && d.archives && d.archives.length > 0) {
            container.innerHTML = '';
            d.archives.forEach(archive => {
                const div = document.createElement('div');
                div.className = 'archive-item';
                div.innerHTML = `<div style="font-weight:500">${new Date(archive.archivedAt).toLocaleDateString()}</div><div style="font-size:10px;color:#666">${archive.messageCount || 0} mensajes</div>`;
                div.onclick = () => viewArchive(archive.key, roomName);
                container.appendChild(div);
            });
        } else {
            container.innerHTML = '<p style="text-align:center;color:#666;padding:16px">Sin archivos</p>';
        }
    } catch (e) {
        console.error('Error cargando archivos:', e);
        container.innerHTML = '<p style="text-align:center;color:#ef4444;padding:16px">Error al cargar</p>';
    }
}

async function viewArchive(archiveKey, roomName) {
    if (!archiveKey || !roomName) {
        showNotif('Error: datos de archivo inválidos', 'error');
        return;
    }
    try {
        const r = await fetchTo(`${API}/api/archive?room=${encodeURIComponent(roomName)}&id=${encodeURIComponent(archiveKey)}`);
        const d = await r.json();
        if (r.ok && d.archive && d.archive.messages) {
            const modal = document.getElementById('archiveViewModal');
            const title = document.getElementById('archiveTitle');
            const container = document.getElementById('archiveMessages');
            
            title.textContent = `${roomName} - ${new Date(d.archive.archivedAt).toLocaleDateString()}`;
            container.innerHTML = '';
            
            if (d.archive.messages.length > 0) {
                d.archive.messages.forEach(m => {
                    const div = document.createElement('div');
                    div.style.cssText = 'margin-bottom:8px;padding:6px;background:#fff;border-radius:4px;border-left:2px solid #3b82f6';
                    const score = (m.karma?.up || 0) - (m.karma?.down || 0);
                    div.innerHTML = `<div style="display:flex;justify-content:space-between;margin-bottom:4px"><strong>${esc(m.userName || 'Usuario')}</strong><small>${new Date(m.timestamp).toLocaleString()}</small></div><div style="margin-bottom:4px">${esc(m.message || '')}</div><div style="font-size:9px;color:#666">Karma: ${score > 0 ? '+' : ''}${score}</div>`;
                    container.appendChild(div);
                });
            } else {
                container.innerHTML = '<p style="text-align:center;color:#666;padding:16px">No hay mensajes en este archivo</p>';
            }
            
            closeModal('archiveModal');
            modal.classList.add('show');
        } else {
            throw new Error(d.error || 'Archivo no encontrado');
        }
    } catch (e) {
        console.error('Error viendo archivo:', e);
        showNotif('Error al cargar archivo', 'error');
    }
}

function startPoll() {
    if (poll) clearInterval(poll);
    poll = setInterval(pollMsgs, POLL_INT);
}

async function pollMsgs() {
    if (cr) await loadMsgs();
}

function updateStat(stat) {
    const el = document.getElementById('status');
    el.className = `status ${stat}`;
    conn = stat === 'online';
}

function esc(txt) {
    if (!txt) return '';
    const div = document.createElement('div');
    div.textContent = txt;
    return div.innerHTML;
}

function showNotif(msg, type = 'success') {
    document.querySelectorAll('.notif').forEach(el => el.remove());
    const n = document.createElement('div');
    n.className = `notif ${type}`;
    n.textContent = msg;
    document.body.appendChild(n);
    setTimeout(() => n.remove(), 3000);
}

function showLoad(show) {
    document.getElementById('load').classList.toggle('show', show);
}

function scrollBot() {
    const cont = document.getElementById('msgs');
    cont.scrollTop = cont.scrollHeight;
}

function closeModal(id) {
    document.getElementById(id).classList.remove('show');
}

// Override the original game start button to initialize chat
document.addEventListener('DOMContentLoaded', function() {
    const originalStartButton = document.getElementById('startButton');
    if (originalStartButton) {
        originalStartButton.addEventListener('click', function() {
            // Initialize chat after a small delay to let the game start
            setTimeout(initializeChat, 1000);
        });
    }
});

window.addEventListener('beforeunload', () => {
    if (poll) clearInterval(poll);
    if (cr) navigator.sendBeacon(`${API}/api/leave-room`, JSON.stringify({userId: u.id, roomName: cr}));
});
</script>

</body></html>