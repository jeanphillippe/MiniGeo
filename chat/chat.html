<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>MiniGeo Chat</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,sans-serif;background:#f5f7fa;min-height:100vh;display:flex;flex-direction:column}.hdr{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:1rem;display:flex;justify-content:space-between;align-items:center}.hdr h1{font-size:1.5rem}.back{color:#fff;text-decoration:none;padding:.5rem 1rem;border:2px solid rgba(255,255,255,.3);border-radius:8px}.back:hover{background:rgba(255,255,255,.2)}.app{flex:1;display:flex;max-width:1200px;margin:2rem auto;background:#fff;border-radius:16px;box-shadow:0 8px 32px rgba(0,0,0,.1);overflow:hidden;height:calc(100vh - 120px)}.side{width:320px;background:#2c3e50;color:#fff;display:flex;flex-direction:column}.user{padding:1.5rem;border-bottom:1px solid #34495e;background:#34495e}.user h3{margin-bottom:1rem}.inp{margin-bottom:.75rem}.inp label{display:block;margin-bottom:.25rem;font-size:.85rem;color:#bdc3c7}.ui{width:100%;padding:.75rem;border:none;border-radius:8px;background:#2c3e50;color:#fff;border:2px solid transparent}.ui:focus{outline:none;border-color:#3498db;background:#1a252f}.btn{padding:.75rem 1rem;border:none;border-radius:8px;cursor:pointer;font-weight:600;width:100%;margin-top:.5rem}.bp{background:#3498db;color:#fff}.bp:hover:not(:disabled){background:#2980b9}.bs{background:#27ae60;color:#fff}.bs:hover:not(:disabled){background:#229954}.br{background:#e74c3c;color:#fff}.br:hover:not(:disabled){background:#c0392b}.btn:disabled{opacity:.6;cursor:not-allowed}.rooms{padding:1.5rem;flex:1;overflow-y:auto}.rhdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}.rhdr h4{font-size:1rem}.ref{background:none;border:none;color:#95a5a6;cursor:pointer;padding:.5rem;border-radius:6px}.ref:hover{color:#ecf0f1;background:#34495e}.rl{list-style:none;margin-bottom:1rem}.ri{padding:.75rem;margin:.5rem 0;background:#34495e;border-radius:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}.ri:hover{background:#3498db}.ri.active{background:#27ae60}.rn{font-weight:500}.ru{font-size:.75rem;color:#bdc3c7;background:rgba(0,0,0,.2);padding:.25rem .5rem;border-radius:12px}.cr{padding:1.5rem;border-top:1px solid #34495e;background:#34495e}.main{flex:1;display:flex;flex-direction:column}.chdr{padding:1.5rem;background:#ecf0f1;border-bottom:1px solid #bdc3c7;display:flex;justify-content:space-between;align-items:center}.chdr h2{color:#2c3e50;font-size:1.3rem}.stat{padding:.5rem 1rem;border-radius:20px;font-size:.8rem;font-weight:600;text-transform:uppercase}.stat.online{background:#d5f4e6;color:#27ae60}.stat.offline{background:#fadbd8;color:#e74c3c}.stat.connecting{background:#fef9e7;color:#f39c12}.msgs{flex:1;padding:1.5rem;overflow-y:auto;background:#f8f9fa}.msg{margin-bottom:1rem;padding:1rem;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.1);max-width:80%}.msg.own{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;margin-left:auto}.mhdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}.mu{font-weight:600;color:#2c3e50;font-size:.9rem}.mt{font-size:.75rem;color:#7f8c8d}.mc{color:#2c3e50;line-height:1.5;word-wrap:break-word}.msg.own .mu,.msg.own .mc{color:#fff}.msg.own .mt{color:rgba(255,255,255,.7)}.minp{padding:1.5rem;background:#fff;border-top:1px solid #ecf0f1;display:flex;gap:1rem;align-items:flex-end}.mi{flex:1;padding:1rem;border:2px solid #ecf0f1;border-radius:20px;resize:none;min-height:50px;max-height:120px;font-family:inherit}.mi:focus{outline:none;border-color:#3498db}.send{padding:1rem 1.5rem;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:20px;cursor:pointer;font-weight:600}.send:hover:not(:disabled){box-shadow:0 4px 12px rgba(102,126,234,.4)}.send:disabled{background:#bdc3c7;cursor:not-allowed}.notif{position:fixed;top:2rem;right:2rem;padding:1rem 1.5rem;border-radius:12px;color:#fff;font-weight:600;z-index:1000;max-width:320px}.notif.success{background:#27ae60}.notif.error{background:#e74c3c}.empty{text-align:center;color:#7f8c8d;padding:3rem 2rem}.empty h3{color:#2c3e50;margin-bottom:1rem}.load{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.95);display:none;justify-content:center;align-items:center;z-index:1000;font-weight:600}.load.show{display:flex}.mod{background:#8e44ad;margin-top:.5rem}.mod:hover:not(:disabled){background:#7d3c98}.vote{display:flex;gap:.5rem;margin-top:.5rem}.vb{padding:.25rem .5rem;border:none;border-radius:4px;cursor:pointer;font-size:.75rem}.vu{background:#27ae60;color:#fff}.vu:hover{background:#229954}.vd{background:#e74c3c;color:#fff}.vd:hover{background:#c0392b}.mbtn{display:flex;gap:.25rem;margin-left:.5rem}.mb{padding:.125rem .25rem;border:none;border-radius:3px;cursor:pointer;font-size:.6rem;color:#fff}.mb.mute{background:#f39c12}.mb.mute:hover{background:#e67e22}.mb.kick{background:#e74c3c}.mb.kick:hover{background:#c0392b}@media(max-width:768px){.app{margin:1rem;height:calc(100vh - 80px);flex-direction:column}.side{width:100%;height:300px}.msg{max-width:90%}.msg.own{margin-left:10%}}</style></head><body><header class="hdr"><h1>üåç MiniGeo</h1><a href="../index.html" class="back">‚Üê Back</a></header><div class="app"><div class="load" id="load"><div>Connecting...</div></div><div class="side"><div class="user"><h3>üë§ Profile</h3><div class="inp"><label>Name</label><input type="text" id="uname" class="ui" placeholder="Your name" maxlength="50"></div><div class="inp"><label>Role</label><input type="text" id="ulabel" class="ui" placeholder="Explorer, Geographer..." maxlength="50"></div><button class="btn bp" id="upd" onclick="updUser()">Update</button><button class="btn mod" id="modBtn" onclick="toggleMod()" style="display:none">Mod Panel</button></div><div class="rooms"><div class="rhdr"><h4>üí¨ Rooms</h4><button class="ref" onclick="loadRooms()">‚ü≥</button></div><ul class="rl" id="rl"></ul></div><div class="cr"><div class="inp"><label>New Room</label><input type="text" id="nroom" class="ui" placeholder="Room name" maxlength="30"></div><button class="btn bs" onclick="createRoom()">Create</button></div></div><div class="main"><div class="chdr"><h2 id="crname">Select a room</h2><div class="stat connecting" id="stat">Connecting</div></div><div class="msgs" id="msgs"><div class="empty"><h3>Welcome! üó∫Ô∏è</h3><p>Select a room to start chatting.</p></div></div><div class="minp"><textarea id="minp" class="mi" placeholder="Type message..." disabled maxlength="1000"></textarea><button class="send" id="send" onclick="sendMsg()" disabled>Send üì§</button></div></div></div><div id="modPanel" style="display:none;position:fixed;top:50px;right:20px;background:#2c3e50;color:#fff;padding:1rem;border-radius:8px;z-index:1001"><h4>Mod Panel</h4><div><input type="text" id="muteUser" placeholder="User ID" style="margin:.5rem 0;padding:.5rem;width:100%"><input type="number" id="muteTime" placeholder="Minutes" style="margin:.5rem 0;padding:.5rem;width:100%"><button onclick="muteUser()" style="padding:.5rem;background:#f39c12;border:none;color:#fff;cursor:pointer">Mute</button></div><div><input type="text" id="delRoom" placeholder="Room name" style="margin:.5rem 0;padding:.5rem;width:100%"><button onclick="delRoom()" style="padding:.5rem;background:#e74c3c;border:none;color:#fff;cursor:pointer">Delete Room</button></div></div><script>const API='https://chat.minigeo.org';let u={id:genId(),name:'',label:'',isMod:!1},cr=null,rooms=[],msgs=[],poll=null,lastMsg=null,conn=!1,retry=0,MAX_RETRY=5;const POLL_INT=3e3,RETRY_DELAY=5e3;document.addEventListener('DOMContentLoaded',async()=>{showLoad(!0);try{await loadUser();setupEvents();const exist=await checkRooms();if(!exist)showSetup();else{await loadRooms();await testConn();startPoll();updateStat('online')}retry=0}catch(e){console.error(e);updateStat('offline');scheduleRetry()}finally{showLoad(!1)}});function genId(){const t=Date.now().toString(36),r=Math.random().toString(36).substr(2,9),b=(navigator.userAgent+navigator.language).split('').reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a&a},0).toString(36);return `user_${t}_${r}_${Math.abs(b)}`.substr(0,32)}async function loadUser(){const s=localStorage.getItem('minigeoUser');if(s){try{const p=JSON.parse(s);u={...u,...p};document.getElementById('uname').value=u.name||'';document.getElementById('ulabel').value=u.label||'';if(u.isMod)document.getElementById('modBtn').style.display='block'}catch(e){localStorage.removeItem('minigeoUser')}}}function saveUser(){try{localStorage.setItem('minigeoUser',JSON.stringify(u))}catch(e){console.error(e)}}function setupEvents(){const mi=document.getElementById('minp');mi.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg()}});mi.addEventListener('input',e=>{e.target.style.height='auto';e.target.style.height=Math.min(e.target.scrollHeight,120)+'px'});document.getElementById('nroom').addEventListener('keypress',e=>{if(e.key==='Enter'){e.preventDefault();createRoom()}});document.addEventListener('visibilitychange',()=>{if(document.hidden){if(poll){clearInterval(poll);poll=setInterval(pollMsgs,POLL_INT*2)}}else{if(poll){clearInterval(poll);poll=setInterval(pollMsgs,POLL_INT)}if(cr)pollMsgs()}})}async function testConn(){try{const r=await fetchTo(`${API}/api/health`,{},5e3);const d=await r.json();if(r.ok){conn=!0;return!0}}catch(e){console.error(e)}conn=!1;return!1}function scheduleRetry(){if(retry<MAX_RETRY){retry++;setTimeout(async()=>{updateStat('connecting');if(await testConn()){updateStat('online');retry=0;if(!poll)startPoll()}else{updateStat('offline');scheduleRetry()}},RETRY_DELAY*retry)}else{updateStat('offline');showNotif('Connection failed','error')}}async function fetchTo(url,opt={},timeout=1e4){const ctrl=new AbortController();const id=setTimeout(()=>ctrl.abort(),timeout);try{const r=await fetch(url,{...opt,signal:ctrl.signal});clearTimeout(id);return r}catch(e){clearTimeout(id);throw e}}async function checkRooms(){try{const r=await fetchTo(`${API}/api/rooms`);const d=await r.json();return r.ok&&d.rooms&&d.rooms.length>0}catch(e){return!1}}function showSetup(){document.getElementById('msgs').innerHTML=`<div class="empty"><h3>üöÄ Setup</h3><p>First time? Create default rooms.</p><button class="btn bp" onclick="initRooms()" style="margin-top:1rem">Create Rooms</button></div>`}async function initRooms(){const btn=document.querySelector('#msgs button');btn.disabled=!0;btn.textContent='Creating...';try{const r=await fetchTo(`${API}/api/initialize-default-rooms`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({adminKey:'minigeo-setup-2024'})});const d=await r.json();if(r.ok){await loadRooms();startPoll();showNotif('Rooms created!','success')}else throw new Error(d.error)}catch(e){console.error(e);showNotif('Error creating rooms','error')}finally{btn.disabled=!1;btn.textContent='Create Rooms'}}async function updUser(){const name=document.getElementById('uname').value.trim(),label=document.getElementById('ulabel').value.trim();if(!name){showNotif('Enter name','error');return}if(name.length<2){showNotif('Name too short','error');return}const btn=document.getElementById('upd');btn.disabled=!0;btn.textContent='Updating...';try{const r=await fetchTo(`${API}/api/users`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:u.id,name,label})});const d=await r.json();if(r.ok){u.name=name;u.label=label;saveUser();showNotif('Updated!','success')}else throw new Error(d.error)}catch(e){console.error(e);showNotif('Update failed','error')}finally{btn.disabled=!1;btn.textContent='Update'}}async function loadRooms(){try{const r=await fetchTo(`${API}/api/rooms`);const d=await r.json();if(r.ok){rooms=d.rooms||[];renderRooms()}else throw new Error(d.error)}catch(e){console.error(e);if(conn)showNotif('Failed to load rooms','error')}}function renderRooms(){const rl=document.getElementById('rl');rl.innerHTML='';if(!rooms.length){rl.innerHTML='<li style="color:#95a5a6;padding:1rem">No rooms</li>';return}rooms.forEach(r=>{const li=document.createElement('li');li.className=`ri ${cr===r.name?'active':''}`;li.innerHTML=`<span class="rn">${(r.displayName||r.name).substring(0,25)}</span><span class="ru">${r.userCount||0}</span>`;li.onclick=()=>joinRoom(r.name,r.displayName);rl.appendChild(li)})}async function createRoom(){const inp=document.getElementById('nroom'),name=inp.value.trim();if(!name||name.length<2){showNotif('Invalid name','error');return}const btn=document.querySelector('.cr .btn');btn.disabled=!0;btn.textContent='Creating...';try{const r=await fetchTo(`${API}/api/rooms`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({roomName:name,createdBy:u.name||'Anonymous'})});const d=await r.json();if(r.ok){inp.value='';await loadRooms();await joinRoom(d.roomName,d.displayName);showNotif('Room created!','success')}else throw new Error(d.error)}catch(e){console.error(e);showNotif('Create failed','error')}finally{btn.disabled=!1;btn.textContent='Create'}}async function joinRoom(name,disp){if(cr===name)return;if(!u.name){showNotif('Set name first','error');return}showLoad(!0);try{if(cr)await leaveRoom(cr);const r=await fetchTo(`${API}/api/join-room`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:u.id,roomName:name,userName:u.name})});const d=await r.json();if(r.ok){cr=name;document.getElementById('crname').textContent=disp||name;document.getElementById('minp').disabled=!1;document.getElementById('send').disabled=!1;clearMsgs();await loadMsgs();renderRooms();showNotif(`Joined ${disp||name}`,'success')}else throw new Error(d.error)}catch(e){console.error(e);showNotif('Join failed','error')}finally{showLoad(!1)}}async function leaveRoom(name){try{await fetchTo(`${API}/api/leave-room`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:u.id,roomName:name})})}catch(e){console.error(e)}}async function loadMsgs(){if(!cr||!conn)return;try{let url=`${API}/api/messages?room=${cr}&limit=50`;if(lastMsg)url+=`&since=${lastMsg}`;const r=await fetchTo(url,{},5e3);const d=await r.json();if(r.ok&&d.messages){if(d.messages.length>0){addMsgs(d.messages);lastMsg=d.messages[d.messages.length-1].timestamp}if(!conn){conn=!0;updateStat('online');retry=0}}else throw new Error(d.error)}catch(e){console.error(e);if(conn){conn=!1;updateStat('offline');scheduleRetry()}}}function addMsgs(newMsgs){const had=msgs.length>0;newMsgs.forEach(m=>{if(!msgs.find(x=>x.id===m.id))msgs.push(m)});if(msgs.length>200)msgs=msgs.slice(-200);renderMsgs();const cont=document.getElementById('msgs');if(!had||(cont.scrollTop+cont.clientHeight>=cont.scrollHeight-100))scrollBot()}function clearMsgs(){msgs=[];lastMsg=null;renderMsgs()}function renderMsgs(){const cont=document.getElementById('msgs');if(!msgs.length){cont.innerHTML=`<div class="empty"><h3>Welcome to ${cr||'Chat'}! üó∫Ô∏è</h3><p>Start the conversation!</p></div>`;return}cont.innerHTML='';msgs.forEach(m=>{const div=document.createElement('div');div.className=`msg ${m.userId===u.id?'own':''}`;const time=new Date(m.timestamp).toLocaleTimeString();let voteBtns='',modBtns='';if(!m.own&&u.isMod){modBtns=`<div class="mbtn"><button class="mb mute" onclick="quickMute('${m.userId}')">M</button><button class="mb kick" onclick="kickUser('${m.userId}')">K</button></div>`}div.innerHTML=`<div class="mhdr"><span class="mu">${esc(m.userName)}</span><div style="display:flex;align-items:center"><span class="mt">${time}</span>${modBtns}</div></div><div class="mc">${esc(m.message)}</div>${voteBtns}`;cont.appendChild(div)})}async function sendMsg(){const inp=document.getElementById('minp'),msg=inp.value.trim();if(!msg||!cr||!u.name)return;if(msg.length>1e3){showNotif('Too long','error');return}const btn=document.getElementById('send');btn.disabled=!0;btn.textContent='Sending...';try{const r=await fetchTo(`${API}/api/messages`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({roomName:cr,userId:u.id,userName:u.name,message:msg})});const d=await r.json();if(r.ok){inp.value='';inp.style.height='auto'}else throw new Error(d.error)}catch(e){console.error(e);showNotif('Send failed','error')}finally{btn.disabled=!1;btn.textContent='Send üì§'}}function startPoll(){if(poll)clearInterval(poll);poll=setInterval(pollMsgs,POLL_INT)}async function pollMsgs(){if(cr)await loadMsgs();await loadRooms()}function updateStat(stat){const el=document.getElementById('stat');const map={online:'Online',offline:'Offline',connecting:'Connecting...'};el.textContent=map[stat]||stat;el.className=`stat ${stat}`;conn=stat==='online'}function esc(txt){const div=document.createElement('div');div.textContent=txt;return div.innerHTML}function showNotif(msg,type='success'){document.querySelectorAll('.notif').forEach(el=>el.remove());const n=document.createElement('div');n.className=`notif ${type}`;n.textContent=msg;document.body.appendChild(n);setTimeout(()=>n.remove(),5e3)}function showLoad(show){document.getElementById('load').classList.toggle('show',show)}function scrollBot(){const cont=document.getElementById('msgs');cont.scrollTop=cont.scrollHeight}function toggleMod(){const panel=document.getElementById('modPanel');panel.style.display=panel.style.display==='none'?'block':'none'}async function muteUser(){const userId=document.getElementById('muteUser').value.trim(),time=parseInt(document.getElementById('muteTime').value);if(!userId||!time){showNotif('Enter user ID and time','error');return}try{const r=await fetchTo(`${API}/api/moderate`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'mute',userId,duration:time,moderatorId:u.id})});const d=await r.json();if(r.ok){showNotif('User muted','success');document.getElementById('muteUser').value='';document.getElementById('muteTime').value=''}else throw new Error(d.error)}catch(e){showNotif('Mute failed','error')}}async function delRoom(){const name=document.getElementById('delRoom').value.trim();if(!name){showNotif('Enter room name','error');return}if(!confirm(`Delete room "${name}"?`))return;try{const r=await fetchTo(`${API}/api/rooms/${name}`,{method:'DELETE',headers:{'Content-Type':'application/json'},body:JSON.stringify({moderatorId:u.id})});const d=await r.json();if(r.ok){showNotif('Room deleted','success');document.getElementById('delRoom').value='';await loadRooms();if(cr===name){cr=null;document.getElementById('crname').textContent='Select a room';clearMsgs()}}else throw new Error(d.error)}catch(e){showNotif('Delete failed','error')}}async function quickMute(userId){if(!confirm('Mute user for 10 minutes?'))return;try{const r=await fetchTo(`${API}/api/moderate`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'mute',userId,duration:10,moderatorId:u.id})});if(r.ok)showNotif('User muted','success');else showNotif('Mute failed','error')}catch(e){showNotif('Error','error')}}async function kickUser(userId){if(!confirm('Kick user from room?'))return;try{const r=await fetchTo(`${API}/api/moderate`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'kick',userId,roomName:cr,moderatorId:u.id})});if(r.ok)showNotif('User kicked','success');else showNotif('Kick failed','error')}catch(e){showNotif('Error','error')}}window.addEventListener('beforeunload',()=>{if(poll)clearInterval(poll);if(cr)navigator.sendBeacon(`${API}/api/leave-room`,JSON.stringify({userId:u.id,roomName:cr}))});</script></body></html>