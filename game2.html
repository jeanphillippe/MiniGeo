<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Isla Historias/Story Island-MiniGEO</title><script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script><script srwc="./debug.js"></script><script src="./camera.js"></script><script src="./terrain.js"></script><script src="./player.js"></script><script src="./npcs.js"></script><script src="./minigames.js"></script><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#2c3e50;overflow:hidden}#gameCanvas{display:block;width:100vw;height:100vh;touch-action:none;cursor:grab}#gameCanvas:active{cursor:grabbing}.ui-container{position:absolute;top:10px;left:10px;z-index:100}.toggle-btn{background:rgb(0 0 0/.8);color:#fff;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;font-size:9px;margin-bottom:5px}.toggle-btn:hover{background:rgb(0 0 0/.9)}.toggle-btn.active{background:#4CAF50}.panel{color:#fff;background:rgb(0 0 0/.8);padding:12px;border-radius:6px;font-size:12px;margin-bottom:5px;min-width:200px;max-width:310px;display:none}.panel.visible{display:block}.panel button{background:#4CAF50;color:#fff;border:none;padding:6px 12px;border-radius:3px;cursor:pointer;font-size:11px;margin:2px}.panel button:hover{background:#45a049}.panel button:disabled{background:#666;cursor:not-allowed}.edit-indicator{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#ff6b6b;font-size:16px;font-weight:700;text-shadow:2px 2px 4px rgb(0 0 0/.8);z-index:99;pointer-events:none;display:none}.edit-indicator.visible{display:block}.controls-text{font-size:10px;color:#ccc;margin-top:8px;line-height:1.3}.tooltip-container{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:auto;z-index:150}.tooltip{background:rgb(0 0 0/.9);color:#fff;padding:8px 12px;border-radius:6px;font-size:14px;font-family:-apple-system,BlinkMacSystemFont,sans-serif;white-space:nowrap;box-shadow:0 2px 8px rgb(0 0 0/.4);border:1px solid rgb(255 255 255/.2);opacity:0;transform:translateY(10px);transition:all 0.3s ease;cursor:pointer}.tooltip:hover{background:rgb(76 175 80/.3);border-color:#4CAF50;transform:translateY(-2px);box-shadow:0 4px 12px rgb(0 0 0/.6)}.tooltip.visible{opacity:1;transform:translateY(0)}.tooltip.interact{border-color:#4CAF50;background:rgb(76 175 80/.2);backdrop-filter:blur(4px)}.interact-prompt{color:#fff;font-weight:700;font-size:12px;margin-top:4px}.sprite-debug-panel{position:relative!important;top:120px;right:20px;background:rgb(0 0 0/.8);color:#fff;padding:10px;border-radius:5px;display:none;min-width:250px}.pip-reference{position:relative;bottom:0;left:0;width:64px;height:64px;border:2px solid #4CAF50;border-radius:5px;background:rgb(0 0 0/.8);z-index:200}.pip-reference.visible{display:block}.pip-reference img{width:100%;height:100%;object-fit:cover;border-radius:3px}.pip-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background-image:linear-gradient(to right,rgb(255 255 255/.3)0,transparent 1px),linear-gradient(to bottom,rgb(255 255 255/.3)0,transparent 1px);background-size:15px 15px;pointer-events:none}.pip-label{position:absolute;bottom:-20px;left:0;right:0;text-align:center;font-size:10px;color:#ccc;font-weight:700}#spriteDebugPanel input[type="number"]{background:rgb(255 255 255/.1);border:1px solid rgb(255 255 255/.3);color:#fff;padding:2px 4px;border-radius:2px;margin:0 5px}#spriteDebugPanel input[type="range"]{width:100px;margin:0 5px}#spriteDebugPanel label{display:inline-block;width:60px;font-size:11px}.sprite-debug-panel.visible{display:block}.isla-button{font-family:monospace;font-size:1.2em;font-weight:bold;color:#181818;background:linear-gradient(to bottom,#ffe76b 0%,#ffc933 40%,#e68a00 100%);border:none;border-radius:12px;padding:20px 40px;box-shadow:inset 0 1px 0 rgba(255,255,255,.8),0 3px 0 #c56a00,0 5px 8px rgba(0,0,0,.25);cursor:pointer;text-transform:uppercase;transition:all.15s ease-in-out}.isla-button:hover{filter:brightness(1.15)}.isla-button:active{transform:translateY(3px);box-shadow:inset 0 1px 0 rgba(255,255,255,.8),0 2px 0 #c56a00,0 3px 6px rgba(0,0,0,.25)}.intro-overlay{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(1,255,255,0.45);backdrop-filter:blur(3px);display:flex;align-items:flex-start;justify-content:center;z-index:1000;opacity:1;transition:opacity 0.5s ease}.intro-overlay.hidden{opacity:0;pointer-events:none}.intro-content{text-align:center;color:white;max-width:500px;padding:40px}.intro-title{font-size:3.5rem;font-weight:bold;margin-bottom:24px;text-shadow:2px 2px 8px rgba(0,0,0,0.8);letter-spacing:2px}.intro-description{font-size:1.1rem;line-height:1.6;text-shadow:1px 2px 2px rgba(0,0,0,0.55),-1px 1px 10px rgba(0,0,0,0.85);margin-bottom:32px;opacity:0.9}.start-button{background:#43aa8b;color:white;border:none;padding:16px 32px;border-radius:8px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(67,170,139,0.3)}.start-button:hover{background:#4fc3f7;transform:translateY(-2px);box-shadow:0 6px 16px rgba(79,195,247,0.4)}

/* Chat Integration Styles */
.chat-container{position:absolute;top:10px;right:10px;z-index:150;display:none}.chat-container.visible{display:block}.chat{width:300px;height:250px;background:#fff;border:1px solid #e1e5e9;border-radius:6px;display:flex;flex-direction:column;position:relative;box-shadow:0 4px 12px rgba(0,0,0,0.15)}.hdr{height:28px;background:#fff;border-bottom:1px solid #e1e5e9;display:flex;align-items:center;justify-content:space-between;padding:0 8px;flex-shrink:0}.room{font-weight:500;color:#1a1a1a;font-size:11px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.status{width:6px;height:6px;border-radius:50%;background:#10b981;flex-shrink:0}.status.offline{background:#ef4444}.status.connecting{background:#f59e0b}.menu-btn{background:none;border:none;color:#6b7280;cursor:pointer;padding:2px;border-radius:3px;font-size:10px}.menu-btn:hover{background:#f3f4f6}.msgs{flex:1;overflow-y:auto;padding:6px;min-height:0}.msg{width:90%;margin-bottom:6px;padding:6px 8px;background:#f8f9fa;border-radius:6px;border-left:2px solid #e5e7eb;position:relative}.msg.own{background:#eff6ff;border-left-color:#3b82f6;margin-left:20px}.msg.admin{border-left-color:#8b5cf6}.msg.mod{border-left-color:#f59e0b}.msg.pending{opacity:0.7;border-left-color:#f59e0b}.msg.error{background:#fee2e2;border-left-color:#ef4444}.mhdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:2px}.user{font-weight:500;color:#374151;font-size:10px;display:flex;align-items:center;gap:4px}.time{font-size:9px;color:#9ca3af}.badge{font-size:8px;background:#6b7280;color:#fff;padding:1px 4px;border-radius:8px}.badge.admin{background:#8b5cf6}.badge.mod{background:#f59e0b}.txt{color:#1f2937;line-height:1.3;word-wrap:break-word;font-size:11px;margin-bottom:4px}.karma{font-size:9px;color:#6b7280;margin-left:4px}.karma.pos{color:#10b981}.karma.neg{color:#ef4444}.vote-btns{display:flex;gap:2px;align-items:center}.vote-btn{background:none;border:1px solid #d1d5db;border-radius:3px;width:16px;height:14px;cursor:pointer;font-size:10px;display:flex;align-items:center;justify-content:center;color:#6b7280}.vote-btn:hover{background:#f3f4f6}.vote-btn.active{background:#3b82f6;color:#fff;border-color:#3b82f6}.vote-btn.up.active{background:#10b981;border-color:#10b981}.vote-btn.down.active{background:#ef4444;border-color:#ef4444}.vote-score{font-size:8px;color:#6b7280;margin:0 3px;min-width:12px;text-align:center}.empty{text-align:center;color:#9ca3af;padding:20px 12px;font-size:11px}.inp-area{padding:6px;border-top:1px solid #e1e5e9;flex-shrink:0;display:flex;gap:4px}.inp{flex:1;min-height:24px;max-height:48px;padding:4px 8px;border:1px solid #d1d5db;border-radius:4px;resize:none;font-family:inherit;font-size:11px}.inp:focus{outline:none;border-color:#3b82f6}.send-btn{background:#3b82f6;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:10px;flex-shrink:0}.send-btn:hover:not(:disabled){background:#2563eb}.send-btn:disabled{background:#9ca3af;cursor:not-allowed}.chat-toggle{position:absolute;top:10px;right:10px;z-index:160;background:rgba(0,0,0,0.7);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:11px;display:none}.chat-toggle.visible{display:block}.chat-toggle:hover{background:rgba(0,0,0,0.85)}</style></head><body><div id="introOverlay" class="intro-overlay"><div class="intro-content"><h1 class="intro-title"><img src="https://i.imgur.com/rWDfHo1.png" style="max-width: 100%;" alt=""></h1><p class="intro-description">Bienvenido a una isla que crece contigo.Cada vez que vives una historia,ayudas a alguien o aprendes algo nuevo,tu isla se transforma.Cada experiencia deja su huella.</p><br><button id="startButton" class="isla-button">Iniciar Aventura</button></div></div>

<!-- Chat Toggle Button -->
<button id="chatToggle" class="chat-toggle">💬 Chat</button>

<!-- Chat Container -->
<div id="chatContainer" class="chat-container"><div class="chat"><div class="hdr"><div class="room" id="room-name">MiniGeo Chat</div><div class="status" id="status"></div><button class="menu-btn" onclick="showChatSettings()">⚙</button></div><div class="msgs" id="msgs"><div class="empty">Conectando...</div></div><div class="inp-area"><textarea class="inp" id="inp" placeholder="Escribe un mensaje..." maxlength="1000" disabled></textarea><button class="send-btn" id="send-btn" onclick="sendChatMsg()" disabled>📤</button></div></div></div>

<canvas id="gameCanvas"></canvas><div class="ui-container"><button id="debugToggle" style="display: none;" class="toggle-btn">DBG</button><button id="editToggle" style="display: none;" class="toggle-btn">Edit Mode</button><button id="spriteDebugToggle" style="display: none;" class="toggle-btn">Sprite Debug</button><div id="debugPanel" class="panel"><div><strong>Debug Info</strong></div><div>FPS:<span id="fps">60</span></div><div>Camera:<span id="cameraPos">0,0,0</span></div><div>Zoom:<span id="zoomLevel">1.0</span></div><div style="margin: 8px 0; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 8px;"><div><strong>Terrain Seed</strong></div><div style="font-family: monospace; font-size: 10px; word-break: break-all; margin: 4px 0;"><span id="currentSeed">Loading...</span></div><div><button id="exportBtn" style="font-size: 10px; padding: 4px 8px; margin: 2px;">Export</button><button id="importBtn" style="font-size: 10px; padding: 4px 8px; margin: 2px;">Import</button></div></div><div class="light-control"><label>Light X</label><input id="lx" type="range" min="-100" max="100" step="0.5" value="50"><label>Light Y</label><input id="ly" type="range" min="-100" max="100" step="0.5" value="50"><label>Light Z</label><input id="lz" type="range" min="-100" max="100" step="0.5" value="25"><label>Color</label><input id="lcolor" type="color" value="#fff6e0"><label for="lightSlider">Light Power</label><input id="lightSlider" type="range" min="0" max="2" step="0.01" value="0.95"/></div><div class="controls-text"><div><strong>Desktop:</strong>WASD/Arrows=Move|Wheel=Zoom|Drag=Pan</div><div><strong>Mobile:</strong>Drag=Pan|Pinch=Zoom|Tap=Select</div></div></div><div id="spriteDebugPanel" class="panel sprite-debug-panel"><div><strong>Sprite Debug</strong></div><div><button id="terrainSpriteToggle">Terrain:Sprites</button></div><div style="margin: 8px 0;"><label>U Offset:</label><input type="number" id="uOffsetInput" step="0.01" value="0" style="width: 60px;"><input type="range" id="uOffset" min="-2" max="2" step="0.01" value="0"></div><div style="margin: 8px 0;"><label>V Offset:</label><input type="number" id="vOffsetInput" step="0.01" value="0" style="width: 60px;"><input type="range" id="vOffset" min="-2" max="2" step="0.01" value="0"></div><div style="margin: 8px 0;"><label>U Scale:</label><input type="number" id="uScaleInput" step="0.1" value="1" style="width: 60px;"><input type="range" id="uScale" min="0.1" max="5" step="0.01" value="1"></div><div style="margin: 8px 0;"><label>V Scale:</label><input type="number" id="vScaleInput" step="0.1" value="1" style="width: 60px;"><input type="range" id="vScale" min="0.1" max="5" step="0.01" value="1"></div><div style="margin: 8px 0;"><button id="resetTextureBtn" style="background: #f44336;">Reset Texture</button></div><div id="pipReference" class="pip-reference"><img id="pipImage" src="https://i.imgur.com/C4l87Xp.png" alt="Texture Reference"><div class="pip-overlay"></div><div class="pip-label">Texture Atlas</div></div></div><div id="editPanel" class="panel"><div><strong>Tile Editor</strong></div><div style="margin: 8px 0;">Selected:<span id="selectedTile">None</span>|Height:<span id="selectedHeight">-</span></div><div><button id="raiseBtn" disabled>Raise(+)</button><button id="lowerBtn" disabled>Lower(-)</button><button id="clearBtn">Clear</button></div><div class="controls-text">Click tiles to select|Shift+Click=Lower|Ctrl+Click=Reset</div></div></div><div id="editIndicator" class="edit-indicator">EDIT MODE ACTIVE</div><div id="tooltipContainer" class="tooltip-container"></div>

<script>
// Chat Integration JavaScript
const CHAT_API = 'https://chat.minigeo.org';
const chatAdjectives = ['Genial','Increible','Fantastico','Brillante','Magnifico','Excelente','Asombroso','Estupendo','Maravilloso','Espectacular','Fabuloso','Sensacional','Extraordinario','Fenomenal','Impresionante','Sorprendente','Radiante','Vibrante','Dinamico','Energico','Creativo','Innovador','Inspirador','Optimista','Positivo','Alegre','Divertido','Encantador','Carismatico','Inteligente'];

let chatUser = {
    id: generateChatId(),
    name: generateRandomChatName(),
    isMod: false,
    isAdmin: false,
    token: ''
};

let currentRoom = null;
let chatRooms = [];
let chatMessages = [];
let chatPoll = null;
let lastMessage = null;
let chatConnected = false;
let chatRetry = 0;
let pendingMessages = new Map();

const MAX_CHAT_RETRY = 5;
const CHAT_POLL_INTERVAL = 3000;
const CHAT_RETRY_DELAY = 5000;

function generateRandomChatName() {
    const adj = chatAdjectives[Math.floor(Math.random() * chatAdjectives.length)];
    const num = String(Math.floor(Math.random() * 90) + 10);
    return `${adj}${num}`;
}

function generateChatId() {
    const t = Date.now().toString(36);
    const r = Math.random().toString(36).substr(2, 9);
    return `user_${t}_${r}`.substr(0, 24);
}

function initializeChat() {
    console.log('Initializing chat system...');
    loadChatUser();
    setupChatEvents();
    loadChatRooms().then(() => {
        if (chatRooms.length > 0) {
            autoJoinMainRoom();
        }
        testChatConnection();
        startChatPoll();
        updateChatStatus('online');
        chatRetry = 0;
    }).catch(e => {
        console.error('Chat initialization failed:', e);
        updateChatStatus('offline');
        scheduleChatRetry();
    });
}

function toggleChatVisibility() {
    const container = document.getElementById('chatContainer');
    const toggle = document.getElementById('chatToggle');
    
    if (container.classList.contains('visible')) {
        container.classList.remove('visible');
        toggle.textContent = '💬 Chat';
    } else {
        container.classList.add('visible');
        toggle.textContent = '✖️ Close';
    }
}

function loadChatUser() {
    const saved = localStorage.getItem('minigeoUser');
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            chatUser = { ...chatUser, ...parsed };
            if (!chatUser.name) chatUser.name = generateRandomChatName();
        } catch (e) {
            localStorage.removeItem('minigeoUser');
            chatUser.name = generateRandomChatName();
        }
    } else {
        chatUser.name = generateRandomChatName();
    }
}

function saveChatUser() {
    localStorage.setItem('minigeoUser', JSON.stringify(chatUser));
}

function setupChatEvents() {
    const inp = document.getElementById('inp');
    inp.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendChatMsg();
        }
    });
    
    inp.addEventListener('input', e => {
        e.target.style.height = 'auto';
        e.target.style.height = Math.min(e.target.scrollHeight, 48) + 'px';
    });
    
    // Chat toggle functionality
    document.getElementById('chatToggle').onclick = toggleChatVisibility;
}

async function loadChatRooms() {
    try {
        const r = await fetchChatAPI(`${CHAT_API}/api/rooms`);
        const d = await r.json();
        if (r.ok) {
            chatRooms = d.rooms || [];
        } else throw new Error(d.error || 'Error loading rooms');
    } catch (e) {
        console.error('Failed to load chat rooms:', e);
    }
}

async function autoJoinMainRoom() {
    try {
        await joinChatRoom('mainroom');
    } catch (e) {
        console.error('Could not join main room:', e);
    }
}

async function joinChatRoom(name) {
    if (currentRoom === name) return;
    if (!chatUser.name) {
        showChatNotification('Configure your name first', 'error');
        return;
    }
    
    try {
        if (currentRoom) await leaveChatRoom(currentRoom);
        
        const r = await fetchChatAPI(`${CHAT_API}/api/join-room`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: chatUser.id,
                roomName: name,
                userName: chatUser.name
            })
        });
        
        const d = await r.json();
        if (r.ok) {
            currentRoom = name;
            const room = chatRooms.find(r => r.name === name);
            document.getElementById('room-name').textContent = room?.displayName || name;
            document.getElementById('inp').disabled = false;
            document.getElementById('send-btn').disabled = false;
            clearChatMessages();
            await loadChatMessages();
            showChatNotification(`Joined ${room?.displayName || name}`, 'success');
        } else throw new Error(d.error || 'Failed to join room');
    } catch (e) {
        console.error('Failed to join room:', e);
        showChatNotification('Failed to join room', 'error');
    }
}

async function leaveChatRoom(name) {
    try {
        await fetchChatAPI(`${CHAT_API}/api/leave-room`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: chatUser.id, roomName: name })
        });
    } catch (e) {
        console.error('Failed to leave room:', e);
    }
}

async function loadChatMessages() {
    if (!currentRoom || !chatConnected) return;
    
    try {
        let url = `${CHAT_API}/api/messages?room=${currentRoom}&limit=30&userId=${chatUser.id}`;
        if (lastMessage) url += `&since=${lastMessage}`;
        
        const r = await fetchChatAPI(url, {}, 5000);
        const d = await r.json();
        
        if (r.ok && d.messages) {
            if (d.messages.length > 0) {
                addChatMessages(d.messages);
                lastMessage = d.messages[d.messages.length - 1].timestamp;
            }
            if (!chatConnected) {
                chatConnected = true;
                updateChatStatus('online');
                chatRetry = 0;
            }
        } else throw new Error(d.error || 'Error loading messages');
    } catch (e) {
        console.error('Failed to load messages:', e);
        if (chatConnected) {
            chatConnected = false;
            updateChatStatus('offline');
            scheduleChatRetry();
        }
    }
}

function addChatMessages(newMessages) {
    newMessages.forEach(m => {
        const existingIndex = chatMessages.findIndex(x => x.id === m.id);
        if (existingIndex !== -1) {
            chatMessages[existingIndex] = m;
        } else {
            chatMessages.push(m);
        }
    });
    
    if (chatMessages.length > 100) chatMessages = chatMessages.slice(-100);
    renderChatMessages();
    scrollChatToBottom();
}

function renderChatMessages() {
    const container = document.getElementById('msgs');
    if (!chatMessages.length) {
        if (currentRoom) {
            container.innerHTML = '<div class="empty">Loading messages...</div>';
        } else {
            container.innerHTML = '<div class="empty">Select a room to start chatting</div>';
        }
        return;
    }
    
    container.innerHTML = '';
    chatMessages.forEach(m => {
        const div = document.createElement('div');
        let classes = `msg ${m.userId === chatUser.id ? 'own' : ''}`;
        if (m.isAdmin) classes += ' admin';
        else if (m.isMod) classes += ' mod';
        if (m.pending) classes += ' pending';
        if (m.error) classes += ' error';
        div.className = classes;
        
        const time = new Date(m.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        let badges = '';
        if (m.isAdmin) badges = '<span class="badge admin">A</span>';
        else if (m.isMod) badges = '<span class="badge mod">M</span>';
        
        let statusIcon = '';
        if (m.pending) statusIcon = '<span style="color:#f59e0b;font-size:8px"> ⏳</span>';
        if (m.error) statusIcon = '<span style="color:#ef4444;font-size:8px"> ⌘</span>';
        
        div.innerHTML = `
            <div class="mhdr">
                <span class="user">${escapeHtml(m.userName || 'User')}${badges}${statusIcon}</span>
                <span class="time">${time}</span>
            </div>
            <div class="txt">${escapeHtml(m.message || '')}</div>
        `;
        container.appendChild(div);
    });
}

function clearChatMessages() {
    chatMessages = [];
    lastMessage = null;
    pendingMessages.clear();
    renderChatMessages();
}

async function sendChatMsg() {
    const inp = document.getElementById('inp');
    const message = inp.value.trim();
    if (!message || !currentRoom || !chatUser.name) return;
    
    if (message.length > 1000) {
        showChatNotification('Message too long', 'error');
        return;
    }
    
    const btn = document.getElementById('send-btn');
    btn.disabled = true;
    
    const tempId = generateTempId();
    const tempMsg = {
        id: tempId,
        tempId,
        message: message,
        userId: chatUser.id,
        userName: chatUser.name,
        timestamp: new Date().toISOString(),
        pending: true,
        isAdmin: chatUser.isAdmin,
        isMod: chatUser.isMod
    };
    
    chatMessages.push(tempMsg);
    pendingMessages.set(tempId, tempMsg);
    inp.value = '';
    inp.style.height = 'auto';
    renderChatMessages();
    scrollChatToBottom();
    
    try {
        const r = await fetchChatAPI(`${CHAT_API}/api/messages`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                roomName: currentRoom,
                userId: chatUser.id,
                userName: chatUser.name,
                message: message
            })
        });
        
        if (r.ok) {
            const d = await r.json();
            if (d.message) {
                const msgIndex = chatMessages.findIndex(m => m.tempId === tempId);
                if (msgIndex !== -1) {
                    pendingMessages.delete(tempId);
                    chatMessages[msgIndex] = { ...d.message, tempId: undefined, pending: false };
                    renderChatMessages();
                }
            }
        } else {
            const d = await r.json();
            throw new Error(d.error || 'Failed to send message');
        }
    } catch (e) {
        console.error('Failed to send message:', e);
        const msgIndex = chatMessages.findIndex(m => m.tempId === tempId);
        if (msgIndex !== -1) {
            chatMessages[msgIndex].error = true;
            chatMessages[msgIndex].pending = false;
            renderChatMessages();
        }
        showChatNotification('Failed to send message', 'error');
    } finally {
        btn.disabled = false;
    }
}

function generateTempId() {
    return `temp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
}

async function fetchChatAPI(url, options = {}, timeout = 10000) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeout);
    
    try {
        const headers = options.headers || {};
        if (chatUser.token) headers.Authorization = `Bearer ${chatUser.token}`;
        
        const response = await fetch(url, {
            ...options,
            headers,
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        return response;
    } catch (e) {
        clearTimeout(timeoutId);
        throw e;
    }
}

async function testChatConnection() {
    try {
        const r = await fetchChatAPI(`${CHAT_API}/api/health`, {}, 5000);
        if (r.ok) {
            chatConnected = true;
            return true;
        }
    } catch (e) {
        console.error('Chat connection test failed:', e);
    }
    chatConnected = false;
    return false;
}

function scheduleChatRetry() {
    if (chatRetry < MAX_CHAT_RETRY) {
        chatRetry++;
        setTimeout(async () => {
            updateChatStatus('connecting');
            if (await testChatConnection()) {
                updateChatStatus('online');
                chatRetry = 0;
                if (!chatPoll) startChatPoll();
            } else {
                updateChatStatus('offline');
                scheduleChatRetry();
            }
        }, CHAT_RETRY_DELAY * chatRetry);
    } else {
        updateChatStatus('offline');
        showChatNotification('Connection failed', 'error');
    }
}

function startChatPoll() {
    if (chatPoll) clearInterval(chatPoll);
    chatPoll = setInterval(pollChatMessages, CHAT_POLL_INTERVAL);
}

async function pollChatMessages() {
    if (currentRoom) await loadChatMessages();
}

function updateChatStatus(status) {
    const element = document.getElementById('status');
    element.className = `status ${status}`;
    chatConnected = status === 'online';
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showChatNotification(message, type = 'success') {
    // Remove existing notifications
    document.querySelectorAll('.chat-notification').forEach(el => el.remove());
    
    const notification = document.createElement('div');
    notification.className = `chat-notification ${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 70px;
        right: 20px;
        padding: 8px 12px;
        border-radius: 6px;
        color: #fff;
        font-size: 11px;
        z-index: 2000;
        max-width: 200px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#f59e0b'};
    `;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

function scrollChatToBottom() {
    const container = document.getElementById('msgs');
    container.scrollTop = container.scrollHeight;
}

function showChatSettings() {
    // Simple settings - could be expanded
    showChatNotification('Settings coming soon!', 'warning');
}

// Modified game initialization to include chat
const USE_SPRITE_PLAYER = true;
const USE_SPRITE_TERRAIN = true;

class GameEngine {
    constructor() {
        this.lastFrameTime = performance.now();
        this.deltaTime = 0;
        this.targetFPS = 60;
        this.frameInterval = 1000 / this.targetFPS;
        this.gridSize = 16;
        this.tileSize = 2;
        this.heightLevels = 8;
        this.editMode = false;
        this.selectedTile = null;
        this.raycaster = new THREE.Raycaster();
        this.mouse = new THREE.Vector2();
        this.initialCameraState = {
            position: new THREE.Vector3(),
            target: new THREE.Vector3(),
            zoom: 1,
            preset: 'default'
        };
        this.input = {
            keys: {},
            mouse: { x: 0, y: 0, pressed: false },
            touch: { active: false, pinchDistance: 0, moved: false }
        };
        this.debugSystem = typeof DebugSystem !== 'undefined' ? new DebugSystem(this) : null;
        this.cloudSprites = [];
        this.terrainSystem = new TerrainSystem(this.gridSize, this.tileSize, this.heightLevels, true);
        this.interactables = [];
        this.proximityRadius = 2.5;
        this.activeTooltip = null;
        this.cameraSystem = new CameraSystem(this);
        this.init();
    }

    setupIntro() {
        this.cameraSystem.setCameraPreset('overview', false);
        const overlay = document.getElementById('introOverlay');
        const button = document.getElementById('startButton');
        
        button.onclick = () => {
            this.cameraSystem.setCameraPreset('default', true, () => {
                console.log('Camera transition to default completed');
            });
            overlay.classList.add('hidden');
            
            // Show chat toggle and initialize chat
            document.getElementById('chatToggle').classList.add('visible');
            initializeChat();
            
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 500);
        };
    }

    // ... rest of the GameEngine methods remain the same as in the original game.js
    setupMobileOptimizations(){let e=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);e&&(this.renderer.shadowMap.type=THREE.BasicShadowMap,this.directionalLight.shadow.mapSize.setScalar(1024),this.cloudSprites=this.cloudSprites.slice(0,3),this.scene.traverse(e=>{e.isMesh&&e.material&&(e.material.precision="lowp")}),console.log("Mobile optimizations applied"))}init(){this.setupRenderer(),this.cameraSystem.setupCamera(),this.camera=this.cameraSystem.camera,this.setupScene(),this.setupLighting(),this.setupMobileOptimizations(),this.setupClouds(),this.setupTerrain(),this.setupInput(),this.setupUI(),this.setupInteractables(),this.player=new Player(this),this.setupIntro(),this.start()}setupRenderer(){this.canvas=document.getElementById("gameCanvas"),this.renderer=new THREE.WebGLRenderer({canvas:this.canvas,antialias:!0}),this.renderer.setPixelRatio(Math.min(devicePixelRatio,2)),this.renderer.setSize(innerWidth,innerHeight),this.renderer.setClearColor(5223385),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=THREE.PCFSoftShadowMap}setCameraPreset(e,t=!0,i=null){let s=document.getElementById("confirmationDialog");s&&s.remove();let a=document.getElementById("npcQuestionDialog");a&&a.remove(),this.cameraSystem.setCameraPreset(e,t,i)}setupScene(){this.scene=new THREE.Scene,this.scene.fog=new THREE.Fog(5223385,30,100)}setupLighting(){this.scene.add(new THREE.AmbientLight(16777215,.4)),this.directionalLight=new THREE.DirectionalLight(16774880,.95),this.directionalLight.position.set(50,50,25),this.directionalLight.castShadow=!0,this.directionalLight.shadow.mapSize.setScalar(2048),Object.assign(this.directionalLight.shadow.camera,{near:.1,far:200,left:-50,right:50,top:50,bottom:-50}),this.scene.add(this.directionalLight)}setupClouds(){let e=new THREE.TextureLoader;e.load("https://i.imgur.com/mYRt74O.png",e=>{for(let t=0;t<6;t++){let i=new THREE.Sprite(new THREE.SpriteMaterial({map:e,opacity:.7,transparent:!0}));i.position.set((Math.random()-.5)*this.gridSize*this.tileSize,8+2*Math.random(),(Math.random()-.5)*this.gridSize*this.tileSize),i.scale.set(8+6*Math.random(),4+2*Math.random(),1),i.userData.speed=.01*(.5+.2*Math.random()),this.scene.add(i),this.cloudSprites.push(i)}})}setupTerrain(){this.terrainSystem.generateTerrain(),this.terrainSystem.loadFromSeed("9877766666677789877665555556677877665544445566777665444334445667765443333334456765543322223345566544321111234456654332100123345665433210012334566544321111234456655433222233455676544333333445677665444334445667776655444455667787766555555667789877766666677789"),this.scene.add(this.terrainSystem.terrainGroup),this.terrain=this.terrainSystem}setupInput(){["keydown","keyup"].forEach(e=>addEventListener(e,t=>this.input.keys[t.code]="keydown"===e)),["mousedown","mousemove","mouseup"].forEach(e=>this.canvas.addEventListener(e,t=>this.handleMouse(e,t))),this.canvas.addEventListener("click",e=>this.editMode&&this.handleTileClick(e)),this.canvas.addEventListener("wheel",e=>{e.preventDefault(),this.cameraSystem.zoomCamera(e.deltaY>0?.1:-.1)}),["touchstart","touchmove","touchend"].forEach(e=>{let t="handleTouch"+e.slice(5).charAt(0).toUpperCase()+e.slice(6);this.canvas.addEventListener(e,e=>{e.preventDefault(),"function"==typeof this[t]&&this[t](e)})}),addEventListener("resize",()=>this.handleResize())}setupUI(){document.getElementById("editToggle").onclick=()=>this.togglePanel("edit"),document.getElementById("raiseBtn").onclick=()=>this.modifySelected(1),document.getElementById("lowerBtn").onclick=()=>this.modifySelected(-1),document.getElementById("clearBtn").onclick=()=>confirm("Clear all terrain?")&&this.clearTerrain();let e=document.getElementById("lightSlider");e.oninput=e=>{this.directionalLight.intensity=parseFloat(e.target.value)},["lx","ly","lz"].forEach(e=>{document.getElementById(e).oninput=t=>this.directionalLight.position[e[1]]=parseFloat(t.target.value)}),document.getElementById("lcolor").oninput=e=>this.directionalLight.color.set(e.target.value)}togglePanel(e){this.editMode=!this.editMode;let t=document.getElementById("editPanel"),i=document.getElementById("editToggle"),s=document.getElementById("editIndicator");t.classList.toggle("visible",this.editMode),i.classList.toggle("active",this.editMode),s.classList.toggle("visible",this.editMode),this.canvas.style.cursor=this.editMode?"crosshair":"grab",this.editMode||this.clearSelection()}handleMouse(e,t){let i=this.input.mouse;"mousedown"===e?(i.pressed=!0,i.x=t.clientX,i.y=t.clientY):"mousemove"===e&&i.pressed&&!this.editMode?this.cameraSystem.panCamera(t.clientX-i.x,t.clientY-i.y):"mouseup"===e&&(i.pressed=!1),"mouseup"!==e&&(i.x=t.clientX,i.y=t.clientY)}handleTileClick(e){let t=this.canvas.getBoundingClientRect();this.mouse.set((e.clientX-t.left)/t.width*2-1,-(2*((e.clientY-t.top)/t.height))+1),this.raycaster.setFromCamera(this.mouse,this.camera);let i=this.terrainSystem.terrainGroup.children.filter(e=>50>e.position.distanceTo(this.camera.position)),s=this.raycaster.intersectObjects(i,!0);if(s.length){let a=s[0].object.userData;this.selectTile(a.x,a.z),e.shiftKey?this.modifyTileHeight(a.x,a.z,-1):e.ctrlKey||e.metaKey?this.setTileHeight(a.x,a.z,0):this.modifyTileHeight(a.x,a.z,1)}}selectTile(e,t){let i=this.terrainSystem.getTile(e,t);i&&(this.selectedTile={x:e,z:t,height:i.height},this.updateEditUI(),this.highlightTile(i.mesh))}clearSelection(){this.selectedTile=null,this.updateEditUI(),this.removeHighlight()}highlightTile(e){if(this.removeHighlight(),e.isGroup){let t=.9*this.tileSize,i=new THREE.RingGeometry(.6*t,.65*t,16),s=new THREE.MeshBasicMaterial({color:16777215,transparent:!0,opacity:.8,side:THREE.DoubleSide});this.tileHighlight=new THREE.Mesh(i,s),this.tileHighlight.rotation.x=-Math.PI/2,this.tileHighlight.position.copy(e.position);let a=this.getTileFromMesh(e);a&&(this.tileHighlight.position.y=.5+.5*a.height+.02),this.scene.add(this.tileHighlight)}else{let n=new THREE.EdgesGeometry(e.geometry);this.tileHighlight=new THREE.LineSegments(n,new THREE.LineBasicMaterial({color:16777215,linewidth:3})),this.tileHighlight.position.copy(e.position),this.tileHighlight.position.y+=.01,this.scene.add(this.tileHighlight)}}getTileFromMesh(e){return e.userData&&void 0!==e.userData.x?this.terrainSystem.getTile(e.userData.x,e.userData.z):null}removeHighlight(){this.tileHighlight&&(this.scene.remove(this.tileHighlight),this.tileHighlight.geometry.dispose(),this.tileHighlight.material.dispose(),this.tileHighlight=null)}modifySelected(e){this.selectedTile&&this.modifyTileHeight(this.selectedTile.x,this.selectedTile.z,e)}modifyTileHeight(e,t,i){let s=this.terrainSystem.getTile(e,t);if(s){let a=Math.max(0,Math.min(this.heightLevels-1,s.height+i));a!==s.height&&(this.terrainSystem.updateTileHeight(e,t,a),this.selectedTile?.x===e&&this.selectedTile?.z===t&&(this.selectedTile.height=a,this.updateEditUI(),this.highlightTile(s.mesh)))}}setTileHeight(e,t,i){let s=this.terrainSystem.getTile(e,t);s&&s.height!==i&&(this.terrainSystem.updateTileHeight(e,t,i),this.selectedTile?.x===e&&this.selectedTile?.z===t&&(this.selectedTile.height=i,this.updateEditUI(),this.highlightTile(s.mesh)))}clearTerrain(){this.terrainSystem.clearTerrain(),this.clearSelection()}updateEditUI(){let e=["selectedTile","selectedHeight","raiseBtn","lowerBtn"].map(e=>document.getElementById(e));this.selectedTile?(e[0].textContent=`${this.selectedTile.x},${this.selectedTile.z}`,e[1].textContent=this.selectedTile.height,e[2].disabled=!this.editMode||this.selectedTile.height>=this.heightLevels-1,e[3].disabled=!this.editMode||this.selectedTile.height<=0):(e[0].textContent="None",e[1].textContent="-",e.slice(2).forEach(e=>e.disabled=!0))}handleTouchStart(e){let t=e.touches;1===t.length?Object.assign(this.input.touch,{active:!0,moved:!1,start:{x:t[0].clientX,y:t[0].clientY}}):2===t.length&&(this.input.touch.pinchDistance=Math.hypot(t[0].clientX-t[1].clientX,t[0].clientY-t[1].clientY),this.input.touch.moved=!1)}handleTouchMove(e){let t=e.touches;if(1===t.length&&this.input.touch.active){let i={x:(t[0].clientX-this.input.touch.start.x)/window.innerWidth,y:(t[0].clientY-this.input.touch.start.y)/window.innerHeight},s=Math.hypot(i.x,i.y);s>0&&!this.editMode&&(this.input.touch.moved=!0,this.cameraSystem.panCamera(70*i.x,70*i.y))}else if(2===t.length){let a=Math.hypot(t[0].clientX-t[1].clientX,t[0].clientY-t[1].clientY);this.cameraSystem.zoomCamera((this.input.touch.pinchDistance-a)*.01),this.input.touch.pinchDistance=a,this.input.touch.moved=!0}}handleTouchEnd(e){if(this.input.touch.active&&1===e.changedTouches.length){let t=e.changedTouches[0],i=!this.input.touch.moved;if(this.editMode&&i)this.handleTileClick({clientX:t.clientX,clientY:t.clientY,shiftKey:!1,ctrlKey:!1,metaKey:!1});else if(!this.editMode&&i){let s=this.canvas.getBoundingClientRect();this.mouse.set((t.clientX-s.left)/s.width*2-1,-(2*((t.clientY-s.top)/s.height))+1),this.raycaster.setFromCamera(this.mouse,this.camera);let a=this.raycaster.intersectObjects(this.terrainSystem.terrainGroup.children,!0);if(a.length){let{x:n,z:o}=a[0].object.userData;this.player&&this.player.sprite&&this.player.findPath(this.player.pos,{x:n,z:o},e=>{this.player.path=e,this.player.progress=0})}}}Object.assign(this.input.touch,{active:!1,start:null,moved:!1})}handleKeyboardInput(){this.cameraSystem.handleKeyboardCameraInput(),this.input.keys.KeyE&&!this.input.keys._ePressed?(this.input.keys._ePressed=!0,this.handleInteraction()):this.input.keys.KeyE||(this.input.keys._ePressed=!1)}handleResize(){this.cameraSystem.handleResize(),this.renderer.setSize(innerWidth,innerHeight),this.renderer.setPixelRatio(Math.min(devicePixelRatio,2))}start(){this.animate()}animate(){requestAnimationFrame(()=>this.animate());let e=performance.now();this.deltaTime=Math.min(e-this.lastFrameTime,33.33),this.lastFrameTime=e,this.update(),this.render(),this.debugSystem&&this.debugSystem.updatePerformanceStats()}update(){if(this.handleKeyboardInput(),this.cameraSystem.update(),this.cloudSprites.forEach((e,t)=>{t%4==Date.now()/100%4|0&&(e.position.x+=e.userData.speed*(this.deltaTime/16.67),e.position.x>this.gridSize*this.tileSize&&(e.position.x=-this.gridSize*this.tileSize))}),this.selectedTile&&this.tileHighlight){let e=this.terrainSystem.getTile(this.selectedTile.x,this.selectedTile.z);e&&(this.tileHighlight.position.copy(e.mesh.position),this.tileHighlight.position.y=.5+.5*e.height+.02)}this.player&&this.player.update(),this.checkProximityInteractions()}render(){this.renderer.render(this.scene,this.camera)}setupInteractables(){[{x:12,z:11,type:"chest",message:"Ancient Chest",interact:"Press E to open"},{x:7,z:11,type:"crystal",message:"Magic Crystal",interact:"Press E to collect"},{x:14,z:14,type:"shrine",message:"Mysterious Shrine",interact:"Press E to pray"}].forEach(e=>{let t=this.terrainSystem.getTile(e.x,e.z);if(!t)return;let i=this.createInteractableObject(e.type,e.x,e.z);i&&(this.scene.add(i),this.interactables.push({mesh:i,x:e.x,z:e.z,type:e.type,message:e.message,interact:e.interact,inRange:!1}))}),setTimeout(()=>{this.npcs&&this.npcs.forEach(e=>{e.isInteractable&&this.interactables.push({mesh:e.sprite,x:e.pos.x,z:e.pos.z,type:"npc",message:e.name||"Friendly NPC",interact:"Press E to talk",inRange:!1,npcRef:e})})},500)}createInteractableObject(e,t,i){let s=this.terrainSystem.getTile(t,i);if(!s)return null;let a,n,o,r=.5+.5*s.height;switch(e){case"chest":a=new THREE.BoxGeometry(.3,.3,.3),n=new THREE.MeshLambertMaterial({color:9127187}),(o=new THREE.Mesh(a,n)).position.set(s.mesh.position.x,r+.3,s.mesh.position.z);break;case"crystal":a=new THREE.OctahedronGeometry(.4,0),n=new THREE.MeshLambertMaterial({color:65535,transparent:!0,opacity:.8,emissive:17476}),(o=new THREE.Mesh(a,n)).position.set(s.mesh.position.x,r+.4,s.mesh.position.z);break;case"shrine":let l=new THREE.CylinderGeometry(.6,.8,.3,8),h=new THREE.CylinderGeometry(.15,.15,1.2,8),c=new THREE.SphereGeometry(.25,8,6);o=new THREE.Group;let d=new THREE.Mesh(l,new THREE.MeshLambertMaterial({color:7372944})),p=new THREE.Mesh(h,new THREE.MeshLambertMaterial({color:7372944})),m=new THREE.Mesh(c,new THREE.MeshLambertMaterial({color:16766720,emissive:3351040}));d.position.y=.15,p.position.y=.9,m.position.y=1.65,o.add(d,p,m),o.position.set(s.mesh.position.x,r,s.mesh.position.z);break;default:return null}return o&&(o.castShadow=o.receiveShadow=!0,o.children&&o.children.forEach(e=>{e.castShadow=e.receiveShadow=!0})),o}checkProximityInteractions(){if(!this.player||!this.player.sprite)return;let e=null,t=1/0;this.interactables.forEach(i=>{if(!i.mesh)return;"npc"===i.type&&i.npcRef&&(i.x=i.npcRef.pos.x,i.z=i.npcRef.pos.z);let s=Math.sqrt(Math.pow(this.player.pos.x-i.x,2)+Math.pow(this.player.pos.z-i.z,2)),a=i.inRange;i.inRange=s<=this.proximityRadius,i.inRange&&!a?this.addGlowEffect(i.mesh):!i.inRange&&a&&this.removeGlowEffect(i.mesh),i.inRange&&s<t&&(t=s,e=i)}),this.updateTooltip(e)}addGlowEffect(e){if(e.userData||(e.userData={}),e.userData.glowAdded)return;let t=e=>{if(e.userData||(e.userData={}),e.material&&e.material.emissive){let t=e.material.emissive.clone();e.userData.originalEmissive=t,e.userData.glowAdded=!0;let i=0,s=a=>{if(e.userData.glowAdded){if(a-i>100){let n=(Math.sin(.003*a)+1)*.1;e.material.emissive.setRGB(t.r+n,t.g+n,t.b+n),i=a}requestAnimationFrame(s)}};s(performance.now())}};e.isGroup?e.children.forEach(t):t(e),e.userData.glowAdded=!0}removeGlowEffect(e){e.userData||(e.userData={});let t=e=>{e.userData||(e.userData={}),e.userData.glowAdded&&(e.userData.glowAdded=!1,e.material&&e.material.emissive&&e.userData.originalEmissive&&e.material.emissive.copy(e.userData.originalEmissive))};e.isGroup?e.children.forEach(t):t(e),e.userData.glowAdded=!1}updateTooltip(e){let t=document.getElementById("tooltipContainer");if(!e){this.hideTooltip();return}this.activeTooltip=e;let i=1.5>=this.getDistanceToInteractable(e),s=document.createElement("div");s.className=`tooltip interact visible ${i?"clickable":""}`,s.innerHTML=`
            <strong>${e.message}</strong>
            <div class="interact-prompt">${i?"Click to interact":e.interact}</div>
        `;let a=t._clickHandler;if(a&&(t.removeEventListener("click",a),t.removeEventListener("mousedown",a)),i){s.style.cursor="pointer",t.style.pointerEvents="auto",t.style.zIndex="999";let n=e=>{if(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!this._isInteracting){if(this._isInteracting=!0,setTimeout(()=>this._isInteracting=!1,500),"npc"===this.activeTooltip.type&&this.activeTooltip.npcRef){let t=this.activeTooltip.npcRef.interact();t&&this.showInteractionMessage(t)}else this.executeInteraction(this.activeTooltip)}};t.addEventListener("click",n),t.addEventListener("mousedown",n),t.addEventListener("touchstart",e=>{if(e.preventDefault(),e.stopPropagation(),!this._isInteracting){if(this._isInteracting=!0,setTimeout(()=>this._isInteracting=!1,500),"npc"===this.activeTooltip.type&&this.activeTooltip.npcRef){let t=this.activeTooltip.npcRef.interact();t&&this.showInteractionMessage(t)}else this.executeInteraction(this.activeTooltip)}}),t._clickHandler=n}else t.style.pointerEvents="auto",s.style.cursor="default";t.innerHTML="",t.appendChild(s),this.positionTooltip(e)}positionTooltip(e){let t=document.getElementById("tooltipContainer"),i=new THREE.Vector3(e.mesh.position.x,e.mesh.position.y+1.5,e.mesh.position.z),s=i.project(this.camera),a=(s.x+1)/2*window.innerWidth,n=-(s.y-1)/2*window.innerHeight;t.style.left=`${a}px`,t.style.top=`${n}px`,t.style.transform="translate(-50%, -100%)"}hideTooltip(){if(!this.activeTooltip)return;this.activeTooltip=null;let e=document.getElementById("tooltipContainer"),t=e.querySelectorAll(".tooltip");t.forEach(e=>{e._clickHandler&&e.removeEventListener("click",e._clickHandler)}),e.innerHTML=""}getDistanceToInteractable(e){return this.player?Math.sqrt(Math.pow(this.player.pos.x-e.x,2)+Math.pow(this.player.pos.z-e.z,2)):1/0}handleInteraction(){if(!this.activeTooltip)return;let e=this.getDistanceToInteractable(this.activeTooltip);if(e>1.5)return;let t=this.activeTooltip;if("npc"===t.type&&t.npcRef){let i=t.npcRef.interact();i&&this.showInteractionMessage(i);return}this.executeInteraction(t)}executeInteraction(e){let t="";switch(e.type){case"npc":if(e.npcRef){(t=e.npcRef.interact())&&this.showInteractionMessage(t);return}t="The NPC nods at you silently.";break;case"chest":t="You found 50 gold coins!";break;case"crystal":t="The crystal glows brightly and fills you with energy!",this.scene.remove(e.mesh),this.interactables=this.interactables.filter(t=>t!==e),this.hideTooltip();break;case"shrine":t="You feel blessed by an ancient power..."}t&&this.showInteractionMessage(t)}showInteractionMessage(e){let t=document.getElementById("tooltipContainer");t&&(t.style.display="none");let i=document.createElement("div");if(i.style.cssText=`
        position: absolute;
        top: 20%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 200;
        animation: fadeInOut 3s ease forwards;
    `,i.textContent=e,!document.getElementById("interactionStyles")){let s=document.createElement("style");s.id="interactionStyles",s.textContent=`
            @keyframes fadeInOut {
                0% { opacity: 0; transform: translate(-50%, -50%) translateY(20px); }
                20%, 80% { opacity: 1; transform: translate(-50%, -50%) translateY(0); }
                100% { opacity: 0; transform: translate(-50%, -50%) translateY(-20px); }
            }
        `,document.head.appendChild(s)}document.body.appendChild(i),setTimeout(()=>{i.remove(),t&&(t.style.display="")},3e3)}showMessage(e){this.showInteractionMessage(e)}showConfirmationDialog(e,t){let i=document.getElementById("confirmationDialog");i&&i.remove();let s=document.createElement("div");s.id="confirmationDialog",s.style.cssText=`
        position: absolute;
        top: 50%;
        left: 50%;
        font-family:monospace!important;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.95);
        color: white;
        padding: 20px;
        border-radius: 12px;
        border: 0px solid #4fc3f7;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
        z-index: 1000;
        min-width: 320px;
        text-align: center;
        font-family: Arial, sans-serif;
    `;let a=this.getConfirmationMessage(e),n=e.confirmationMessage&&e.confirmationAlternative,o;if(o=n?`
            <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 16px;">
                <button id="choiceA" style="
                    background: rgb(134 134 134);
                    font-family:monospace;
                    color: white;
                    border: none;
                    padding: 12px 16px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    transition: background 0.2s;
                    text-align: left;
                    line-height: 1.3;
                ">${e.confirmationMessage}</button>
                <button id="choiceB" style="
                    background: rgb(134 134 134);
                    color: white;font-family:monospace;
                    border: none;
                    padding: 12px 16px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    transition: background 0.2s;
                    text-align: left;
                    line-height: 1.3;
                ">${e.confirmationAlternative}</button>
            </div>
        `:`
            <div style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;">
                <button id="confirmYes" style="
                    background: #43aa8b;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    transition: background 0.2s;
                ">Yes</button>
                <button id="confirmNo" style="
                    background: #f3722c;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    transition: background 0.2s;
                ">No</button>
            </div>
        `,s.innerHTML=`
        <div style="font-size: 16px; margin-bottom: 16px; line-height: 1.4;">
            <strong style="max-width: 420px;width: 90%;display: block;margin: auto;">${e.message||e.name||"NPC"}</strong>
            <div style="margin-top: 8px; font-size: 14px; opacity: 0.9;">
                ${a}
            </div>
        </div>
        ${o}
    `,document.body.appendChild(s),n){let r=s.querySelector("#choiceA"),l=s.querySelector("#choiceB");r.onmouseover=()=>r.style.background="#4fc3f7",r.onmouseout=()=>r.style.background="#43aa8b",l.onmouseover=()=>l.style.background="#f9844a",l.onmouseout=()=>l.style.background="#f3722c",r.onclick=()=>{s.remove(),t(!0)},l.onclick=()=>{s.remove(),t(!1)}}else{let h=s.querySelector("#confirmYes"),c=s.querySelector("#confirmNo");h.onmouseover=()=>h.style.background="#4fc3f7",h.onmouseout=()=>h.style.background="#43aa8b",c.onmouseover=()=>c.style.background="#f9844a",c.onmouseout=()=>c.style.background="#f3722c",h.onclick=()=>{s.remove(),t(!0)},c.onclick=()=>{s.remove(),t(!1)}}let d=e=>{"Escape"===e.key&&(s.remove(),document.removeEventListener("keydown",d),t(!1))};document.addEventListener("keydown",d)}getConfirmationMessage(e){switch(e.type){case"npc_choice":return"";case"npc":return"Do you want to talk to this NPC? They might have useful information or quests.";case"npc_confirmation":return e.message;case"chest":return"Do you want to open this ancient chest? It might contain treasure... or traps.";case"tree":return"Do you want to examine this old tree? The whispers might reveal ancient secrets.";case"crystal":return"Do you want to collect this magical crystal? It will disappear forever.";case"shrine":return"Do you want to pray at this mysterious shrine? Ancient powers await.";default:return"Do you want to interact with this object?"}}
}

window.game = new GameEngine();
</script>
<script src="./game.js"></script></body></html>