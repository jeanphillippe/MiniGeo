<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Isla Historias/Story Island-MiniGEO</title><script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script><script srwc="./debug.js"></script><script src="./camera.js"></script><script src="./terrain.js"></script><script src="./player.js"></script><script src="./npcs.js"></script><script src="./minigames.js"></script><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#2c3e50;overflow:hidden}#gameCanvas{display:block;width:100vw;height:100vh;touch-action:none;cursor:grab}#gameCanvas:active{cursor:grabbing}.ui-container{position:absolute;top:10px;left:10px;z-index:100}.toggle-btn{background:rgb(0 0 0/.8);color:#fff;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;font-size:9px;margin-bottom:5px}.toggle-btn:hover{background:rgb(0 0 0/.9)}.toggle-btn.active{background:#4CAF50}.panel{color:#fff;background:rgb(0 0 0/.8);padding:12px;border-radius:6px;font-size:12px;margin-bottom:5px;min-width:200px;max-width:310px;display:none}.panel.visible{display:block}.panel button{background:#4CAF50;color:#fff;border:none;padding:6px 12px;border-radius:3px;cursor:pointer;font-size:11px;margin:2px}.panel button:hover{background:#45a049}.panel button:disabled{background:#666;cursor:not-allowed}.edit-indicator{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#ff6b6b;font-size:16px;font-weight:700;text-shadow:2px 2px 4px rgb(0 0 0/.8);z-index:99;pointer-events:none;display:none}.edit-indicator.visible{display:block}.controls-text{font-size:10px;color:#ccc;margin-top:8px;line-height:1.3}.tooltip-container{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:auto;z-index:150}.tooltip{background:rgb(0 0 0/.9);color:#fff;padding:8px 12px;border-radius:6px;font-size:14px;font-family:-apple-system,BlinkMacSystemFont,sans-serif;white-space:nowrap;box-shadow:0 2px 8px rgb(0 0 0/.4);border:1px solid rgb(255 255 255/.2);opacity:0;transform:translateY(10px);transition:all 0.3s ease;cursor:pointer}.tooltip:hover{background:rgb(76 175 80/.3);border-color:#4CAF50;transform:translateY(-2px);box-shadow:0 4px 12px rgb(0 0 0/.6)}.tooltip.visible{opacity:1;transform:translateY(0)}.tooltip.interact{border-color:#4CAF50;background:rgb(76 175 80/.2);backdrop-filter:blur(4px)}.interact-prompt{color:#fff;font-weight:700;font-size:12px;margin-top:4px}.sprite-debug-panel{position:relative!important;top:120px;right:20px;background:rgb(0 0 0/.8);color:#fff;padding:10px;border-radius:5px;display:none;min-width:250px}.pip-reference{position:relative;bottom:0;left:0;width:64px;height:64px;border:2px solid #4CAF50;border-radius:5px;background:rgb(0 0 0/.8);z-index:200}.pip-reference.visible{display:block}.pip-reference img{width:100%;height:100%;object-fit:cover;border-radius:3px}.pip-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background-image:linear-gradient(to right,rgb(255 255 255/.3)0,transparent 1px),linear-gradient(to bottom,rgb(255 255 255/.3)0,transparent 1px);background-size:15px 15px;pointer-events:none}.pip-label{position:absolute;bottom:-20px;left:0;right:0;text-align:center;font-size:10px;color:#ccc;font-weight:700}#spriteDebugPanel input[type="number"]{background:rgb(255 255 255/.1);border:1px solid rgb(255 255 255/.3);color:#fff;padding:2px 4px;border-radius:2px;margin:0 5px}#spriteDebugPanel input[type="range"]{width:100px;margin:0 5px}#spriteDebugPanel label{display:inline-block;width:60px;font-size:11px}.sprite-debug-panel.visible{display:block}.isla-button{font-family:monospace;font-size:1.2em;font-weight:bold;color:#181818;background:linear-gradient(to bottom,#ffe76b 0%,#ffc933 40%,#e68a00 100%);border:none;border-radius:12px;padding:20px 40px;box-shadow:inset 0 1px 0 rgba(255,255,255,.8),0 3px 0 #c56a00,0 5px 8px rgba(0,0,0,.25);cursor:pointer;text-transform:uppercase;transition:all.15s ease-in-out}.isla-button:hover{filter:brightness(1.15)}.isla-button:active{transform:translateY(3px);box-shadow:inset 0 1px 0 rgba(255,255,255,.8),0 2px 0 #c56a00,0 3px 6px rgba(0,0,0,.25)}.intro-overlay{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(1,255,255,0.45);backdrop-filter:blur(3px);display:flex;align-items:flex-start;justify-content:center;z-index:1000;opacity:1;transition:opacity 0.5s ease}.intro-overlay.hidden{opacity:0;pointer-events:none}.intro-content{text-align:center;color:white;max-width:500px;padding:40px}.intro-title{font-size:3.5rem;font-weight:bold;margin-bottom:24px;text-shadow:2px 2px 8px rgba(0,0,0,0.8);letter-spacing:2px}.intro-description{font-size:1.1rem;line-height:1.6;text-shadow:1px 2px 2px rgba(0,0,0,0.55),-1px 1px 10px rgba(0,0,0,0.85);margin-bottom:32px;opacity:0.9}.start-button{background:#43aa8b;color:white;border:none;padding:16px 32px;border-radius:8px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(67,170,139,0.3)}.start-button:hover{background:#4fc3f7;transform:translateY(-2px);box-shadow:0 6px 16px rgba(79,195,247,0.4)}#mobileGameUI{display:none;position:fixed;bottom:0;left:0;right:0;background:linear-gradient(135deg,#4db6ac 0%,#26a69a 100%);border-top-left-radius:20px;border-top-right-radius:20px;box-shadow:0 -8px 32px rgba(0,0,0,0.3);z-index:200;padding:16px;max-height:50vh;transition:all 0.3s ease;overflow:hidden}#mobileGameUI.minimized{max-height:80px}#playerSection{display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-shrink:0}#playerAvatar{width:50px;height:50px;border-radius:50%;background:linear-gradient(45deg,#ff7043 0%,#f4511e 100%);border:3px solid rgba(255,255,255,0.3);display:flex;align-items:center;justify-content:center;color:#fff;font-size:18px;font-weight:bold;box-shadow:0 4px 12px rgba(0,0,0,0.2)}#playerInfo{flex:1}#playerName{color:#fff;font-size:16px;font-weight:600;text-shadow:1px 1px 2px rgba(0,0,0,0.3)}#playerStatus{color:rgba(255,255,255,0.8);font-size:14px;margin-top:2px}#chatToggle{background:rgba(255,255,255,0.2);color:#fff;border:none;padding:8px 16px;border-radius:20px;cursor:pointer;font-size:12px;font-weight:600;backdrop-filter:blur(10px);transition:all 0.2s;box-shadow:0 2px 8px rgba(0,0,0,0.1)}#chatToggle:hover{background:rgba(255,255,255,0.3);transform:translateY(-1px)}#settingsBtn{background:rgba(255,255,255,0.15);color:#fff;border:none;padding:6px 10px;border-radius:15px;cursor:pointer;font-size:11px;margin-left:8px}#chatContainer{background:rgba(255,255,255,0.98);border-radius:16px;margin:0 -4px;max-height:320px;display:none;flex-direction:column;box-shadow:inset 0 2px 8px rgba(0,0,0,0.1);overflow:hidden}#chatContainer.show{display:flex}#chatHeader{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid rgba(0,0,0,0.1);background:rgba(0,0,0,0.02);flex-shrink:0}#roomName{font-weight:600;color:#333;font-size:14px}#chatStatus{width:8px;height:8px;border-radius:50%;background:#10b981}#chatStatus.offline{background:#ef4444}#chatStatus.connecting{background:#f59e0b}#chatMessages{flex:1;padding:12px;overflow-y:auto;max-height:200px;scrollbar-width:thin;scrollbar-color:rgba(0,0,0,0.2) transparent}#chatMessages::-webkit-scrollbar{width:4px}#chatMessages::-webkit-scrollbar-track{background:transparent}#chatMessages::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.2);border-radius:2px}.msg{margin-bottom:8px;padding:8px 10px;background:#f8f9fa;border-radius:8px;border-left:3px solid #e5e7eb;position:relative;font-size:12px;line-height:1.4;animation:slideIn 0.2s ease}.msg.own{background:#e3f2fd;border-left-color:#2196f3;margin-left:20px}.msg.admin{border-left-color:#9c27b0}.msg.mod{border-left-color:#ff9800}.msg.pending{opacity:0.7;border-left-color:#ffc107}.msg.error{background:#ffebee;border-left-color:#f44336}.msg-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}.username{font-weight:600;color:#424242;font-size:11px;display:flex;align-items:center;gap:4px}.timestamp{font-size:9px;color:#9e9e9e}.badge{font-size:8px;background:#757575;color:#fff;padding:1px 4px;border-radius:6px;margin-left:4px}.badge.admin{background:#9c27b0}.badge.mod{background:#ff9800}.msg-text{color:#333;margin-bottom:6px;word-wrap:break-word}.vote-section{display:flex;align-items:center;justify-content:space-between;font-size:10px}.vote-btns{display:flex;gap:4px;align-items:center}.vote-btn{background:none;border:1px solid #ddd;border-radius:4px;width:20px;height:18px;cursor:pointer;font-size:10px;display:flex;align-items:center;justify-content:center;color:#666;transition:all 0.15s}.vote-btn:hover{background:#f5f5f5}.vote-btn.active{color:#fff}.vote-btn.up.active{background:#4caf50;border-color:#4caf50}.vote-btn.down.active{background:#f44336;border-color:#f44336}.vote-score{font-size:9px;color:#666;margin:0 4px;min-width:16px;text-align:center}.mod-btns{display:none;gap:2px}.msg:hover .mod-btns{display:flex}.mod-btn{background:#f44336;color:#fff;border:none;width:16px;height:16px;border-radius:3px;cursor:pointer;font-size:8px;display:flex;align-items:center;justify-content:center}.mod-btn.mute{background:#ff9800}#chatInputArea{display:flex;gap:8px;padding:12px;border-top:1px solid rgba(0,0,0,0.1);background:rgba(0,0,0,0.01);flex-shrink:0}#chatInput{flex:1;border:1px solid #ddd;background:#fff;border-radius:20px;padding:8px 16px;font-size:13px;outline:none;resize:none;max-height:60px;min-height:36px;transition:border-color 0.2s}#chatInput:focus{border-color:#4db6ac}#sendBtn{background:linear-gradient(135deg,#4db6ac,#26a69a);color:#fff;border:none;border-radius:50%;width:36px;height:36px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all 0.2s;box-shadow:0 2px 8px rgba(77,182,172,0.3)}#sendBtn:hover:not(:disabled){transform:scale(1.05);box-shadow:0 4px 12px rgba(77,182,172,0.4)}#sendBtn:disabled{opacity:0.5;cursor:not-allowed}.empty-chat{text-align:center;color:#999;padding:20px 12px;font-size:13px}@keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1000}.modal.show{display:flex}.modal-content{background:#fff;border-radius:12px;padding:20px;max-width:90vw;width:400px;max-height:80vh;overflow-y:auto}.modal h3{margin-bottom:16px;color:#333;font-size:16px}.form-group{margin-bottom:12px}.label{display:block;margin-bottom:6px;font-size:12px;color:#555;font-weight:500}.input{width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:13px}.input:focus{outline:none;border-color:#4db6ac}.btn{padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:500;margin-right:8px;margin-bottom:8px;transition:all 0.2s}.btn.primary{background:#4db6ac;color:#fff}.btn.primary:hover{background:#26a69a}.btn.success{background:#4caf50;color:#fff}.btn.success:hover{background:#388e3c}.btn.danger{background:#f44336;color:#fff}.btn.danger:hover{background:#d32f2f}.btn.warning{background:#ff9800;color:#fff}.btn.warning:hover{background:#f57c00}.btn:disabled{opacity:0.5;cursor:not-allowed}.notif{position:fixed;top:16px;right:16px;padding:12px 16px;border-radius:8px;color:#fff;font-size:12px;z-index:2000;max-width:250px;box-shadow:0 4px 12px rgba(0,0,0,0.2)}.notif.success{background:#4caf50}.notif.error{background:#f44336}.notif.warning{background:#ff9800}@media(max-width:480px){#mobileGameUI{padding:12px;max-height:45vh}#playerAvatar{width:44px;height:44px;font-size:16px}#playerName{font-size:15px}#playerStatus{font-size:13px}#chatMessages{max-height:160px}.modal-content{width:95vw;padding:16px}}</style></head><body><div id="introOverlay" class="intro-overlay"><div class="intro-content"><h1 class="intro-title"><img src="https://i.imgur.com/rWDfHo1.png" style="max-width: 100%;" alt=""></h1><p class="intro-description">Bienvenido a una isla que crece contigo.Cada vez que vives una historia,ayudas a alguien o aprendes algo nuevo,tu isla se transforma.Cada experiencia deja su huella.</p><br><button id="startButton" class="isla-button">Iniciar Aventura</button></div></div><canvas id="gameCanvas"></canvas><div class="ui-container"><button id="debugToggle" style="display: none;" class="toggle-btn">DBG</button><button id="editToggle" style="display: none;" class="toggle-btn">Edit Mode</button><button id="spriteDebugToggle" style="display: none;" class="toggle-btn">Sprite Debug</button><div id="debugPanel" class="panel"><div><strong>Debug Info</strong></div><div>FPS:<span id="fps">60</span></div><div>Camera:<span id="cameraPos">0,0,0</span></div><div>Zoom:<span id="zoomLevel">1.0</span></div><div style="margin: 8px 0; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 8px;"><div><strong>Terrain Seed</strong></div><div style="font-family: monospace; font-size: 10px; word-break: break-all; margin: 4px 0;"><span id="currentSeed">Loading...</span></div><div><button id="exportBtn" style="font-size: 10px; padding: 4px 8px; margin: 2px;">Export</button><button id="importBtn" style="font-size: 10px; padding: 4px 8px; margin: 2px;">Import</button></div></div><div class="light-control"><label>Light X</label><input id="lx" type="range" min="-100" max="100" step="0.5" value="50"><label>Light Y</label><input id="ly" type="range" min="-100" max="100" step="0.5" value="50"><label>Light Z</label><input id="lz" type="range" min="-100" max="100" step="0.5" value="25"><label>Color</label><input id="lcolor" type="color" value="#fff6e0"><label for="lightSlider">Light Power</label><input id="lightSlider" type="range" min="0" max="2" step="0.01" value="0.95"/></div><div class="controls-text"><div><strong>Desktop:</strong>WASD/Arrows=Move|Wheel=Zoom|Drag=Pan</div><div><strong>Mobile:</strong>Drag=Pan|Pinch=Zoom|Tap=Select</div></div></div><div id="spriteDebugPanel" class="panel sprite-debug-panel"><div><strong>Sprite Debug</strong></div><div><button id="terrainSpriteToggle">Terrain:Sprites</button></div><div style="margin: 8px 0;"><label>U Offset:</label><input type="number" id="uOffsetInput" step="0.01" value="0" style="width: 60px;"><input type="range" id="uOffset" min="-2" max="2" step="0.01" value="0"></div><div style="margin: 8px 0;"><label>V Offset:</label><input type="number" id="vOffsetInput" step="0.01" value="0" style="width: 60px;"><input type="range" id="vOffset" min="-2" max="2" step="0.01" value="0"></div><div style="margin: 8px 0;"><label>U Scale:</label><input type="number" id="uScaleInput" step="0.1" value="1" style="width: 60px;"><input type="range" id="uScale" min="0.1" max="5" step="0.01" value="1"></div><div style="margin: 8px 0;"><label>V Scale:</label><input type="number" id="vScaleInput" step="0.1" value="1" style="width: 60px;"><input type="range" id="vScale" min="0.1" max="5" step="0.01" value="1"></div><div style="margin: 8px 0;"><button id="resetTextureBtn" style="background: #f44336;">Reset Texture</button></div><div id="pipReference" class="pip-reference"><img id="pipImage" src="https://i.imgur.com/C4l87Xp.png" alt="Texture Reference"><div class="pip-overlay"></div><div class="pip-label">Texture Atlas</div></div></div><div id="editPanel" class="panel"><div><strong>Tile Editor</strong></div><div style="margin: 8px 0;">Selected:<span id="selectedTile">None</span>|Height:<span id="selectedHeight">-</span></div><div><button id="raiseBtn" disabled>Raise(+)</button><button id="lowerBtn" disabled>Lower(-)</button><button id="clearBtn">Clear</button></div><div class="controls-text">Click tiles to select|Shift+Click=Lower|Ctrl+Click=Reset</div></div></div><div id="editIndicator" class="edit-indicator">EDIT MODE ACTIVE</div><div id="tooltipContainer" class="tooltip-container"></div><div id="mobileGameUI"><div id="playerSection"><div id="playerAvatar">P</div><div id="playerInfo"><div id="playerName">PLAYER</div><div id="playerStatus">OKAY</div></div><button id="chatToggle">💬 Chat</button><button id="settingsBtn">⚙️</button></div><div id="chatContainer"><div id="chatHeader"><div id="roomName">MiniGeo Chat</div><div id="chatStatus"></div></div><div id="chatMessages"><div class="empty-chat">Conectando al chat...</div></div><div id="chatInputArea"><textarea id="chatInput" placeholder="Escribe tu mensaje..." disabled></textarea><button id="sendBtn" disabled>📤</button></div></div></div><div class="modal" id="settingsModal"><div class="modal-content"><h3>⚙️ Configuración</h3><div class="form-group"><label class="label">Nombre</label><input type="text" class="input" id="userName" placeholder="Tu nombre" maxlength="50"></div><div class="form-group"><label class="label">Sala</label><select class="input" id="roomSelect"><option value="">Seleccionar sala...</option></select></div><button class="btn primary" onclick="updateUser()">Actualizar</button><button class="btn warning" onclick="showAdminLogin()" id="adminLoginBtn">🔐 Admin</button><div id="adminPanel" style="display:none"><hr style="margin:12px 0;border:none;border-top:1px solid #eee"><h4 style="margin-bottom:8px;color:#555">Administración</h4><div class="form-group"><label class="label">Usuario a silenciar</label><input type="text" class="input" id="muteUser" placeholder="ID del usuario"></div><div class="form-group"><label class="label">Duración (min)</label><input type="number" class="input" id="muteTime" value="10"></div><button class="btn warning" onclick="muteUser()">Silenciar</button><div class="form-group"><label class="label">Promover a moderador</label><input type="text" class="input" id="promoteUser" placeholder="ID del usuario"></div><button class="btn primary" onclick="promoteUser()">Promover</button><div class="form-group"><label class="label">Degradar moderador</label><input type="text" class="input" id="demoteUser" placeholder="ID del usuario"></div><button class="btn danger" onclick="demoteUser()">Degradar</button><button class="btn primary" onclick="showModerators()">👥 Ver Moderadores</button><div id="modList" style="display:none;margin:8px 0;padding:8px;background:#f5f5f5;border-radius:6px"></div><hr style="margin:12px 0;border:none;border-top:1px solid #eee"><button class="btn success" onclick="showCreateRoom()">Nueva Sala</button><div class="form-group"><label class="label">Sala a eliminar</label><input type="text" class="input" id="delRoom" placeholder="Nombre de la sala"></div><button class="btn danger" onclick="delRoom()">Eliminar Sala</button></div><button class="btn" onclick="closeModal('settingsModal')">Cerrar</button></div></div><div class="modal" id="createRoomModal"><div class="modal-content"><h3>Nueva Sala</h3><div class="form-group"><label class="label">Nombre de la sala</label><input type="text" class="input" id="newRoomName" placeholder="Nombre" maxlength="30"></div><button class="btn success" onclick="createRoom()">Crear</button><button class="btn" onclick="closeModal('createRoomModal')">Cancelar</button></div></div><div class="modal" id="adminLoginModal"><div class="modal-content"><h3>🔐 Acceso Admin</h3><div class="form-group"><label class="label">Contraseña</label><input type="password" class="input" id="adminPass" placeholder="Contraseña de admin"></div><button class="btn primary" onclick="adminLogin()">Entrar</button><button class="btn" onclick="closeModal('adminLoginModal')">Cancelar</button></div></div><script>const USE_SPRITE_PLAYER=!0,USE_SPRITE_TERRAIN=!0;const API='https://chat.minigeo.org';const adjectives=['Genial','Increible','Fantastico','Brillante','Magnifico','Excelente','Asombroso','Estupendo','Maravilloso','Espectacular','Fabuloso','Sensacional','Extraordinario','Fenomenal','Impresionante','Sorprendente','Radiante','Vibrante','Dinamico','Energico','Creativo','Innovador','Inspirador','Optimista','Positivo','Alegre','Divertido','Encantador','Carismatico','Inteligente'];let u={id:genId(),name:generateRandomName(),isMod:!1,isAdmin:!1,token:''};let cr=null,rooms=[],msgs=[],poll=null,lastMsg=null,conn=!1,retry=0,pendingMsgs=new Map();const MAX_RETRY=5,POLL_INT=3000,RETRY_DELAY=5000;function generateRandomName(){const adj=adjectives[Math.floor(Math.random()*adjectives.length)];const num=String(Math.floor(Math.random()*90)+10);return `${adj}${num}`}function genId(){const t=Date.now().toString(36),r=Math.random().toString(36).substr(2,9);return `user_${t}_${r}`.substr(0,24)}function genTempId(){return `temp_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async function loadUser(){const s=localStorage.getItem('minigeoUser');if(s){try{const p=JSON.parse(s);u={...u,...p};if(!u.name)u.name=generateRandomName()}catch(e){localStorage.removeItem('minigeoUser');u.name=generateRandomName()}}else{u.name=generateRandomName()}document.getElementById('userName').value=u.name||'';updateUIFromUser()}function saveUser(){localStorage.setItem('minigeoUser',JSON.stringify(u))}function updateUIFromUser(){if(u.isMod||u.isAdmin){document.getElementById('adminPanel').style.display='block';document.getElementById('adminLoginBtn').style.display='none'}}async function fetchTo(url,opt={},timeout=10000){const ctrl=new AbortController();const id=setTimeout(()=>ctrl.abort(),timeout);try{const headers=opt.headers||{};if(u.token)headers.Authorization=`Bearer ${u.token}`;const r=await fetch(url,{...opt,headers,signal:ctrl.signal});clearTimeout(id);return r}catch(e){clearTimeout(id);throw e}}function showAdminLogin(){document.getElementById('adminLoginModal').classList.add('show')}async function showSettings(){if(rooms.length===0)await loadRooms();const modal=document.getElementById('settingsModal');const select=document.getElementById('roomSelect');select.innerHTML='<option value="">Seleccionar sala...</option>';rooms.forEach(room=>{const option=document.createElement('option');option.value=room.name;option.textContent=room.displayName||room.name;if(room.name===cr)option.selected=!0;select.appendChild(option)});select.onchange=()=>{if(select.value)joinRoom(select.value)};modal.classList.add('show')}function showCreateRoom(){closeModal('settingsModal');document.getElementById('createRoomModal').classList.add('show')}async function updateUser(){const name=document.getElementById('userName').value.trim();if(!name){showNotif('Ingresa un nombre','error');return}if(name.length<2){showNotif('Nombre muy corto','error');return}try{const r=await fetchTo(`${API}/api/users`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:u.id,name})});const d=await r.json();if(r.ok){u.name=name;if(d.user&&d.user.isMod!==undefined)u.isMod=d.user.isMod;if(d.user&&d.user.isAdmin!==undefined)u.isAdmin=d.user.isAdmin;saveUser();updateUIFromUser();document.getElementById('playerName').textContent=name;showNotif('Actualizado','success')}else throw new Error(d.error||'Error al actualizar')}catch(e){console.error(e);showNotif('Error al actualizar','error')}}async function adminLogin(){const pass=document.getElementById('adminPass').value;if(!pass)return;try{const r=await fetchTo(`${API}/api/admin-login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:pass})});const d=await r.json();if(r.ok){u.isAdmin=!0;u.isMod=!0;u.token=d.token;saveUser();updateUIFromUser();closeModal('adminLoginModal');showNotif('Acceso admin concedido','success')}else{throw new Error(d.error||'Contraseña incorrecta')}}catch(e){console.error(e);showNotif('Contraseña incorrecta','error')}}async function loadRooms(){try{const r=await fetchTo(`${API}/api/rooms`);const d=await r.json();if(r.ok){rooms=d.rooms||[];}else throw new Error(d.error||'Error cargando salas')}catch(e){console.error(e)}}async function createRoom(){const name=document.getElementById('newRoomName').value.trim();if(!name||name.length<2){showNotif('Nombre inválido','error');return}try{const r=await fetchTo(`${API}/api/rooms`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({roomName:name,createdBy:u.name||'Anónimo'})});const d=await r.json();if(r.ok){document.getElementById('newRoomName').value='';closeModal('createRoomModal');await loadRooms();await joinRoom(d.roomName||name);showNotif('Sala creada','success')}else throw new Error(d.error||'Error creando sala')}catch(e){console.error(e);showNotif('Error al crear','error')}}async function joinRoom(name){if(cr===name)return;if(!u.name){showNotif('Configura tu nombre primero','error');return}try{if(cr)await leaveRoom(cr);const r=await fetchTo(`${API}/api/join-room`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:u.id,roomName:name,userName:u.name})});const d=await r.json();if(r.ok){cr=name;const room=rooms.find(r=>r.name===name);document.getElementById('roomName').textContent=room?.displayName||name;document.getElementById('chatInput').disabled=!1;document.getElementById('sendBtn').disabled=!1;clearMsgs();await loadMsgs();showNotif(`Unido a ${room?.displayName||name}`,'success')}else throw new Error(d.error||'Error al unirse')}catch(e){console.error(e);showNotif('Error al unirse','error')}}async function leaveRoom(name){try{await fetchTo(`${API}/api/leave-room`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId:u.id,roomName:name})})}catch(e){console.error(e)}}async function loadMsgs(){if(!cr||!conn)return;try{let url=`${API}/api/messages?room=${cr}&limit=30&userId=${u.id}`;if(lastMsg)url+=`&since=${lastMsg}`;const r=await fetchTo(url,{},5000);const d=await r.json();if(r.ok&&d.messages){if(d.messages.length>0){addMsgs(d.messages);lastMsg=d.messages[d.messages.length-1].timestamp}if(!conn){conn=!0;updateStat('online');retry=0}}else throw new Error(d.error||'Error cargando mensajes')}catch(e){console.error(e);if(conn){conn=!1;updateStat('offline');scheduleRetry()}}}function addMsgs(newMsgs){const had=msgs.length>0;newMsgs.forEach(m=>{const existingIndex=msgs.findIndex(x=>x.id===m.id);if(existingIndex!==-1){msgs[existingIndex]=m}else{const pendingIndex=msgs.findIndex(x=>x.tempId&&pendingMsgs.has(x.tempId));if(pendingIndex!==-1&&msgs[pendingIndex].message===m.message&&msgs[pendingIndex].userId===m.userId){pendingMsgs.delete(msgs[pendingIndex].tempId);msgs[pendingIndex]=m}else{msgs.push(m)}}});if(msgs.length>100)msgs=msgs.slice(-100);renderMsgs();const cont=document.getElementById('chatMessages');if(!had||(cont.scrollTop+cont.clientHeight>=cont.scrollHeight-50))scrollBot()}function clearMsgs(){msgs=[];lastMsg=null;pendingMsgs.clear();renderMsgs()}function renderMsgs(){const cont=document.getElementById('chatMessages');if(!msgs.length){if(cr){cont.innerHTML='<div class="empty-chat">Cargando mensajes...</div>'}else{cont.innerHTML='<div class="empty-chat">Selecciona una sala en configuración</div>'}return}cont.innerHTML='';msgs.forEach(m=>{const div=document.createElement('div');let classes=`msg ${m.userId===u.id?'own':''}`;if(m.isAdmin)classes+=' admin';else if(m.isMod)classes+=' mod';if(m.pending)classes+=' pending';if(m.error)classes+=' error';div.className=classes;const time=new Date(m.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});let badges='';if(m.isAdmin)badges='<span class="badge admin">A</span>';else if(m.isMod)badges='<span class="badge mod">M</span>';let modBtns='';if(m.userId!==u.id&&(u.isMod||u.isAdmin)&&!m.pending){modBtns=`<div class="mod-btns"><button class="mod-btn mute" onclick="quickMute('${m.userId}')">M</button><button class="mod-btn" onclick="kickUser('${m.userId}')">K</button></div>`}let voteBtns='';if(!m.pending){const score=(m.karma?.up||0)-(m.karma?.down||0);const isOwn=m.userId===u.id;if(isOwn){voteBtns=`<div class="vote-btns"><span class="vote-score">${score>0?'+':''}${score}</span></div>`}else{const upClass=m.userVote==='up'?'active':'';const downClass=m.userVote==='down'?'active':'';voteBtns=`<div class="vote-btns"><button class="vote-btn up ${upClass}" onclick="vote('${m.id}','up')">👍</button><span class="vote-score">${score>0?'+':''}${score}</span><button class="vote-btn down ${downClass}" onclick="vote('${m.id}','down')">👎</button></div>`}}let statusIcon='';if(m.pending)statusIcon='<span style="color:#f59e0b;font-size:8px"> ⏳</span>';if(m.error)statusIcon='<span style="color:#ef4444;font-size:8px"> ❌</span>';div.innerHTML=`<div class="msg-header"><span class="username">${esc(m.userName||'Usuario')}${badges}${statusIcon}</span><span class="timestamp">${time}</span></div><div class="msg-text">${esc(m.message||'')}</div><div class="vote-section">${voteBtns}${modBtns}</div>`;cont.appendChild(div)})}async function vote(messageId,voteType){if(!cr||!u.id)return;const msg=msgs.find(m=>m.id===messageId);if(!msg||msg.pending||msg.userId===u.id)return;const prevVote=msg.userVote;const newVote=prevVote===voteType?null:voteType;const originalKarma={...msg.karma};const originalUserVote=msg.userVote;msg.karma=msg.karma||{up:0,down:0};if(prevVote==='up')msg.karma.up=Math.max(0,(msg.karma.up||0)-1);if(prevVote==='down')msg.karma.down=Math.max(0,(msg.karma.down||0)-1);if(newVote==='up')msg.karma.up=(msg.karma.up||0)+1;if(newVote==='down')msg.karma.down=(msg.karma.down||0)+1;msg.userVote=newVote;renderMsgs();try{const r=await fetchTo(`${API}/api/vote`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messageId,roomName:cr,vote:newVote,userId:u.id})});const d=await r.json();if(r.ok){const msgIndex=msgs.findIndex(m=>m.id===messageId);if(msgIndex!==-1){msgs[msgIndex].karma=d.karma||{};msgs[msgIndex].userVote=d.userVote;renderMsgs()}}else{throw new Error(d.error||'Error al votar')}}catch(e){console.error(e);const msgIndex=msgs.findIndex(m=>m.id===messageId);if(msgIndex!==-1){msgs[msgIndex].karma=originalKarma;msgs[msgIndex].userVote=originalUserVote;renderMsgs()}showNotif('Error al votar','error')}}async function sendMsg(){const inp=document.getElementById('chatInput');const msg=inp.value.trim();if(!msg||!cr||!u.name)return;if(msg.length>1000){showNotif('Mensaje muy largo','error');return}const btn=document.getElementById('sendBtn');btn.disabled=!0;const tempId=genTempId();const tempMsg={id:tempId,tempId,message:msg,userId:u.id,userName:u.name,timestamp:new Date().toISOString(),pending:!0,isAdmin:u.isAdmin,isMod:u.isMod,karma:{up:0,down:0}};msgs.push(tempMsg);pendingMsgs.set(tempId,tempMsg);inp.value='';inp.style.height='auto';renderMsgs();scrollBot();try{const r=await fetchTo(`${API}/api/messages`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({roomName:cr,userId:u.id,userName:u.name,message:msg})});if(r.ok){const d=await r.json();if(d.message){const msgIndex=msgs.findIndex(m=>m.tempId===tempId);if(msgIndex!==-1){pendingMsgs.delete(tempId);msgs[msgIndex]={...d.message,tempId:undefined,pending:false};renderMsgs()}}}else{const d=await r.json();throw new Error(d.error||'Error al enviar')}}catch(e){console.error(e);const msgIndex=msgs.findIndex(m=>m.tempId===tempId);if(msgIndex!==-1){msgs[msgIndex].error=!0;msgs[msgIndex].pending=!1;renderMsgs()}showNotif('Error al enviar','error')}finally{btn.disabled=!1}}async function muteUser(){const userId=document.getElementById('muteUser').value.trim();const time=parseInt(document.getElementById('muteTime').value);if(!userId||!time){showNotif('Completa todos los campos','error');return}try{const r=await fetchTo(`${API}/api/moderate`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'mute',userId,duration:time,moderatorId:u.id})});const d=await r.json();if(r.ok){showNotif('Usuario silenciado','success');document.getElementById('muteUser').value=''}else{throw new Error(d.error||'Error al silenciar')}}catch(e){console.error(e);showNotif('Error al silenciar','error')}}async function promoteUser(){const userId=document.getElementById('promoteUser').value.trim();if(!userId){showNotif('Ingresa ID de usuario','error');return}try{const r=await fetchTo(`${API}/api/promote-user`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId,adminId:u.id})});const d=await r.json();if(r.ok){showNotif('Usuario promovido','success');document.getElementById('promoteUser').value=''}else{throw new Error(d.error||'Error al promover')}}catch(e){console.error(e);showNotif('Error al promover','error')}}async function demoteUser(){const userId=document.getElementById('demoteUser').value.trim();if(!userId){showNotif('Ingresa ID de usuario','error');return}try{const r=await fetchTo(`${API}/api/demote-user`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId,adminId:u.id})});const d=await r.json();if(r.ok){showNotif('Usuario degradado','success');document.getElementById('demoteUser').value=''}else{throw new Error(d.error||'Error al degradar')}}catch(e){console.error(e);showNotif('Error al degradar','error')}}async function showModerators(){const modList=document.getElementById('modList');try{const r=await fetchTo(`${API}/api/moderators`);const d=await r.json();if(r.ok){modList.innerHTML='';if(d.moderators&&d.moderators.length>0){d.moderators.forEach(modId=>{const div=document.createElement('div');div.innerHTML=`<span style="font-size:11px">${modId}</span><button class="btn danger" style="padding:2px 6px;font-size:9px;margin-left:8px" onclick="demoteUserDirect('${modId}')">Remove</button>`;modList.appendChild(div)})}else{modList.innerHTML='<div style="text-align:center;color:#666;padding:8px;font-size:11px">No hay moderadores</div>'}modList.style.display='block'}else{throw new Error(d.error||'Error al cargar')}}catch(e){console.error(e);showNotif('Error al cargar moderadores','error')}}async function demoteUserDirect(userId){if(!confirm(`¿Degradar a ${userId}?`))return;try{const r=await fetchTo(`${API}/api/demote-user`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({userId,adminId:u.id})});const d=await r.json();if(r.ok){showNotif('Usuario degradado','success');showModerators()}else{throw new Error(d.error||'Error al degradar')}}catch(e){console.error(e);showNotif('Error al degradar','error')}}async function delRoom(){const name=document.getElementById('delRoom').value.trim();if(!name){showNotif('Ingresa nombre de sala','error');return}if(!confirm(`¿Eliminar sala "${name}"?`))return;try{const r=await fetchTo(`${API}/api/rooms/${encodeURIComponent(name)}`,{method:'DELETE',headers:{'Content-Type':'application/json'},body:JSON.stringify({moderatorId:u.id})});const d=await r.json();if(r.ok){showNotif('Sala eliminada','success');document.getElementById('delRoom').value='';await loadRooms();if(cr===name){cr=null;document.getElementById('roomName').textContent='MiniGeo Chat';document.getElementById('chatInput').disabled=!0;document.getElementById('sendBtn').disabled=!0;clearMsgs()}}else{throw new Error(d.error||'Error al eliminar')}}catch(e){console.error(e);showNotif('Error al eliminar','error')}}async function quickMute(userId){if(!confirm('¿Silenciar usuario por 10 min?'))return;try{const r=await fetchTo(`${API}/api/moderate`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'mute',userId,duration:10,moderatorId:u.id})});const d=await r.json();if(r.ok)showNotif('Usuario silenciado','success');else showNotif(d.error||'Error al silenciar','error')}catch(e){console.error(e);showNotif('Error','error')}}async function kickUser(userId){if(!confirm('¿Expulsar usuario de la sala?'))return;try{const r=await fetchTo(`${API}/api/moderate`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'kick',userId,roomName:cr,moderatorId:u.id})});const d=await r.json();if(r.ok)showNotif('Usuario expulsado','success');else showNotif(d.error||'Error al expulsar','error')}catch(e){console.error(e);showNotif('Error','error')}}function startPoll(){if(poll)clearInterval(poll);poll=setInterval(pollMsgs,POLL_INT)}async function pollMsgs(){if(cr)await loadMsgs()}function updateStat(stat){const el=document.getElementById('chatStatus');el.className=stat==='online'?'':'offline connecting'.includes(stat)?stat:'';conn=stat==='online'}function scheduleRetry(){if(retry<MAX_RETRY){retry++;setTimeout(async()=>{updateStat('connecting');if(await testConn()){updateStat('online');retry=0;if(!poll)startPoll()}else{updateStat('offline');scheduleRetry()}},RETRY_DELAY*retry)}else{updateStat('offline');showNotif('Sin conexión','error')}}async function testConn(){try{const r=await fetchTo(`${API}/api/health`,{},5000);if(r.ok){conn=!0;return!0}}catch(e){console.error(e)}conn=!1;return!1}function esc(txt){if(!txt)return'';const div=document.createElement('div');div.textContent=txt;return div.innerHTML}function showNotif(msg,type='success'){document.querySelectorAll('.notif').forEach(el=>el.remove());const n=document.createElement('div');n.className=`notif ${type}`;n.textContent=msg;document.body.appendChild(n);setTimeout(()=>n.remove(),3000)}function scrollBot(){const cont=document.getElementById('chatMessages');cont.scrollTop=cont.scrollHeight}function closeModal(id){document.getElementById(id).classList.remove('show')}window.addEventListener('beforeunload',()=>{if(poll)clearInterval(poll);if(cr)navigator.sendBeacon(`${API}/api/leave-room`,JSON.stringify({userId:u.id,roomName:cr}))});class GameEngine{constructor(){this.lastFrameTime=performance.now(),this.deltaTime=0,this.targetFPS=60,this.frameInterval=1e3/this.targetFPS,this.gridSize=16,this.tileSize=2,this.heightLevels=8,this.editMode=!1,this.selectedTile=null,this.raycaster=new THREE.Raycaster,this.mouse=new THREE.Vector2,this.initialCameraState={position:new THREE.Vector3,target:new THREE.Vector3,zoom:1,preset:"default"},this.input={keys:{},mouse:{x:0,y:0,pressed:!1},touch:{active:!1,pinchDistance:0,moved:!1}},this.debugSystem="undefined"!=typeof DebugSystem?new DebugSystem(this):null,this.cloudSprites=[],this.terrainSystem=new TerrainSystem(this.gridSize,this.tileSize,this.heightLevels,!0),this.interactables=[],this.proximityRadius=2.5,this.activeTooltip=null,this.cameraSystem=new CameraSystem(this),this.init()}setupMobileOptimizations(){let e=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);e&&(this.renderer.shadowMap.type=THREE.BasicShadowMap,this.directionalLight.shadow.mapSize.setScalar(1024),this.cloudSprites=this.cloudSprites.slice(0,3),this.scene.traverse(e=>{e.isMesh&&e.material&&(e.material.precision="lowp")}),console.log("Mobile optimizations applied"))}init(){this.setupRenderer(),this.cameraSystem.setupCamera(),this.camera=this.cameraSystem.camera,this.setupScene(),this.setupLighting(),this.setupMobileOptimizations(),this.setupClouds(),this.setupTerrain(),this.setupInput(),this.setupUI(),this.setupInteractables(),this.player=new Player(this),this.setupIntro(),this.start()}setupIntro(){this.cameraSystem.setCameraPreset("overview",!1);let e=document.getElementById("introOverlay"),t=document.getElementById("startButton");t.onclick=()=>{this.cameraSystem.setCameraPreset("default",!0,()=>{console.log("Camera transition to default completed")}),e.classList.add("hidden"),setTimeout(()=>{e.style.display="none",this.showMobileUI()},500)}}showMobileUI(){const ui=document.getElementById("mobileGameUI");ui.style.display="block";document.getElementById("playerName").textContent=u.name;setTimeout(()=>{this.initChat()},1000)}async initChat(){await loadUser();try{await loadRooms();if(rooms.length>0){await joinRoom('mainroom')}updateStat('connecting');if(await testConn()){updateStat('online');startPoll();this.setupChatEvents()}else{updateStat('offline');scheduleRetry()}}catch(e){console.error('Chat init failed:',e);updateStat('offline')}}setupChatEvents(){const chatToggle=document.getElementById('chatToggle');const chatContainer=document.getElementById('chatContainer');const settingsBtn=document.getElementById('settingsBtn');const chatInput=document.getElementById('chatInput');const sendBtn=document.getElementById('sendBtn');chatToggle.onclick=()=>{const isShown=chatContainer.classList.contains('show');if(isShown){chatContainer.classList.remove('show');chatToggle.textContent='💬 Chat';document.getElementById('mobileGameUI').classList.add('minimized')}else{chatContainer.classList.add('show');chatToggle.textContent='❌ Close';document.getElementById('mobileGameUI').classList.remove('minimized')}};settingsBtn.onclick=()=>showSettings();chatInput.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg()}});chatInput.addEventListener('input',e=>{e.target.style.height='auto';e.target.style.height=Math.min(e.target.scrollHeight,60)+'px'});sendBtn.onclick=()=>sendMsg()}setupRenderer(){this.canvas=document.getElementById("gameCanvas"),this.renderer=new THREE.WebGLRenderer({canvas:this.canvas,antialias:!0}),this.renderer.setPixelRatio(Math.min(devicePixelRatio,2)),this.renderer.setSize(innerWidth,innerHeight),this.renderer.setClearColor(5223385),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=THREE.PCFSoftShadowMap}setCameraPreset(e,t=!0,i=null){let s=document.getElementById("confirmationDialog");s&&s.remove();let a=document.getElementById("npcQuestionDialog");a&&a.remove(),this.cameraSystem.setCameraPreset(e,t,i)}setupScene(){this.scene=new THREE.Scene,this.scene.fog=new THREE.Fog(5223385,30,100)}setupLighting(){this.scene.add(new THREE.AmbientLight(16777215,.4)),this.directionalLight=new THREE.DirectionalLight(16774880,.95),this.directionalLight.position.set(50,50,25),this.directionalLight.castShadow=!0,this.directionalLight.shadow.mapSize.setScalar(2048),Object.assign(this.directionalLight.shadow.camera,{near:.1,far:200,left:-50,right:50,top:50,bottom:-50}),this.scene.add(this.directionalLight)}setupClouds(){let e=new THREE.TextureLoader;e.load("https://i.imgur.com/mYRt74O.png",e=>{for(let t=0;t<6;t++){let i=new THREE.Sprite(new THREE.SpriteMaterial({map:e,opacity:.7,transparent:!0}));i.position.set((Math.random()-.5)*this.gridSize*this.tileSize,8+2*Math.random(),(Math.random()-.5)*this.gridSize*this.tileSize),i.scale.set(8+6*Math.random(),4+2*Math.random(),1),i.userData.speed=.01*(.5+.2*Math.random()),this.scene.add(i),this.cloudSprites.push(i)}})}setupTerrain(){this.terrainSystem.generateTerrain(),this.terrainSystem.loadFromSeed("9877766666677789877665555556677877665544445566777665444334445667765443333334456765543322223345566544321111234456654332100123345665433210012334566544321111234456655433222233455676544333333445677665444334445667776655444455667787766555555667789877766666677789"),this.scene.add(this.terrainSystem.terrainGroup),this.terrain=this.terrainSystem}setupInput(){["keydown","keyup"].forEach(e=>addEventListener(e,t=>this.input.keys[t.code]="keydown"===e)),["mousedown","mousemove","mouseup"].forEach(e=>this.canvas.addEventListener(e,t=>this.handleMouse(e,t))),this.canvas.addEventListener("click",e=>this.editMode&&this.handleTileClick(e)),this.canvas.addEventListener("wheel",e=>{e.preventDefault(),this.cameraSystem.zoomCamera(e.deltaY>0?.1:-.1)}),["touchstart","touchmove","touchend"].forEach(e=>{let t="handleTouch"+e.slice(5).charAt(0).toUpperCase()+e.slice(6);this.canvas.addEventListener(e,e=>{e.preventDefault(),"function"==typeof this[t]&&this[t](e)})}),addEventListener("resize",()=>this.handleResize())}setupUI(){document.getElementById("editToggle").onclick=()=>this.togglePanel("edit"),document.getElementById("raiseBtn").onclick=()=>this.modifySelected(1),document.getElementById("lowerBtn").onclick=()=>this.modifySelected(-1),document.getElementById("clearBtn").onclick=()=>confirm("Clear all terrain?")&&this.clearTerrain();let e=document.getElementById("lightSlider");e.oninput=e=>{this.directionalLight.intensity=parseFloat(e.target.value)},["lx","ly","lz"].forEach(e=>{document.getElementById(e).oninput=t=>this.directionalLight.position[e[1]]=parseFloat(t.target.value)}),document.getElementById("lcolor").oninput=e=>this.directionalLight.color.set(e.target.value)}togglePanel(e){this.editMode=!this.editMode;let t=document.getElementById("editPanel"),i=document.getElementById("editToggle"),s=document.getElementById("editIndicator");t.classList.toggle("visible",this.editMode),i.classList.toggle("active",this.editMode),s.classList.toggle("visible",this.editMode),this.canvas.style.cursor=this.editMode?"crosshair":"grab",this.editMode||this.clearSelection()}handleMouse(e,t){let i=this.input.mouse;"mousedown"===e?(i.pressed=!0,i.x=t.clientX,i.y=t.clientY):"mousemove"===e&&i.pressed&&!this.editMode?this.cameraSystem.panCamera(t.clientX-i.x,t.clientY-i.y):"mouseup"===e&&(i.pressed=!1),"mouseup"!==e&&(i.x=t.clientX,i.y=t.clientY)}handleTileClick(e){let t=this.canvas.getBoundingClientRect();this.mouse.set((e.clientX-t.left)/t.width*2-1,-(2*((e.clientY-t.top)/t.height))+1),this.raycaster.setFromCamera(this.mouse,this.camera);let i=this.terrainSystem.terrainGroup.children.filter(e=>50>e.position.distanceTo(this.camera.position)),s=this.raycaster.intersectObjects(i,!0);if(s.length){let a=s[0].object.userData;this.selectTile(a.x,a.z),e.shiftKey?this.modifyTileHeight(a.x,a.z,-1):e.ctrlKey||e.metaKey?this.setTileHeight(a.x,a.z,0):this.modifyTileHeight(a.x,a.z,1)}}selectTile(e,t){let i=this.terrainSystem.getTile(e,t);i&&(this.selectedTile={x:e,z:t,height:i.height},this.updateEditUI(),this.highlightTile(i.mesh))}clearSelection(){this.selectedTile=null,this.updateEditUI(),this.removeHighlight()}highlightTile(e){if(this.removeHighlight(),e.isGroup){let t=.9*this.tileSize,i=new THREE.RingGeometry(.6*t,.65*t,16),s=new THREE.MeshBasicMaterial({color:16777215,transparent:!0,opacity:.8,side:THREE.DoubleSide});this.tileHighlight=new THREE.Mesh(i,s),this.tileHighlight.rotation.x=-Math.PI/2,this.tileHighlight.position.copy(e.position);let a=this.getTileFromMesh(e);a&&(this.tileHighlight.position.y=.5+.5*a.height+.02),this.scene.add(this.tileHighlight)}else{let n=new THREE.EdgesGeometry(e.geometry);this.tileHighlight=new THREE.LineSegments(n,new THREE.LineBasicMaterial({color:16777215,linewidth:3})),this.tileHighlight.position.copy(e.position),this.tileHighlight.position.y+=.01,this.scene.add(this.tileHighlight)}}getTileFromMesh(e){return e.userData&&void 0!==e.userData.x?this.terrainSystem.getTile(e.userData.x,e.userData.z):null}removeHighlight(){this.tileHighlight&&(this.scene.remove(this.tileHighlight),this.tileHighlight.geometry.dispose(),this.tileHighlight.material.dispose(),this.tileHighlight=null)}modifySelected(e){this.selectedTile&&this.modifyTileHeight(this.selectedTile.x,this.selectedTile.z,e)}modifyTileHeight(e,t,i){let s=this.terrainSystem.getTile(e,t);if(s){let a=Math.max(0,Math.min(this.heightLevels-1,s.height+i));a!==s.height&&(this.terrainSystem.updateTileHeight(e,t,a),this.selectedTile?.x===e&&this.selectedTile?.z===t&&(this.selectedTile.height=a,this.updateEditUI(),this.highlightTile(s.mesh)))}}setTileHeight(e,t,i){let s=this.terrainSystem.getTile(e,t);s&&s.height!==i&&(this.terrainSystem.updateTileHeight(e,t,i),this.selectedTile?.x===e&&this.selectedTile?.z===t&&(this.selectedTile.height=i,this.updateEditUI(),this.highlightTile(s.mesh)))}clearTerrain(){this.terrainSystem.clearTerrain(),this.clearSelection()}updateEditUI(){let e=["selectedTile","selectedHeight","raiseBtn","lowerBtn"].map(e=>document.getElementById(e));this.selectedTile?(e[0].textContent=`${this.selectedTile.x},${this.selectedTile.z}`,e[1].textContent=this.selectedTile.height,e[2].disabled=!this.editMode||this.selectedTile.height>=this.heightLevels-1,e[3].disabled=!this.editMode||this.selectedTile.height<=0):(e[0].textContent="None",e[1].textContent="-",e.slice(2).forEach(e=>e.disabled=!0))}handleTouchStart(e){let t=e.touches;1===t.length?Object.assign(this.input.touch,{active:!0,moved:!1,start:{x:t[0].clientX,y:t[0].clientY}}):2===t.length&&(this.input.touch.pinchDistance=Math.hypot(t[0].clientX-t[1].clientX,t[0].clientY-t[1].clientY),this.input.touch.moved=!1)}handleTouchMove(e){let t=e.touches;if(1===t.length&&this.input.touch.active){let i={x:(t[0].clientX-this.input.touch.start.x)/window.innerWidth,y:(t[0].clientY-this.input.touch.start.y)/window.innerHeight},s=Math.hypot(i.x,i.y);s>0&&!this.editMode&&(this.input.touch.moved=!0,this.cameraSystem.panCamera(70*i.x,70*i.y))}else if(2===t.length){let a=Math.hypot(t[0].clientX-t[1].clientX,t[0].clientY-t[1].clientY);this.cameraSystem.zoomCamera((this.input.touch.pinchDistance-a)*.01),this.input.touch.pinchDistance=a,this.input.touch.moved=!0}}handleTouchEnd(e){if(this.input.touch.active&&1===e.changedTouches.length){let t=e.changedTouches[0],i=!this.input.touch.moved;if(this.editMode&&i)this.handleTileClick({clientX:t.clientX,clientY:t.clientY,shiftKey:!1,ctrlKey:!1,metaKey:!1});else if(!this.editMode&&i){let s=this.canvas.getBoundingClientRect();this.mouse.set((t.clientX-s.left)/s.width*2-1,-(2*((t.clientY-s.top)/s.height))+1),this.raycaster.setFromCamera(this.mouse,this.camera);let a=this.raycaster.intersectObjects(this.terrainSystem.terrainGroup.children,!0);if(a.length){let{x:n,z:o}=a[0].object.userData;this.player&&this.player.sprite&&this.player.findPath(this.player.pos,{x:n,z:o},e=>{this.player.path=e,this.player.progress=0})}}}Object.assign(this.input.touch,{active:!1,start:null,moved:!1})}handleKeyboardInput(){this.cameraSystem.handleKeyboardCameraInput(),this.input.keys.KeyE&&!this.input.keys._ePressed?(this.input.keys._ePressed=!0,this.handleInteraction()):this.input.keys.KeyE||(this.input.keys._ePressed=!1)}handleResize(){this.cameraSystem.handleResize(),this.renderer.setSize(innerWidth,innerHeight),this.renderer.setPixelRatio(Math.min(devicePixelRatio,2))}start(){this.animate()}animate(){requestAnimationFrame(()=>this.animate());let e=performance.now();this.deltaTime=Math.min(e-this.lastFrameTime,33.33),this.lastFrameTime=e,this.update(),this.render(),this.debugSystem&&this.debugSystem.updatePerformanceStats()}update(){if(this.handleKeyboardInput(),this.cameraSystem.update(),this.cloudSprites.forEach((e,t)=>{t%4==Date.now()/100%4|0&&(e.position.x+=e.userData.speed*(this.deltaTime/16.67),e.position.x>this.gridSize*this.tileSize&&(e.position.x=-this.gridSize*this.tileSize))}),this.selectedTile&&this.tileHighlight){let e=this.terrainSystem.getTile(this.selectedTile.x,this.selectedTile.z);e&&(this.tileHighlight.position.copy(e.mesh.position),this.tileHighlight.position.y=.5+.5*e.height+.02)}this.player&&this.player.update(),this.checkProximityInteractions()}render(){this.renderer.render(this.scene,this.camera)}setupInteractables(){[{x:12,z:11,type:"chest",message:"Ancient Chest",interact:"Press E to open"},{x:7,z:11,type:"crystal",message:"Magic Crystal",interact:"Press E to collect"},{x:14,z:14,type:"shrine",message:"Mysterious Shrine",interact:"Press E to pray"}].forEach(e=>{let t=this.terrainSystem.getTile(e.x,e.z);if(!t)return;let i=this.createInteractableObject(e.type,e.x,e.z);i&&(this.scene.add(i),this.interactables.push({mesh:i,x:e.x,z:e.z,type:e.type,message:e.message,interact:e.interact,inRange:!1}))}),setTimeout(()=>{this.npcs&&this.npcs.forEach(e=>{e.isInteractable&&this.interactables.push({mesh:e.sprite,x:e.pos.x,z:e.pos.z,type:"npc",message:e.name||"Friendly NPC",interact:"Press E to talk",inRange:!1,npcRef:e})})},500)}createInteractableObject(e,t,i){let s=this.terrainSystem.getTile(t,i);if(!s)return null;let a,n,o,r=.5+.5*s.height;switch(e){case"chest":a=new THREE.BoxGeometry(.3,.3,.3),n=new THREE.MeshLambertMaterial({color:9127187}),(o=new THREE.Mesh(a,n)).position.set(s.mesh.position.x,r+.3,s.mesh.position.z);break;case"crystal":a=new THREE.OctahedronGeometry(.4,0),n=new THREE.MeshLambertMaterial({color:65535,transparent:!0,opacity:.8,emissive:17476}),(o=new THREE.Mesh(a,n)).position.set(s.mesh.position.x,r+.4,s.mesh.position.z);break;case"shrine":let l=new THREE.CylinderGeometry(.6,.8,.3,8),h=new THREE.CylinderGeometry(.15,.15,1.2,8),c=new THREE.SphereGeometry(.25,8,6);o=new THREE.Group;let d=new THREE.Mesh(l,new THREE.MeshLambertMaterial({color:7372944})),p=new THREE.Mesh(h,new THREE.MeshLambertMaterial({color:7372944})),m=new THREE.Mesh(c,new THREE.MeshLambertMaterial({color:16766720,emissive:3351040}));d.position.y=.15,p.position.y=.9,m.position.y=1.65,o.add(d,p,m),o.position.set(s.mesh.position.x,r,s.mesh.position.z);break;default:return null}return o&&(o.castShadow=o.receiveShadow=!0,o.children&&o.children.forEach(e=>{e.castShadow=e.receiveShadow=!0})),o}checkProximityInteractions(){if(!this.player||!this.player.sprite)return;let e=null,t=1/0;this.interactables.forEach(i=>{if(!i.mesh)return;"npc"===i.type&&i.npcRef&&(i.x=i.npcRef.pos.x,i.z=i.npcRef.pos.z);let s=Math.sqrt(Math.pow(this.player.pos.x-i.x,2)+Math.pow(this.player.pos.z-i.z,2)),a=i.inRange;i.inRange=s<=this.proximityRadius,i.inRange&&!a?this.addGlowEffect(i.mesh):!i.inRange&&a&&this.removeGlowEffect(i.mesh),i.inRange&&s<t&&(t=s,e=i)}),this.updateTooltip(e)}addGlowEffect(e){if(e.userData||(e.userData={}),e.userData.glowAdded)return;let t=e=>{if(e.userData||(e.userData={}),e.material&&e.material.emissive){let t=e.material.emissive.clone();e.userData.originalEmissive=t,e.userData.glowAdded=!0;let i=0,s=a=>{if(e.userData.glowAdded){if(a-i>100){let n=(Math.sin(.003*a)+1)*.1;e.material.emissive.setRGB(t.r+n,t.g+n,t.b+n),i=a}requestAnimationFrame(s)}};s(performance.now())}};e.isGroup?e.children.forEach(t):t(e),e.userData.glowAdded=!0}removeGlowEffect(e){e.userData||(e.userData={});let t=e=>{e.userData||(e.userData={}),e.userData.glowAdded&&(e.userData.glowAdded=!1,e.material&&e.material.emissive&&e.userData.originalEmissive&&e.material.emissive.copy(e.userData.originalEmissive))};e.isGroup?e.children.forEach(t):t(e),e.userData.glowAdded=!1}updateTooltip(e){let t=document.getElementById("tooltipContainer");if(!e){this.hideTooltip();return}this.activeTooltip=e;let i=1.5>=this.getDistanceToInteractable(e),s=document.createElement("div");s.className=`tooltip interact visible ${i?"clickable":""}`,s.innerHTML=`<strong>${e.message}</strong><div class="interact-prompt">${i?"Click to interact":e.interact}</div>`;let a=t._clickHandler;if(a&&(t.removeEventListener("click",a),t.removeEventListener("mousedown",a)),i){s.style.cursor="pointer",t.style.pointerEvents="auto",t.style.zIndex="999";let n=e=>{if(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!this._isInteracting){if(this._isInteracting=!0,setTimeout(()=>this._isInteracting=!1,500),"npc"===this.activeTooltip.type&&this.activeTooltip.npcRef){let t=this.activeTooltip.npcRef.interact();t&&this.showInteractionMessage(t)}else this.executeInteraction(this.activeTooltip)}};t.addEventListener("click",n),t.addEventListener("mousedown",n),t.addEventListener("touchstart",e=>{if(e.preventDefault(),e.stopPropagation(),!this._isInteracting){if(this._isInteracting=!0,setTimeout(()=>this._isInteracting=!1,500),"npc"===this.activeTooltip.type&&this.activeTooltip.npcRef){let t=this.activeTooltip.npcRef.interact();t&&this.showInteractionMessage(t)}else this.executeInteraction(this.activeTooltip)}}),t._clickHandler=n}else t.style.pointerEvents="auto",s.style.cursor="default";t.innerHTML="",t.appendChild(s),this.positionTooltip(e)}positionTooltip(e){let t=document.getElementById("tooltipContainer"),i=new THREE.Vector3(e.mesh.position.x,e.mesh.position.y+1.5,e.mesh.position.z),s=i.project(this.camera),a=(s.x+1)/2*window.innerWidth,n=-(s.y-1)/2*window.innerHeight;t.style.left=`${a}px`,t.style.top=`${n}px`,t.style.transform="translate(-50%, -100%)"}hideTooltip(){if(!this.activeTooltip)return;this.activeTooltip=null;let e=document.getElementById("tooltipContainer"),t=e.querySelectorAll(".tooltip");t.forEach(e=>{e._clickHandler&&e.removeEventListener("click",e._clickHandler)}),e.innerHTML=""}getDistanceToInteractable(e){return this.player?Math.sqrt(Math.pow(this.player.pos.x-e.x,2)+Math.pow(this.player.pos.z-e.z,2)):1/0}handleInteraction(){if(!this.activeTooltip)return;let e=this.getDistanceToInteractable(this.activeTooltip);if(e>1.5)return;let t=this.activeTooltip;if("npc"===t.type&&t.npcRef){let i=t.npcRef.interact();i&&this.showInteractionMessage(i);return}this.executeInteraction(t)}executeInteraction(e){let t="";switch(e.type){case"npc":if(e.npcRef){(t=e.npcRef.interact())&&this.showInteractionMessage(t);return}t="The NPC nods at you silently.";break;case"chest":t="You found 50 gold coins!";break;case"crystal":t="The crystal glows brightly and fills you with energy!",this.scene.remove(e.mesh),this.interactables=this.interactables.filter(t=>t!==e),this.hideTooltip();break;case"shrine":t="You feel blessed by an ancient power..."}t&&this.showInteractionMessage(t)}showInteractionMessage(e){let t=document.getElementById("tooltipContainer");t&&(t.style.display="none");let i=document.createElement("div");if(i.style.cssText=`position: absolute;top: 20%;left: 50%;transform: translate(-50%, -50%);background: rgba(0, 0, 0, 0.9);color: white;padding: 16px 24px;border-radius: 8px;font-size: 14px;z-index: 200;animation: fadeInOut 3s ease forwards;`,i.textContent=e,!document.getElementById("interactionStyles")){let s=document.createElement("style");s.id="interactionStyles",s.textContent=`@keyframes fadeInOut {0% { opacity: 0; transform: translate(-50%, -50%) translateY(20px); }20%, 80% { opacity: 1; transform: translate(-50%, -50%) translateY(0); }100% { opacity: 0; transform: translate(-50%, -50%) translateY(-20px); }}`,document.head.appendChild(s)}document.body.appendChild(i),setTimeout(()=>{i.remove(),t&&(t.style.display="")},3e3)}showMessage(e){this.showInteractionMessage(e)}showConfirmationDialog(e,t){let i=document.getElementById("confirmationDialog");i&&i.remove();let s=document.createElement("div");s.id="confirmationDialog",s.style.cssText=`position: absolute;top: 50%;left: 50%;font-family:monospace!important;transform: translate(-50%, -50%);background: rgba(0, 0, 0, 0.95);color: white;padding: 20px;border-radius: 12px;border: 0px solid #4fc3f7;box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);z-index: 1000;min-width: 320px;text-align: center;font-family: Arial, sans-serif;`;let a=this.getConfirmationMessage(e),n=e.confirmationMessage&&e.confirmationAlternative,o;if(o=n?`<div style="display: flex; flex-direction: column; gap: 12px; margin-top: 16px;"><button id="choiceA" style="background: rgb(134 134 134);font-family:monospace;color: white;border: none;padding: 12px 16px;border-radius: 6px;cursor: pointer;font-size: 14px;transition: background 0.2s;text-align: left;line-height: 1.3;">${e.confirmationMessage}</button><button id="choiceB" style="background: rgb(134 134 134);color: white;font-family:monospace;border: none;padding: 12px 16px;border-radius: 6px;cursor: pointer;font-size: 14px;transition: background 0.2s;text-align: left;line-height: 1.3;">${e.confirmationAlternative}</button></div>`:`<div style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;"><button id="confirmYes" style="background: #43aa8b;color: white;border: none;padding: 10px 20px;border-radius: 6px;cursor: pointer;font-size: 14px;transition: background 0.2s;">Yes</button><button id="confirmNo" style="background: #f3722c;color: white;border: none;padding: 10px 20px;border-radius: 6px;cursor: pointer;font-size: 14px;transition: background 0.2s;">No</button></div>`,s.innerHTML=`<div style="font-size: 16px; margin-bottom: 16px; line-height: 1.4;"><strong style="max-width: 420px;width: 90%;display: block;margin: auto;">${e.message||e.name||"NPC"}</strong><div style="margin-top: 8px; font-size: 14px; opacity: 0.9;">${a}</div></div>${o}`,document.body.appendChild(s),n){let r=s.querySelector("#choiceA"),l=s.querySelector("#choiceB");r.onmouseover=()=>r.style.background="#4fc3f7",r.onmouseout=()=>r.style.background="#43aa8b",l.onmouseover=()=>l.style.background="#f9844a",l.onmouseout=()=>l.style.background="#f3722c",r.onclick=()=>{s.remove(),t(!0)},l.onclick=()=>{s.remove(),t(!1)}}else{let h=s.querySelector("#confirmYes"),c=s.querySelector("#confirmNo");h.onmouseover=()=>h.style.background="#4fc3f7",h.onmouseout=()=>h.style.background="#43aa8b",c.onmouseover=()=>c.style.background="#f9844a",c.onmouseout=()=>c.style.background="#f3722c",h.onclick=()=>{s.remove(),t(!0)},c.onclick=()=>{s.remove(),t(!1)}}let d=e=>{"Escape"===e.key&&(s.remove(),document.removeEventListener("keydown",d),t(!1))};document.addEventListener("keydown",d)}getConfirmationMessage(e){switch(e.type){case"npc_choice":return"";case"npc":return"Do you want to talk to this NPC? They might have useful information or quests.";case"npc_confirmation":return e.message;case"chest":return"Do you want to open this ancient chest? It might contain treasure... or traps.";case"tree":return"Do you want to examine this old tree? The whispers might reveal ancient secrets.";case"crystal":return"Do you want to collect this magical crystal? It will disappear forever.";case"shrine":return"Do you want to pray at this mysterious shrine? Ancient powers await.";default:return"Do you want to interact with this object?"}}}window.game=new GameEngine;</script><script>class TerrainSystem{constructor(e,t,i,r=!0){this.gridSize=e,this.tileSize=t,this.heightLevels=i,this.useSprites=r;let s=1,a=3.33;if(this.heightScales=Array.from({length:this.heightLevels},(e,t)=>s+t/(this.heightLevels-1)*(a-s)),this.terrainGroup=new THREE.Group,this.tiles=[],this.levelColors=[2588065,5227511,4434571,9485933,16369487,16352330,15954476,5731728],this.useSprites){let h=new THREE.TextureLoader;this.terrainTexture=h.load("https://i.imgur.com/qBGomXL.png"),this.terrainTexture.magFilter=THREE.NearestFilter,this.terrainTexture.minFilter=THREE.NearestFilter,this.spriteSize=96,this.layerHeight=96,this.totalLayers=3}}generateSeed(){let e="";for(let t=0;t<this.gridSize;t++)for(let i=0;i<this.gridSize;i++){let r=this.getTile(t,i);e+=r?r.height.toString(36):"0"}return e}loadFromSeed(e){if(e.length!==this.gridSize*this.gridSize)return!1;let t=0;for(let i=0;i<this.gridSize;i++)for(let r=0;r<this.gridSize;r++){let s=parseInt(e[t],36)||0,a=Math.max(0,Math.min(this.heightLevels-1,s));this.updateTileHeight(i,r,a),t++}return!0}generateTerrain(){for(let e=0;e<this.gridSize;e++){this.tiles[e]=[];for(let t=0;t<this.gridSize;t++){let i=this.generateHeightForPosition(e,t),r=this.createTile(e,t,i);r.castShadow=r.receiveShadow=!0,this.tiles[e][t]={height:i,mesh:r},this.terrainGroup.add(r)}}window.game&&window.game.debugSystem&&window.game.debugSystem.updateSeedDisplay()}generateHeightForPosition(e,t){let i=this.gridSize/2,r=this.gridSize/2,s=Math.floor((1-Math.sqrt((e-i)**2+(t-r)**2)/Math.sqrt(i**2+r**2))*this.heightLevels);return s+=Math.floor((Math.random()-.5)*3),Math.max(0,Math.min(this.heightLevels-1,s))}createTile(e,t,i){return this.useSprites?this.createSpriteTile(e,t,i):this.create3DTile(e,t,i)}create3DTile(e,t,i){let r=this.heightScales[i],s=new THREE.BoxGeometry(.9*this.tileSize,r,.9*this.tileSize),a=new THREE.MeshLambertMaterial({color:this.levelColors[i]}),h=new THREE.Mesh(s,a),l=(e-this.gridSize/2)*this.tileSize,o=(t-this.gridSize/2)*this.tileSize;return h.position.set(l,r/2+.05,o),h.userData={x:e,z:t,height:i},h}createSpriteTile(e,t,i){let r=new THREE.Group,s=.9*this.tileSize,a=this.heightScales[i],h=1/8,l=i*h,o=(e,t,i,r,s,a,o,n,d)=>{let g=new THREE.PlaneGeometry(e,t),u=new THREE.MeshLambertMaterial({map:this.terrainTexture,transparent:!0,side:THREE.DoubleSide}),p=g.attributes.uv,m=d/this.totalLayers;for(let S=0;S<p.count;S++)p.setX(S,p.getX(S)*h+l),p.setY(S,p.getY(S)*(1/this.totalLayers)+m);let $=new THREE.Mesh(g,u);return $.rotation.x=i,$.rotation.y=r,$.rotation.z=s,$.position.set(a,o,n),$},n=o(s,s,-Math.PI/2,0,0,0,a,0,2),d=o(s,a,0,0,0,0,a/2,s/2,0),g=o(s,a,0,Math.PI,0,0,a/2,-s/2,0),u=o(s,a,0,-Math.PI/2,0,-s/2,a/2,0,1),p=o(s,a,0,Math.PI/2,0,s/2,a/2,0,1);r.add(n,d,g,u,p);let m=(e-this.gridSize/2)*this.tileSize,S=(t-this.gridSize/2)*this.tileSize;r.position.set(m,0,S),r.userData={x:e,z:t,height:i};let $=new THREE.PlaneGeometry(s,s),c=new THREE.MeshBasicMaterial({transparent:!0,opacity:0,side:THREE.DoubleSide}),f=new THREE.Mesh($,c);return f.rotation.x=-Math.PI/2,f.position.y=a+.01,f.userData={x:e,z:t,height:i},f.material.depthWrite=!1,f.castShadow=!1,f.receiveShadow=!0,f.material.depthTest=!1,r.add(f),r}getTile(e,t){return this.tiles[e]?.[t]}updateTileHeight(e,t,i){let r=this.getTile(e,t);if(!r)return;this.terrainGroup.remove(r.mesh),r.mesh.isGroup?r.mesh.children.forEach(e=>{e.geometry?.dispose(),e.material?.dispose()}):(r.mesh.geometry?.dispose(),r.mesh.material?.dispose());let s=this.createTile(e,t,i);s.castShadow=s.receiveShadow=!0,s.children&&s.children.forEach(e=>{e.material.opacity,e.castShadow=!1,e.receiveShadow=!1}),r.height=i,r.mesh=s,this.terrainGroup.add(s),window.game&&window.game.debugSystem&&window.game.debugSystem.updateSeedDisplay()}clearTerrain(e=2){for(let t=0;t<this.gridSize;t++)for(let i=0;i<this.gridSize;i++)this.updateTileHeight(t,i,e)}}</script><script>class CameraSystem{constructor(e){this.game=e,this.cameraTarget=new THREE.Vector3,this.cameraOffset=new THREE.Vector3(10,10,10),this.zoomLevel=1,this.followTarget=null,this.initialCameraState={position:new THREE.Vector3,target:new THREE.Vector3,zoom:1,preset:"default"},this.cameraPresets={default:{type:"orthographic",offset:new THREE.Vector3(10,10,10),zoom:1,followPlayer:!1,lookAtTarget:!0},followPlayer:{type:"orthographic",offset:new THREE.Vector3(6,9,10),zoom:.9,followPlayer:!0,lookAtTarget:!0},overview:{type:"orthographic",offset:new THREE.Vector3(20,25,20),zoom:2,followPlayer:!1,lookAtTarget:!0,centerTarget:!0},thirdPerson:{type:"perspective",offset:new THREE.Vector3(3,10,3),fov:47,followPlayer:!0,lookAtPlayer:!0},followAndMove:{type:"orthographic",offset:new THREE.Vector3(6,9,10),zoom:.753,followPlayer:!0,lookAtTarget:!0},followAndMovePerspective:{type:"perspective",offset:new THREE.Vector3(3,8,3),fov:22,followPlayer:!0,lookAtPlayer:!0}},this.cameraTransition={active:!1,duration:2e3,startTime:0,fromPosition:new THREE.Vector3,toPosition:new THREE.Vector3,fromTarget:new THREE.Vector3,toTarget:new THREE.Vector3,fromZoom:1,toZoom:1,callback:null},this.currentCameraPreset="default",this._hue=void 0}setupCamera(){let e=window.innerWidth/window.innerHeight,t=20*this.zoomLevel;this.camera=new THREE.OrthographicCamera(-(t*e/2),t*e/2,t/2,-(t/2),-100,1e3),this.updateCameraPosition()}setCameraPreset(e,t=!0,a=null){t=!0,console.log(`CameraSystem: Setting camera preset to ${e}`);let i=document.getElementById("confirmationDialog");i&&(console.log("CameraSystem: Removing existing dialog"),i.remove());let r=document.getElementById("npcQuestionDialog");if(r&&(console.log("CameraSystem: Removing NPC dialog"),r.remove()),!this.cameraPresets[e]){console.warn(`Camera preset '${e}' not found`);return}let s=this.cameraPresets[e];this.currentCameraPreset=e,console.log(`CameraSystem: Applying preset ${e}`,s),s.type!==this.getCameraType()&&(console.log(`CameraSystem: Switching camera type to ${s.type}`),this.switchCameraType(s.type,s)),t&&this.camera?(console.log("CameraSystem: Starting smooth transition"),this.cameraTransition.active=!0,this.cameraTransition.startTime=Date.now(),this.cameraTransition.callback=a,this.cameraTransition.fromPosition.copy(this.camera.position),this.cameraTransition.fromTarget.copy(this.cameraTarget),this.cameraTransition.fromZoom=this.zoomLevel,this.calculateCameraTarget(s,this.cameraTransition.toTarget),this.cameraTransition.toPosition.copy(this.cameraTransition.toTarget).add(s.offset),this.cameraTransition.toZoom=s.zoom||1):(console.log("CameraSystem: Applying preset immediately"),this.applyCameraPreset(s),a&&a())}getCameraType(){return this.camera.isOrthographicCamera?"orthographic":"perspective"}switchCameraType(e,t){let a=this.camera.position.clone(),i=window.innerWidth/window.innerHeight;if("perspective"===e&&this.camera.isOrthographicCamera)this.camera=new THREE.PerspectiveCamera(t.fov||60,i,.1,1e3);else if("orthographic"===e&&this.camera.isPerspectiveCamera){let r=20*(t.zoom||1);this.camera=new THREE.OrthographicCamera(-(r*i/2),r*i/2,r/2,-(r/2),-100,1e3)}this.camera.position.copy(a),this.game.camera=this.camera}calculateCameraTarget(e,t){e.followPlayer&&this.game.player&&this.game.player.sprite?(t.copy(this.game.player.sprite.position),t.y=0,"followPlayer"===this.currentCameraPreset&&(t.x+=-5,t.z+=-5)):e.centerTarget?t.set(0,0,0):t.copy(this.cameraTarget)}applyCameraPreset(e){if(this.calculateCameraTarget(e,this.cameraTarget),"perspective"===e.type){if(e.followPlayer&&this.game.player&&this.game.player.sprite){if(this.camera.position.copy(this.game.player.sprite.position).add(e.offset),e.lookAtPlayer)this.camera.lookAt(this.game.player.sprite.position);else if(e.lookDirection){let t=this.game.player.sprite.position.clone().add(e.lookDirection.clone().multiplyScalar(100));this.camera.lookAt(t)}}}else{this.zoomLevel=e.zoom||1,this.cameraOffset.copy(e.offset),this.updateCameraPosition();let a=window.innerWidth/window.innerHeight,i=20*this.zoomLevel;this.camera.left=-(i*a/2),this.camera.right=i*a/2,this.camera.top=i/2,this.camera.bottom=-(i/2),this.camera.updateProjectionMatrix()}}panCamera(e,t){let a=.01*this.zoomLevel,i=new THREE.Vector3(1,0,-1).normalize(),r=new THREE.Vector3(1,0,1).normalize();this.cameraTarget.add(i.clone().multiplyScalar(-e*a)),this.cameraTarget.add(r.clone().multiplyScalar(-t*a));let s=this.game.gridSize*this.game.tileSize/2;this.cameraTarget.x=Math.max(-s,Math.min(s,this.cameraTarget.x)),this.cameraTarget.z=Math.max(-s,Math.min(s,this.cameraTarget.z))}zoomCamera(e){this.zoomLevel=Math.max(.3,Math.min(3,this.zoomLevel+e));let t=window.innerWidth/window.innerHeight,a=20*this.zoomLevel;Object.assign(this.camera,{left:-(a*t/2),right:a*t/2,top:a/2,bottom:-(a/2)}),this.camera.updateProjectionMatrix()}updateCameraPosition(){this.camera.position.copy(this.cameraTarget.clone().add(this.cameraOffset)),this.camera.lookAt(this.cameraTarget)}handleKeyboardCameraInput(){let e=this.game.input.keys,t=new THREE.Vector3;(e.KeyW||e.ArrowUp)&&t.add(new THREE.Vector3(-1,0,-1)),(e.KeyS||e.ArrowDown)&&t.add(new THREE.Vector3(1,0,1)),(e.KeyA||e.ArrowLeft)&&t.add(new THREE.Vector3(-1,0,1)),(e.KeyD||e.ArrowRight)&&t.add(new THREE.Vector3(1,0,-1)),this.game.input.keys.Digit1&&!this.game.input.keys._1Pressed?(this.game.input.keys._1Pressed=!0,this.setCameraPreset("default",!0),this.game.showInteractionMessage("Camera: Default View")):this.game.input.keys.Digit1||(this.game.input.keys._1Pressed=!1),this.game.input.keys.Digit2&&!this.game.input.keys._2Pressed?(this.game.input.keys._2Pressed=!0,this.setCameraPreset("followPlayer",!0),this.game.showInteractionMessage("Camera: Follow Player")):this.game.input.keys.Digit2||(this.game.input.keys._2Pressed=!1),this.game.input.keys.Digit3&&!this.game.input.keys._3Pressed?(this.game.input.keys._3Pressed=!0,this.setCameraPreset("overview",!0),this.game.showInteractionMessage("Camera: Overview")):this.game.input.keys.Digit3||(this.game.input.keys._3Pressed=!1),this.game.input.keys.Digit4&&!this.game.input.keys._4Pressed?(this.game.input.keys._4Pressed=!0,this.setCameraPreset("thirdPerson",!0),this.game.showInteractionMessage("Camera: Third Person")):this.game.input.keys.Digit4||(this.game.input.keys._4Pressed=!1),this.game.input.keys.Digit5&&!this.game.input.keys._5Pressed?(this.game.input.keys._5Pressed=!0,this.setCameraPreset("firstPerson",!0),this.game.showInteractionMessage("Camera: First Person")):this.game.input.keys.Digit5||(this.game.input.keys._5Pressed=!1),this.game.input.keys.KeyI&&(this.game.directionalLight.intensity=Math.min(2,this.game.directionalLight.intensity+.01)),this.game.input.keys.KeyK&&(this.game.directionalLight.intensity=Math.max(0,this.game.directionalLight.intensity-.01)),this.game.input.keys.KeyJ&&(this._hue=(this._hue||0)+1,this.game.directionalLight.color.setHSL(this._hue%360/360,1,.9)),this.game.input.keys.KeyL&&(this._hue=(this._hue||0)-1,this.game.directionalLight.color.setHSL(this._hue%360/360,1,.9)),this.game.input.keys.KeyU&&(this.game.directionalLight.color.set(16774880),this._hue=void 0),t.lengthSq()>0&&(t.normalize().multiplyScalar(.3),this.cameraTarget.add(t)),e.KeyQ&&this.zoomCamera(.02),e.KeyE&&this.zoomCamera(-.02);let a=this.game.gridSize*this.game.tileSize/2;this.cameraTarget.clamp(new THREE.Vector3(-a,0,-a),new THREE.Vector3(a,0,a))}updateCameraTransition(){if(this.cameraTransition&&this.cameraTransition.active){let e=Date.now()-this.cameraTransition.startTime,t=Math.min(e/this.cameraTransition.duration,1),a=1-Math.pow(1-t,3);if(this.camera.position.lerpVectors(this.cameraTransition.fromPosition,this.cameraTransition.toPosition,a),this.cameraTarget.lerpVectors(this.cameraTransition.fromTarget,this.cameraTransition.toTarget,a),this.camera.isOrthographicCamera){this.zoomLevel=THREE.MathUtils.lerp(this.cameraTransition.fromZoom,this.cameraTransition.toZoom,a);let i=window.innerWidth/window.innerHeight,r=20*this.zoomLevel;this.camera.left=-(r*i/2),this.camera.right=r*i/2,this.camera.top=r/2,this.camera.bottom=-(r/2),this.camera.updateProjectionMatrix()}t>=1&&(console.log("CameraSystem: Transition completed"),this.cameraTransition.active=!1,this.cameraTransition.callback&&this.cameraTransition.callback())}}updateFollowPlayer(){let e=this.cameraPresets?.[this.currentCameraPreset];if(e&&e.followPlayer){let t=this.followTarget||this.game.player;if(t&&t.sprite&&!this.cameraTransition.active){if("perspective"===e.type){if(this.camera.position.copy(t.sprite.position).add(e.offset),e.lookAtPlayer)this.camera.lookAt(t.sprite.position);else if(e.lookDirection){let a=new THREE.Vector3(0,0,-1);if(t.path&&t.path.length>0){let i=t.path[0],r=i.x-t.pos.x,s=i.z-t.pos.z;(0!==r||0!==s)&&a.set(r,0,s).normalize()}else void 0!==t.facingLeft&&a.set(t.facingLeft?-1:1,0,0);let o=t.sprite.position.clone().add(a.multiplyScalar(50));this.camera.lookAt(o)}}else this.cameraTarget.copy(t.sprite.position),this.cameraTarget.y=0,"followPlayer"===this.currentCameraPreset&&(this.cameraTarget.x+=-5,this.cameraTarget.z+=-5)}}}setFollowTarget(e){this.followTarget=e}saveInitialCameraState(){this.camera&&(this.initialCameraState.position.copy(this.camera.position),this.initialCameraState.target.copy(this.cameraTarget),this.initialCameraState.zoom=this.zoomLevel,this.initialCameraState.preset=this.currentCameraPreset,console.log("Initial camera state saved:",this.initialCameraState))}restoreToInitialState(e=!0,t=null){console.log("Restoring to initial camera state");let a=!1;if(this.followTarget&&this.followTarget.sprite){let i=this.followTarget.sprite.position,r=i.distanceTo(this.initialCameraState.position);r>5&&(a=!0)}if("followPlayer"===this.initialCameraState.preset||"followAndMove"===this.initialCameraState.preset||a){console.log("Restoring to follow player instead of exact initial state"),this.setCameraPreset("followPlayer",e,t);return}if(e&&this.camera)this.cameraTransition.active=!0,this.cameraTransition.startTime=Date.now(),this.cameraTransition.callback=t,this.cameraTransition.fromPosition.copy(this.camera.position),this.cameraTransition.fromTarget.copy(this.cameraTarget),this.cameraTransition.fromZoom=this.zoomLevel,this.cameraTransition.toPosition.copy(this.initialCameraState.position),this.cameraTransition.toTarget.copy(this.initialCameraState.target),this.cameraTransition.toZoom=this.initialCameraState.zoom,this.currentCameraPreset=this.initialCameraState.preset;else{if(this.camera.position.copy(this.initialCameraState.position),this.cameraTarget.copy(this.initialCameraState.target),this.zoomLevel=this.initialCameraState.zoom,this.currentCameraPreset=this.initialCameraState.preset,this.updateCameraPosition(),this.camera.isOrthographicCamera){let s=window.innerWidth/window.innerHeight,o=20*this.zoomLevel;this.camera.left=-(o*s/2),this.camera.right=o*s/2,this.camera.top=o/2,this.camera.bottom=-(o/2),this.camera.updateProjectionMatrix()}t&&t()}}clearFollowTarget(){this.followTarget=null}handleResize(){let e=window.innerWidth/window.innerHeight,t=20*this.zoomLevel;Object.assign(this.camera,{left:-(t*e/2),right:t*e/2,top:t/2,bottom:-(t/2)}),this.camera.updateProjectionMatrix()}update(){this.updateCameraTransition(),this.updateFollowPlayer(),this.updateCameraPosition()}}
</script>
</body>
</html>